<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Primary Meta Tags -->
	<meta name="title" content="AI Song Lyric Composer - Professional Songwriting Tool">
	<meta name="description" content="Create song lyrics with AI! Generate personalized songs in any genre with optional vocal demos. Perfect for songwriters, musicians, and creators.">

	<!-- Open Graph / Facebook -->
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://www.ai-ministries.com/apps/composer.html">
	<meta property="og:title" content="AI Song Lyric Composer - Professional Songwriting Tool">
	<meta property="og:description" content="Create song lyrics with AI! Generate personalized songs in any genre with optional vocal demos. Perfect for songwriters, musicians, and creators.">
	<meta property="og:image" content="https://www.ai-ministries.com/apps/composer.jpg">
	<meta property="og:image:secure_url" content="https://www.ai-ministries.com/apps/composer.jpg">
	<meta property="og:image:type" content="image/jpeg">
	<meta property="og:image:width" content="1200">
	<meta property="og:image:height" content="630">
	<meta property="og:image:alt" content="AI Song Lyric Composer - Professional Songwriting Tool">

	<!-- Twitter -->
	<meta property="twitter:card" content="summary_large_image">
	<meta property="twitter:url" content="https://www.ai-ministries.com/apps/composer.html">
	<meta property="twitter:title" content="AI Song Lyric Composer - Professional Songwriting Tool">
	<meta property="twitter:description" content="Create song lyrics with AI! Generate personalized songs in any genre with optional vocal demos. Perfect for songwriters, musicians, and creators.">
	<meta property="twitter:image" content="https://www.ai-ministries.com/apps/composer.jpg">

	<!-- Additional SEO Meta Tags -->
	<meta name="keywords" content="song lyrics, AI songwriter, music composer, lyric generator, songwriting tool, music creation, professional lyrics">
	<meta name="author" content="AI Ministries">
	<meta name="robots" content="index, follow">
	<meta name="language" content="English">

	<title>AI Song Lyric Composer - Professional Songwriting Tool 🎵✨</title>
	<script src="https://www.ai-ministries.com/js/nav-loader.js"></script>
	
    <style>
        /* Navigation spacing */
        body {
            padding-top: 80px !important;
        }
        
        html {
            scroll-padding-top: 80px;
        }
        
        #navigation-container {
            position: relative;
            z-index: 10000;
        }
	
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            color: #2d3748;
            overflow-x: hidden;
        }

		.disclaimer-footer {
			text-align: center;
			padding: 1rem 2rem;
			margin-top: 3rem;
			font-size: 0.75rem;
			color: #e2e8f0;
			line-height: 1.4;
			max-width: 800px;
			margin-left: auto;
			margin-right: auto;
		}

		.disclaimer-footer p {
			margin: 0;
		}

        /* Animated background elements */
        .bg-decoration {
            position: fixed;
            pointer-events: none;
            z-index: 0;
        }

        .music-note {
            color: #ffd700;
            animation: musicFloat 3s infinite ease-in-out;
        }

        .vinyl {
            color: rgba(255, 255, 255, 0.6);
            animation: vinylSpin 8s infinite linear;
        }

		.artwork-container {
			position: relative;
			display: inline-block;
			margin: 1rem auto;
		}

		.refresh-artwork-btn {
			position: absolute;
			top: 10px;
			right: 10px;
			background: rgba(255, 255, 255, 0.9);
			border: 2px solid #667eea;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			transition: all 0.3s ease;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
		}

		.refresh-artwork-btn:hover {
			background: #667eea;
			color: white;
			transform: rotate(180deg);
		}

		.editable-lyrics {
			background: linear-gradient(135deg, #f8f9fa, #e9ecef);
			border: 2px solid #dee2e6;
			border-radius: 15px;
			padding: 2rem;
			margin: 1rem 0;
			line-height: 1.8;
			font-size: 1.1rem;
			color: #2d3748;
			min-height: 300px;
			position: relative;
			font-family: 'Georgia', serif;
			white-space: pre-line;
			resize: vertical;
			width: 100%;
			box-sizing: border-box;
		}

		.lyrics-edit-controls {
			display: flex;
			gap: 1rem;
			justify-content: center;
			margin-top: 1rem;
		}

        @keyframes musicFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-15px) rotate(10deg); opacity: 1; }
        }

        @keyframes vinylSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .subtitle {
            font-size: 1.3rem;
            color: #2d3748;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 2rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @supports not (-webkit-background-clip: text) {
            h1 {
                color: #553c9a !important;
                background: none !important;
            }
        }

        .lyric-creation-section,
        .lyric-display-section,
        .song-library {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border: 3px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
        }

        .lyric-creation-section::before,
        .lyric-display-section::before,
        .song-library::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            background-size: 300% 300%;
            animation: gradientShift 4s ease infinite;
            border-radius: 20px;
            z-index: -1;
        }

        .section-title {
            font-size: 2rem;
            color: #2d3748;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        label {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        input, select, textarea {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .genre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .genre-button {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .genre-button:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .genre-button.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .magic-button {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 1.25rem 2.5rem;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .magic-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .magic-button:active {
            transform: translateY(-1px);
        }

        .magic-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .lyrics-display {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            line-height: 1.8;
            font-size: 1.1rem;
            color: #2d3748;
            min-height: 300px;
            position: relative;
            font-family: 'Georgia', serif;
            white-space: pre-line;
        }

        .song-artwork {
            width: 100%;
            max-width: 400px;
            height: 400px;
            object-fit: cover;
            border-radius: 15px;
            border: 3px solid #667eea;
            margin: 1rem auto;
            display: block;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .audio-player-section {
            background: linear-gradient(135deg, #e6f3ff, #f0e6ff);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin: 1rem 0;
        }

        .audio-player-section audio {
            width: 100%;
            margin: 1rem 0;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .control-button {
            background: linear-gradient(45deg, #48dbfb, #0abde3);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .control-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            text-align: center;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-success { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .status-info { background: #bee3f8; color: #2a4365; }

        .song-card {
            background: linear-gradient(135deg, #fff, #f7fafc);
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .song-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .song-card.favorited {
            border-color: #ffd700;
            background: linear-gradient(135deg, #fffbf0, #fff5e6);
        }

        .song-title {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .song-preview {
            color: #4a5568;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-style: italic;
        }

        .song-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 1rem;
        }

        .song-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .mini-button {
            background: transparent;
            border: 2px solid #cbd5e0;
            border-radius: 25px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .mini-button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .mini-button.favorite {
            background: #ffd700;
            color: #2d3748;
            border-color: #ffd700;
        }

        .mini-button.favorite:hover {
            background: #ffed4e;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            h1 { font-size: 2.5rem; }
            .controls { flex-direction: column; }
            .control-button, .magic-button { width: 100%; justify-content: center; }
            .genre-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }

        .hidden { display: none; }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Animated background decorations -->
    <div class="bg-decoration music-note" style="top: 10%; left: 10%; font-size: 2rem;">🎵</div>
    <div class="bg-decoration music-note" style="top: 20%; right: 15%; font-size: 1.5rem;">🎶</div>
    <div class="bg-decoration music-note" style="top: 60%; left: 8%; font-size: 1.8rem;">🎼</div>
    <div class="bg-decoration vinyl" style="top: 15%; left: 70%; font-size: 3rem;">💿</div>
    <div class="bg-decoration vinyl" style="top: 50%; right: 20%; font-size: 2rem;">📀</div>
    <div class="bg-decoration music-note" style="top: 80%; left: 20%; font-size: 1.5rem;">🎤</div>
    <div class="bg-decoration music-note" style="top: 30%; right: 10%; font-size: 1.2rem;">🎸</div>

    <div class="container">
        <div class="header">
            <h1>🎵 AI Song Lyric Composer 🎤</h1>
            <div class="subtitle">Create professional song lyrics with AI magic! 🎼✨</div>
        </div>

        <!-- Lyric Creation Section -->
        <div class="lyric-creation-section">
            <h2 class="section-title">🎨 Compose Your Song</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="song-title">Song Title 🎵</label>
                    <input type="text" id="song-title" placeholder="e.g., Dancing in the Rain, Lost Highway" />
                </div>
                <div class="form-group">
                    <label for="song-artist">Artist Style (Optional) 🎤</label>
                    <input type="text" id="song-artist" placeholder="e.g., Taylor Swift, The Beatles, Drake" />
                </div>
                <div class="form-group">
                    <label for="song-theme">Song Theme/Topic 💭</label>
                    <input type="text" id="song-theme" placeholder="e.g., love, heartbreak, freedom, adventure" />
                </div>
                <div class="form-group">
                    <label for="song-mood">Mood/Emotion 😊</label>
                    <select id="song-mood">
                        <option value="upbeat">Upbeat & Energetic</option>
                        <option value="romantic">Romantic & Sweet</option>
                        <option value="melancholy">Melancholy & Sad</option>
                        <option value="empowering">Empowering & Strong</option>
                        <option value="nostalgic">Nostalgic & Wistful</option>
                        <option value="rebellious">Rebellious & Edgy</option>
                        <option value="peaceful">Peaceful & Calm</option>
                        <option value="party">Party & Fun</option>
                        <option value="introspective">Introspective & Deep</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Genre 🎼</label>
                <div class="genre-grid">
                    <div class="genre-button" data-genre="pop">🎤 Pop</div>
                    <div class="genre-button" data-genre="rock">🎸 Rock</div>
                    <div class="genre-button" data-genre="hiphop">🎤 Hip-Hop</div>
                    <div class="genre-button" data-genre="country">🤠 Country</div>
                    <div class="genre-button" data-genre="folk">🎻 Folk</div>
                    <div class="genre-button" data-genre="jazz">🎷 Jazz</div>
                    <div class="genre-button" data-genre="blues">🎺 Blues</div>
                    <div class="genre-button" data-genre="electronic">🎹 Electronic</div>
                    <div class="genre-button" data-genre="r&b">💫 R&B</div>
                    <div class="genre-button" data-genre="indie">🌙 Indie</div>
                    <div class="genre-button" data-genre="metal">⚡ Metal</div>
                    <div class="genre-button" data-genre="reggae">🌴 Reggae</div>
                </div>
                <input type="text" id="custom-genre" placeholder="Or type your own genre..." style="margin-top: 1rem;" />
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="song-structure">Song Structure 🏗️</label>
                    <select id="song-structure">
                        <option value="verse-chorus">Verse-Chorus (Classic)</option>
                        <option value="verse-chorus-bridge">Verse-Chorus-Bridge</option>
                        <option value="aaba">AABA (32-bar)</option>
                        <option value="verse-prechorus-chorus">Verse-PreChorus-Chorus</option>
                        <option value="ballad">Ballad Structure</option>
                        <option value="freestyle">Freestyle/Experimental</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="voice-type">Vocal Demo Voice 🎭</label>
                    <select id="voice-type">
                        <option value="nova">Nova (Clear & Neutral)</option>
                        <option value="alloy">Alloy (Warm & Balanced)</option>
                        <option value="echo">Echo (Deep & Rich)</option>
                        <option value="shimmer">Shimmer (Bright & Upbeat)</option>
                        <option value="fable">Fable (Storytelling)</option>
                        <option value="onyx">Onyx (Strong & Bold)</option>
                    </select>
                </div>
            </div>

            <div class="form-group full-width">
                <label for="custom-instructions">Additional Instructions (Optional) 💡</label>
                <textarea id="custom-instructions" rows="3" placeholder="Any specific requests? Key phrases to include? Rhyme scheme preferences? Story elements?"></textarea>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="magic-button" id="generate-lyrics-btn">
                    ✨ Create My Song Lyrics! ✨
                </button>
            </div>
        </div>

        <!-- Generated Lyrics Display -->
        <div class="lyric-display-section hidden" id="lyrics-section">
            <h2 class="section-title">🎼 Your Song</h2>
            
            <!-- Album artwork placeholder -->
            <div id="song-artwork-container" class="hidden">
                <img id="song-artwork" class="song-artwork" alt="Song artwork" />
            </div>
            
            <!-- Lyrics display -->
            <div class="lyrics-display" id="lyrics-display">
                Your song lyrics will appear here...
            </div>
            
            <!-- Audio player -->
            <div class="audio-player-section" id="audio-container" style="display: none;">
                <h3 style="color: #2d3748; margin-bottom: 1rem;">🎵 Vocal Demo</h3>
                <audio id="audio-player" controls></audio>
                <button class="mini-button" id="download-audio-btn" style="margin-top: 1rem;">
                    💾 Download Demo
                </button>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <button class="control-button" id="regenerate-lyrics-btn">🔄 New Version</button>
                <button class="control-button" id="favorite-song-btn">⭐ Add to Favorites</button>
                <button class="control-button" id="copy-lyrics-btn">📋 Copy Lyrics</button>
            </div>
        </div>

        <!-- Song Library -->
        <div class="song-library">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 class="section-title">🎵 Your Song Library (Max 10 songs)</h2>
                <button class="mini-button" id="clear-library-btn">🗑️ Clear All</button>
            </div>
            <div id="song-library-list">
                <div style="text-align: center; color: #718096; font-style: italic; padding: 3rem;">
                    No songs created yet. Start composing your first masterpiece above! 🎼
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-message" class="status-message hidden"></div>
    </div>

    <script>
        // Constants
        const TEXT_API = 'https://text.pollinations.ai/';
        const IMAGE_API = 'https://image.pollinations.ai/prompt/';
        const AUDIO_API = 'https://text.pollinations.ai/';
        
        // DOM Elements
        const generateLyricsBtn = document.getElementById('generate-lyrics-btn');
        const regenerateLyricsBtn = document.getElementById('regenerate-lyrics-btn');
        const favoriteSongBtn = document.getElementById('favorite-song-btn');
        const copyLyricsBtn = document.getElementById('copy-lyrics-btn');
        const downloadAudioBtn = document.getElementById('download-audio-btn');
        const clearLibraryBtn = document.getElementById('clear-library-btn');
        
        const lyricsSection = document.getElementById('lyrics-section');
        const lyricsDisplay = document.getElementById('lyrics-display');
        const songArtworkContainer = document.getElementById('song-artwork-container');
        const songArtwork = document.getElementById('song-artwork');
        const audioContainer = document.getElementById('audio-container');
        const audioPlayer = document.getElementById('audio-player');
        const statusMessage = document.getElementById('status-message');
        const songLibraryList = document.getElementById('song-library-list');
        
        // State
        let currentSong = null;
        let currentAudioUrl = null;
        let songLibrary = [];
        let selectedGenre = 'pop';
        let db;

        // Initialize
        initDB().then(() => {
            loadLibrary();
        }).catch(err => {
            console.error('DB initialization failed:', err);
        });

        // Event Listeners
        generateLyricsBtn.addEventListener('click', generateCompleteSong);
        regenerateLyricsBtn.addEventListener('click', generateCompleteSong);
        favoriteSongBtn.addEventListener('click', toggleFavorite);
        copyLyricsBtn.addEventListener('click', copyLyrics);
        downloadAudioBtn.addEventListener('click', downloadAudio);
        clearLibraryBtn.addEventListener('click', clearLibrary);

        // Genre selection
        document.querySelectorAll('.genre-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.genre-button').forEach(b => b.classList.remove('selected'));
                button.classList.add('selected');
                selectedGenre = button.dataset.genre;
                document.getElementById('custom-genre').value = '';
            });
        });

        // Set default genre selection
        document.querySelector('[data-genre="pop"]').classList.add('selected');

        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('songComposerDB', 2);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('songs')) {
                        const store = db.createObjectStore('songs', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('favorited', 'favorited', { unique: false });
                    }
                };
            });
        }

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => statusMessage.classList.add('hidden'), 5000);
        }

        // Build lyrics generation prompt
		function buildLyricsPrompt() {
			const title = document.getElementById('song-title').value.trim();
			const artist = document.getElementById('song-artist').value.trim();
			const theme = document.getElementById('song-theme').value.trim();
			const mood = document.getElementById('song-mood').value;
			const structure = document.getElementById('song-structure').value;
			const customGenre = document.getElementById('custom-genre').value.trim();
			const customInstructions = document.getElementById('custom-instructions').value.trim();
			
			const genre = customGenre || selectedGenre;
			
			const moodDescriptions = {
				upbeat: 'upbeat and energetic',
				romantic: 'romantic and sweet',
				melancholy: 'melancholy and emotional',
				empowering: 'empowering and motivational',
				nostalgic: 'nostalgic and reflective',
				rebellious: 'rebellious and edgy',
				peaceful: 'peaceful and calming',
				party: 'fun and party-oriented',
				introspective: 'introspective and thoughtful'
			};
			
			const structureDescriptions = {
				'verse-chorus': 'verse-chorus structure with 2-3 verses and a memorable chorus',
				'verse-chorus-bridge': 'verse-chorus-bridge structure with 2 verses, chorus, and a bridge section',
				'aaba': 'AABA structure (32-bar form)',
				'verse-prechorus-chorus': 'verse-prechorus-chorus structure for building tension',
				'ballad': 'ballad structure with emotional storytelling',
				'freestyle': 'creative/experimental structure'
			};
			
			let prompt = `WRITE ONLY RAW SONG LYRICS WITH NO LABELS, NO SECTION HEADERS, NO COMMENTARY, NO EXPLANATIONS. Generate complete professional song lyrics in the ${genre} genre. `;
			
			if (title) prompt += `The song title is "${title}". `;
			if (artist) prompt += `Write in the style of ${artist}. `;
			if (theme) prompt += `The song theme/topic is: ${theme}. `;
			
			prompt += `The mood should be ${moodDescriptions[mood]}. `;
			prompt += `Use a ${structureDescriptions[structure]}. `;
			
			if (customInstructions) prompt += `Additional requirements: ${customInstructions}. `;
			
			prompt += `CRITICAL: Output ONLY the complete song lyrics as plain text. NO [Verse], NO [Chorus], NO **Title**, NO formatting, NO labels, NO section markers, NO commentary. Just the raw lyrical content that can be sung from start to finish.`;
			
			return prompt;
		}

        // Build artwork prompt
        function buildArtworkPrompt() {
            const title = document.getElementById('song-title').value.trim();
            const theme = document.getElementById('song-theme').value.trim();
            const mood = document.getElementById('song-mood').value;
            const customGenre = document.getElementById('custom-genre').value.trim();
            const genre = customGenre || selectedGenre;
            
            let artworkPrompt = `album cover art, music artwork, ${genre} genre, ${mood} mood, professional design, high quality, detailed, artistic`;
            
            if (title) artworkPrompt += `, ${title}`;
            if (theme) artworkPrompt += `, ${theme} theme`;
            
            artworkPrompt += `, vibrant colors, modern design, music industry style`;
            
            return artworkPrompt;
        }

		// Generate complete song
		async function generateCompleteSong() {
			const title = document.getElementById('song-title').value.trim();
			const theme = document.getElementById('song-theme').value.trim();
			
			if (!title && !theme) {
				showStatus('Please provide at least a song title or theme! 🎵', 'error');
				return;
			}
			
			setLoading(generateLyricsBtn, true, 'Composing your song...');
			lyricsSection.classList.add('hidden');
			
			let songData = {
				title: title || 'Untitled',
				artist: document.getElementById('song-artist').value.trim() || 'Unknown',
				theme: theme || 'Unknown',
				mood: document.getElementById('song-mood').value,
				genre: document.getElementById('custom-genre').value.trim() || selectedGenre,
				structure: document.getElementById('song-structure').value,
				voice: document.getElementById('voice-type').value,
				timestamp: new Date().toISOString(),
				favorited: false
			};
			try {
				// Step 1: Generate lyrics - MUST succeed first
				showStatus('Writing your song lyrics... ✍️', 'info');
				const lyrics = await generateLyrics();
				if (!lyrics || lyrics.length < 50) {
					throw new Error('Generated lyrics are too short or empty');
				}
				songData.lyrics = lyrics;
				
				// Display lyrics immediately after successful generation
				displayLyrics(lyrics);
				
				// Step 2: Generate artwork (non-blocking) - STORE AS BASE64 IN DB
				showStatus('Creating album artwork... 🎨', 'info');
				generateArtwork()
					.then(async artworkUrl => {
						// Download and convert to base64 for permanent storage
						const response = await fetch(artworkUrl);
						const blob = await response.blob();
						const reader = new FileReader();
						reader.onloadend = () => {
							const base64data = reader.result;
							songData.artworkUrl = base64data; // Store as base64
							showArtwork(base64data);
						};
						reader.readAsDataURL(blob);
					})
					.catch(error => {
						console.error('Artwork generation failed:', error);
						showStatus('Lyrics created! Artwork generation failed, but continuing... 🎨', 'info');
					});
				
				// Step 3: Generate vocal demo (non-blocking) - STORE AS BASE64 IN DB
				showStatus('Recording vocal demo... 🎤', 'info');
				showAudioPlaceholder();
				generateVocalDemo(lyrics, songData.voice)
					.then(async audioUrl => {
						if (audioUrl) {
							// Download and convert to base64 for permanent storage
							const response = await fetch(audioUrl);
							const blob = await response.blob();
							const reader = new FileReader();
							reader.onloadend = () => {
								const base64data = reader.result;
								songData.audioUrl = base64data; // Store as base64
								currentAudioUrl = base64data;
								showAudio(base64data);
								showStatus('Vocal demo complete! 🎤', 'success');
							};
							reader.readAsDataURL(blob);
						} else {
							throw new Error('Audio URL is empty');
						}
					})
					.catch(error => {
						console.error('Audio generation failed:', error);
						songData.audioUrl = null;
						showAudioError();
						showStatus('Song created! Vocal demo generation failed - you can try regenerating later... 🎤', 'info');
					});
				
				currentSong = songData;
				
				// Update favorite button for new song
				favoriteSongBtn.innerHTML = '⭐ Add to Favorites';
				
				// Save to library immediately with what we have
				await saveToLibrary(songData);
				
				showStatus('Your song lyrics are ready! Artwork and vocal demo are being generated... ✨🎼', 'success');
				
			} catch (error) {
				console.error('Song generation failed:', error);
				showStatus(`Song creation failed: ${error.message}. Please try again! 🎵`, 'error');
			} finally {
				setLoading(generateLyricsBtn, false);
			}
		}

        // Generate lyrics
        async function generateLyrics() {
            const prompt = buildLyricsPrompt();
            const encodedPrompt = encodeURIComponent(prompt);
			const randomSeed = Math.floor(Math.random() * 1000000);
			const lyricsUrl = `${TEXT_API}${encodedPrompt}?model=openai&seed=${randomSeed}&referrer=songcomposer`;
            
            const response = await fetch(lyricsUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/plain',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const lyrics = await response.text();
            
            if (!lyrics || lyrics.length < 50) {
                throw new Error('Lyrics too short or empty');
            }
            
            return lyrics;
        }

        // Generate artwork
		async function generateArtwork() {
			const artworkPrompt = buildArtworkPrompt();
			const encodedPrompt = encodeURIComponent(artworkPrompt);
			const randomSeed = Math.floor(Math.random() * 1000000);
			const artworkUrl = `${IMAGE_API}${encodedPrompt}?width=512&height=512&model=flux&enhance=true&nologo=true&seed=${randomSeed}&referrer=songcomposer`;
			
			// Download and convert to blob URL for local storage
			const response = await fetch(artworkUrl);
			if (!response.ok) throw new Error('Artwork generation failed');
			
			const blob = await response.blob();
			const localUrl = URL.createObjectURL(blob);
			
			return localUrl;
		}

        // Generate vocal demo
		async function generateVocalDemo(lyrics, voice) {
			// Only remove the labels/markers, keep ALL the actual lyric lines
			const cleanLyrics = lyrics
				.replace(/\*\*.*?\*\*/g, '') // Remove **Title**
				.replace(/\*Verse.*?\*/gi, '') // Remove *Verse 1*
				.replace(/\*Chorus.*?\*/gi, '') // Remove *Chorus*
				.replace(/\*Bridge.*?\*/gi, '') // Remove *Bridge*
				.replace(/\*Intro.*?\*/gi, '') // Remove *Intro*
				.replace(/\*Outro.*?\*/gi, '') // Remove *Outro*
				.replace(/\*Pre-Chorus.*?\*/gi, '') // Remove *Pre-Chorus*
				.replace(/\*Hook.*?\*/gi, '') // Remove *Hook*
				.replace(/\*Refrain.*?\*/gi, '') // Remove *Refrain*
				.replace(/\[Verse.*?\]/gi, '') // Remove [Verse 1]
				.replace(/\[Chorus.*?\]/gi, '') // Remove [Chorus]
				.replace(/\[Bridge.*?\]/gi, '') // Remove [Bridge]
				.replace(/\[Intro.*?\]/gi, '') // Remove [Intro]
				.replace(/\[Outro.*?\]/gi, '') // Remove [Outro]
				.replace(/\[Pre-Chorus.*?\]/gi, '') // Remove [Pre-Chorus]
				.replace(/\[Hook.*?\]/gi, '') // Remove [Hook]
				.replace(/\[Refrain.*?\]/gi, '') // Remove [Refrain]
				.replace(/\s+/g, ' ') // Clean up extra spaces
				.trim();
			
			const instruction = "IMMEDIATELY AND WITHOUT REMARKS OR COMMENTARY TRANSCRIBE EXACTLY THIS TEXT AS IF IT IS SONG LYRICS READ ALOUD AS TONGUE IN CHEEK PERFORMANCE:";
			const textToSpeak = `${instruction} ${cleanLyrics}`;
			const encodedText = encodeURIComponent(textToSpeak);
			const audioSeed = Math.floor(Math.random() * 1000000);
			const audioUrl = `${AUDIO_API}${encodedText}?model=openai-audio&voice=${voice}&seed=${audioSeed}&referrer=songcomposer`;
			
			return new Promise(async (resolve, reject) => {
				try {
					const response = await fetch(audioUrl);
					if (!response.ok) throw new Error('Audio fetch failed');
					
					const blob = await response.blob();
					const localAudioUrl = URL.createObjectURL(blob);
					
					resolve(localAudioUrl);
				} catch (error) {
					reject(error);
				}
			});
		}

		// Refresh artwork with new seed
		window.refreshArtwork = async function() {
			if (!currentSong) return;
			
			const refreshBtn = document.querySelector('.refresh-artwork-btn');
			if (refreshBtn) {
				refreshBtn.innerHTML = '⏳';
				refreshBtn.style.pointerEvents = 'none';
			}
			
			showStatus('Generating new artwork... 🎨', 'info');
			
			try {
				const newArtworkUrl = await generateArtwork();
				
				// Convert to base64 for storage
				const response = await fetch(newArtworkUrl);
				const blob = await response.blob();
				const reader = new FileReader();
				reader.onloadend = async () => {
					const base64data = reader.result;
					currentSong.artworkUrl = base64data;
					
					// Update in database
					const transaction = db.transaction(['songs'], 'readwrite');
					const store = transaction.objectStore('songs');
					await store.put(currentSong);
					
					// Update display
					showArtwork(base64data);
					loadLibrary();
					showStatus('New artwork generated! 🎨', 'success');
				};
				reader.readAsDataURL(blob);
				
			} catch (error) {
				console.error('Artwork refresh failed:', error);
				showStatus('Failed to generate new artwork. Please try again! 🎨', 'error');
				if (refreshBtn) {
					refreshBtn.innerHTML = '🔄';
					refreshBtn.style.pointerEvents = 'auto';
				}
			}
		};

		// Start lyrics editing
		function startLyricsEdit() {
			document.getElementById('lyrics-text').classList.add('hidden');
			document.getElementById('lyrics-editor').classList.remove('hidden');
			document.getElementById('lyrics-textarea').focus();
		}

		// Save lyrics edit
		window.saveLyricsEdit = async function() {
			const newLyrics = document.getElementById('lyrics-textarea').value.trim();
			
			if (!newLyrics) {
				showStatus('Lyrics cannot be empty! ✏️', 'error');
				return;
			}
			
			if (!currentSong) {
				showStatus('No song to update! ✏️', 'error');
				return;
			}
			
			// Update current song
			currentSong.lyrics = newLyrics;
			
			try {
				// Save to database
				const transaction = db.transaction(['songs'], 'readwrite');
				const store = transaction.objectStore('songs');
				await store.put(currentSong);
				
				// Update display
				document.getElementById('lyrics-text').innerHTML = `
					${newLyrics}
					<div style="position: absolute; top: 10px; right: 10px; font-size: 0.8rem; color: #667eea; opacity: 0.7;">
						Click to edit ✏️
					</div>
				`;
				
				document.getElementById('lyrics-editor').classList.add('hidden');
				document.getElementById('lyrics-text').classList.remove('hidden');
				
				loadLibrary();
				showStatus('Lyrics updated successfully! ✏️', 'success');
				
			} catch (error) {
				console.error('Error saving lyrics:', error);
				showStatus('Failed to save lyrics changes! ✏️', 'error');
			}
		};

		// Cancel lyrics edit
		window.cancelLyricsEdit = function() {
			document.getElementById('lyrics-editor').classList.add('hidden');
			document.getElementById('lyrics-text').classList.remove('hidden');
		};

		// Regenerate audio after lyrics edit
		window.regenerateAudioAfterEdit = async function() {
			if (!currentSong) return;
			
			const regenBtn = document.querySelector('.lyrics-edit-controls button:last-child');
			if (regenBtn) {
				regenBtn.innerHTML = '⏳ Generating...';
				regenBtn.disabled = true;
			}
			
			showStatus('Generating new vocal demo with updated lyrics... 🎤', 'info');
			showAudioPlaceholder();
			
			try {
				const newAudioUrl = await generateVocalDemo(currentSong.lyrics, currentSong.voice || 'nova');
				
				// Convert to base64 for storage
				const response = await fetch(newAudioUrl);
				const blob = await response.blob();
				const reader = new FileReader();
				reader.onloadend = async () => {
					const base64data = reader.result;
					currentSong.audioUrl = base64data;
					currentAudioUrl = base64data;
					
					// Update in database
					const transaction = db.transaction(['songs'], 'readwrite');
					const store = transaction.objectStore('songs');
					await store.put(currentSong);
					
					// Update display
					showAudio(base64data);
					loadLibrary();
					showStatus('New vocal demo generated with updated lyrics! 🎤', 'success');
				};
				reader.readAsDataURL(blob);
				
			} catch (error) {
				console.error('Audio regeneration failed:', error);
				showAudioError();
				showStatus('Failed to generate new vocal demo. Please try again! 🎤', 'error');
			} finally {
				if (regenBtn) {
					regenBtn.innerHTML = '🎤 Generate New Audio';
					regenBtn.disabled = false;
				}
			}
		};

        // Display lyrics
		function displayLyrics(lyrics) {
			lyricsDisplay.innerHTML = `
				<div id="lyrics-text" class="lyrics-display" style="cursor: pointer; position: relative;">
					${lyrics}
					<div style="position: absolute; top: 10px; right: 10px; font-size: 0.8rem; color: #667eea; opacity: 0.7;">
						Click to edit ✏️
					</div>
				</div>
				<div id="lyrics-editor" class="hidden">
					<textarea id="lyrics-textarea" class="editable-lyrics">${lyrics}</textarea>
					<div class="lyrics-edit-controls">
						<button class="mini-button" onclick="saveLyricsEdit()">💾 Save Changes</button>
						<button class="mini-button" onclick="cancelLyricsEdit()">❌ Cancel</button>
						<button class="mini-button" onclick="regenerateAudioAfterEdit()">🎤 Generate New Audio</button>
					</div>
				</div>
			`;
			
			// Add click handler for editing
			document.getElementById('lyrics-text').addEventListener('click', startLyricsEdit);
			
			lyricsSection.classList.remove('hidden');
			lyricsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
		}

		// Show artwork with refresh button
		function showArtwork(artworkUrl) {
			songArtworkContainer.innerHTML = `
				<div class="artwork-container">
					<img id="song-artwork" class="song-artwork" alt="Song artwork" src="${artworkUrl}" />
					<button class="refresh-artwork-btn" onclick="refreshArtwork()" title="Generate new artwork">
						🔄
					</button>
				</div>
			`;
			songArtworkContainer.classList.remove('hidden');
		}

        // Show audio
        function showAudio(audioUrl) {
            audioContainer.style.display = 'block';
            
            const existingAudio = audioContainer.querySelector('audio');
            if (existingAudio) {
                existingAudio.src = audioUrl;
            } else {
                audioContainer.innerHTML = `
                    <h3 style="color: #2d3748; margin-bottom: 1rem;">🎵 Vocal Demo</h3>
                    <audio id="audio-player" controls></audio>
                    <button class="mini-button" id="download-audio-btn" style="margin-top: 1rem;">
                        💾 Download Demo
                    </button>
                `;
                
                document.getElementById('audio-player').src = audioUrl;
                document.getElementById('download-audio-btn').addEventListener('click', downloadAudio);
            }
            
            currentAudioUrl = audioUrl;
        }

        // Show audio loading placeholder
        function showAudioPlaceholder() {
            audioContainer.style.display = 'block';
            audioContainer.innerHTML = `
                <h3 style="color: #2d3748; margin-bottom: 1rem;">🎵 Vocal Demo</h3>
                <div style="padding: 2rem; text-align: center; color: #667eea; background: linear-gradient(135deg, #e6f3ff, #f0e6ff); border-radius: 10px;">
                    <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                    <p><strong>Creating your vocal demo...</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #718096;">This may take 30-60 seconds ⏳</p>
                </div>
            `;
        }

        // Show audio error
        function showAudioError() {
            audioContainer.style.display = 'block';
            audioContainer.innerHTML = `
                <h3 style="color: #2d3748; margin-bottom: 1rem;">🎵 Vocal Demo</h3>
                <div style="padding: 1.5rem; text-align: center; color: #e53e3e; background: #fed7d7; border-radius: 10px;">
                    <p><strong>❌ Vocal demo generation failed</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">You can try creating a new version to generate audio, or view this song later from your library!</p>
                </div>
            `;
        }

        // Toggle favorite
        async function toggleFavorite() {
            if (!currentSong) return;
            
            currentSong.favorited = !currentSong.favorited;
            
            try {
                const transaction = db.transaction(['songs'], 'readwrite');
                const store = transaction.objectStore('songs');
                await store.put(currentSong);
                
                favoriteSongBtn.innerHTML = currentSong.favorited ? 
                    '⭐ Remove from Favorites' : '⭐ Add to Favorites';
                
                loadLibrary();
                showStatus(currentSong.favorited ? 'Added to favorites! ⭐' : 'Removed from favorites! ⭐', 'success');
            } catch (error) {
                console.error('Error updating favorite:', error);
            }
        }

        // Copy lyrics to clipboard
        async function copyLyrics() {
            if (!currentSong || !currentSong.lyrics) {
                showStatus('No lyrics to copy! 📋', 'error');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(currentSong.lyrics);
                showStatus('Lyrics copied to clipboard! 📋', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                showStatus('Failed to copy lyrics. Please select and copy manually! 📋', 'error');
            }
        }

        // Download audio
        async function downloadAudio() {
            if (!currentAudioUrl) {
                showStatus('No vocal demo to download. Create audio first! 🎤', 'error');
                return;
            }
            
            showStatus('Preparing download...', 'info');
            
            try {
                const response = await fetch(currentAudioUrl);
                if (!response.ok) throw new Error('Failed to fetch audio');
                
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = blobUrl;
                
                const title = document.getElementById('song-title').value.trim() || 'song';
                const safeFileName = title.replace(/[^a-z0-9_]/gi, '_').toLowerCase();
                const filename = `song_demo_${safeFileName}_${Date.now()}.mp3`;
                a.download = filename;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(blobUrl);
                showStatus('Download started! 💾', 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showStatus('Download failed. Please try again! 💾', 'error');
            }
        }

        // Save to library with limit management
        async function saveToLibrary(song) {
            try {
                const transaction = db.transaction(['songs'], 'readwrite');
                const store = transaction.objectStore('songs');
                
                await store.add(song);
                
                const allSongs = await store.getAll();
                if (allSongs.length > 10) {
                    const nonFavorited = allSongs
                        .filter(song => !song.favorited)
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    const needToDelete = allSongs.length - 10;
                    for (let i = 0; i < Math.min(needToDelete, nonFavorited.length); i++) {
                        await store.delete(nonFavorited[i].id);
                    }
                }
                
                loadLibrary();
            } catch (error) {
                console.error('Error saving to library:', error);
            }
        }

        // Load library
        async function loadLibrary() {
            try {
                const transaction = db.transaction(['songs'], 'readonly');
                const store = transaction.objectStore('songs');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    songLibrary = request.result;
                    updateLibraryUI();
                };
            } catch (error) {
                console.error('Error loading library:', error);
            }
        }

        // Update library UI
        function updateLibraryUI() {
            if (songLibrary.length === 0) {
                songLibraryList.innerHTML = `
                    <div style="text-align: center; color: #718096; font-style: italic; padding: 3rem;">
                        No songs created yet. Start composing your first masterpiece above! 🎼
                    </div>
                `;
                return;
            }
            
            songLibraryList.innerHTML = songLibrary.map((song) => {
                const preview = song.lyrics.substring(0, 150) + '...';
                const date = new Date(song.timestamp).toLocaleDateString();
                
                return `
                    <div class="song-card ${song.favorited ? 'favorited' : ''}" data-song-id="${song.id}">
                        <div class="song-title">
                            ${song.favorited ? '⭐ ' : ''}${song.title}
                        </div>
                        <div class="song-preview">${preview}</div>
                        <div class="song-meta">
                            <span>📅 ${date} | 🎵 ${song.genre} | 😊 ${song.mood}</span>
                        </div>
                        <div class="song-actions">
                            <button class="mini-button" onclick="loadSongFromLibrary(${songLibrary.indexOf(song)})">🎼 View Full Song</button>
                            ${song.audioUrl ? `<button class="mini-button" onclick="playLibraryAudio(${songLibrary.indexOf(song)})">🎤 Play Demo</button>` : ''}
                            ${song.audioUrl ? `<button class="mini-button" onclick="downloadLibraryAudio(${songLibrary.indexOf(song)})">💾 Download</button>` : ''}
                            <button class="mini-button" onclick="copyLibraryLyrics(${songLibrary.indexOf(song)})">📋 Copy Lyrics</button>
                            <button class="mini-button ${song.favorited ? 'favorite' : ''}" onclick="toggleLibraryFavorite(${songLibrary.indexOf(song)})">
                                ${song.favorited ? '⭐ Favorited' : '⭐ Favorite'}
                            </button>
                            <button class="mini-button" onclick="deleteSongFromLibrary(${songLibrary.indexOf(song)})">🗑️ Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Library functions
        window.loadSongFromLibrary = async function(index) {
            if (index >= 0 && index < songLibrary.length) {
                const song = songLibrary[index];
                currentSong = song;
                
                // Fill form fields
                document.getElementById('song-title').value = song.title;
                document.getElementById('song-artist').value = song.artist || '';
                document.getElementById('song-theme').value = song.theme || '';
                document.getElementById('song-mood').value = song.mood;
                document.getElementById('song-structure').value = song.structure || 'verse-chorus';
                document.getElementById('voice-type').value = song.voice || 'nova';
                
                // Update genre selection
                if (song.genre) {
                    document.querySelectorAll('.genre-button').forEach(b => b.classList.remove('selected'));
                    const genreButton = document.querySelector(`[data-genre="${song.genre}"]`);
                    if (genreButton) {
                        genreButton.classList.add('selected');
                        selectedGenre = song.genre;
                    } else {
                        document.getElementById('custom-genre').value = song.genre;
                    }
                }
                
                // Display lyrics
                displayLyrics(song.lyrics);
                
                // Handle artwork
				if (song.artworkUrl) {
					showArtwork(song.artworkUrl);
				} else {
					songArtworkContainer.classList.remove('hidden');
					songArtworkContainer.innerHTML = `
						<div style="width: 100%; max-width: 400px; height: 400px; background: linear-gradient(135deg, #f7fafc, #edf2f7); border: 2px dashed #cbd5e0; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 1rem auto;">
							<div style="text-align: center; color: #667eea;">
								<div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
								<p>Creating album artwork... 🎨</p>
							</div>
						</div>
					`;
					
					try {
						const artworkUrl = await generateArtwork();
						// Convert to base64 for storage
						const response = await fetch(artworkUrl);
						const blob = await response.blob();
						const reader = new FileReader();
						reader.onloadend = async () => {
							const base64data = reader.result;
							song.artworkUrl = base64data;
							showArtwork(base64data);
							
							const transaction = db.transaction(['songs'], 'readwrite');
							const store = transaction.objectStore('songs');
							await store.put(song);
							loadLibrary();
						};
						reader.readAsDataURL(blob);
					} catch (error) {
						console.error('Failed to generate missing artwork:', error);
						songArtworkContainer.innerHTML = `
							<div style="width: 100%; max-width: 400px; height: 200px; background: #fed7d7; border: 2px dashed #e53e3e; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 1rem auto;">
								<p style="color: #742a2a;">❌ Artwork generation failed</p>
							</div>
						`;
					}
				}
                
                // Handle audio
                if (song.audioUrl) {
                    showAudio(song.audioUrl);
                } else {
                    audioContainer.style.display = 'block';
                    audioContainer.innerHTML = `
                        <h3 style="color: #2d3748; margin-bottom: 1rem;">🎵 Vocal Demo</h3>
                        <div style="padding: 2rem; text-align: center; color: #667eea;">
                            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                            <p>Creating vocal demo... Please wait! 🎤</p>
                        </div>
                    `;
                    
                    try {
                        const audioUrl = await generateVocalDemo(song.lyrics, song.voice || 'nova');
                        song.audioUrl = audioUrl;
                        currentAudioUrl = audioUrl;
                        
                        showAudio(audioUrl);
                        
                        const transaction = db.transaction(['songs'], 'readwrite');
                        const store = transaction.objectStore('songs');
                        await store.put(song);
                        loadLibrary();
                        
                        showStatus('Vocal demo generated successfully! 🎤', 'success');
                    } catch (error) {
                        console.error('Failed to generate missing audio:', error);
                        audioContainer.innerHTML = `
                            <h3 style="color: #2d3748; margin-bottom: 1rem;">🎵 Vocal Demo</h3>
                            <div style="padding: 1rem; text-align: center; color: #e53e3e;">
                                <p>❌ Vocal demo generation failed. Try again later!</p>
                            </div>
                        `;
                    }
                }
                
                // Update favorite button
                favoriteSongBtn.innerHTML = song.favorited ? 
                    '⭐ Remove from Favorites' : '⭐ Add to Favorites';
                
                showStatus('Song loaded! ✨', 'success');
            }
        };

        window.playLibraryAudio = function(index) {
            if (index >= 0 && index < songLibrary.length) {
                const song = songLibrary[index];
                if (song.audioUrl) {
                    audioPlayer.src = song.audioUrl;
                    audioContainer.style.display = 'block';
                    currentAudioUrl = song.audioUrl;
                    audioPlayer.play();
                    showStatus('Playing vocal demo! 🎤', 'success');
                }
            }
        };

        window.downloadLibraryAudio = async function(index) {
            if (index >= 0 && index < songLibrary.length) {
                const song = songLibrary[index];
                if (song.audioUrl) {
                    showStatus('Preparing download...', 'info');
                    
                    try {
                        const response = await fetch(song.audioUrl);
                        if (!response.ok) throw new Error('Failed to fetch audio');
                        
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        
                        const safeFileName = song.title.replace(/[^a-z0-9_]/gi, '_').toLowerCase();
                        const filename = `song_demo_${safeFileName}_${Date.now()}.mp3`;
                        a.download = filename;
                        
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        URL.revokeObjectURL(blobUrl);
                        showStatus('Download complete! 💾', 'success');
                        
                    } catch (error) {
                        console.error('Download error:', error);
                        showStatus('Download failed. Please try again! 💾', 'error');
                    }
                }
            }
        };

        window.copyLibraryLyrics = async function(index) {
            if (index >= 0 && index < songLibrary.length) {
                const song = songLibrary[index];
                try {
                    await navigator.clipboard.writeText(song.lyrics);
                    showStatus('Lyrics copied to clipboard! 📋', 'success');
                } catch (error) {
                    console.error('Copy failed:', error);
                    showStatus('Failed to copy lyrics! 📋', 'error');
                }
            }
        };

        window.toggleLibraryFavorite = async function(index) {
            if (index >= 0 && index < songLibrary.length) {
                const song = songLibrary[index];
                song.favorited = !song.favorited;
                
                try {
                    const transaction = db.transaction(['songs'], 'readwrite');
                    const store = transaction.objectStore('songs');
                    await store.put(song);
                    
                    loadLibrary();
                    showStatus(song.favorited ? 'Added to favorites! ⭐' : 'Removed from favorites! ⭐', 'success');
                } catch (error) {
                    console.error('Error updating favorite:', error);
                }
            }
        };

        window.deleteSongFromLibrary = async function(index) {
            if (index >= 0 && index < songLibrary.length) {
                if (confirm('Are you sure you want to delete this song? 🗑️')) {
                    try {
                        const song = songLibrary[index];
                        const transaction = db.transaction(['songs'], 'readwrite');
                        const store = transaction.objectStore('songs');
                        await store.delete(song.id);
                        
                        loadLibrary();
                        showStatus('Song deleted! 🗑️', 'success');
                    } catch (error) {
                        console.error('Error deleting song:', error);
                        showStatus('Failed to delete song! 🗑️', 'error');
                    }
                }
            }
        };

        // Clear library
        async function clearLibrary() {
            if (confirm('Are you sure you want to delete ALL songs? This cannot be undone! 🗑️')) {
                try {
                    const transaction = db.transaction(['songs'], 'readwrite');
                    const store = transaction.objectStore('songs');
                    await store.clear();
                    
                    songLibrary = [];
                    updateLibraryUI();
                    showStatus('All songs deleted! 🗑️', 'success');
                } catch (error) {
                    console.error('Error clearing library:', error);
                    showStatus('Failed to clear library! 🗑️', 'error');
                }
            }
        }

        // Loading state helper
        function setLoading(button, isLoading, loadingText = 'Loading...') {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="loading-spinner"></span> ${loadingText}`;
            } else {
                button.disabled = false;
                if (button.id === 'generate-lyrics-btn') {
                    button.innerHTML = '✨ Create My Song Lyrics! ✨';
                } else if (button.id === 'regenerate-lyrics-btn') {
                    button.innerHTML = '🔄 New Version';
                }
            }
        }

        // Add musical effects to buttons
        document.addEventListener('DOMContentLoaded', function() {
            const magicButtons = document.querySelectorAll('.magic-button');
            magicButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const notes = ['🎵', '🎶', '🎼', '🎤', '🎸'];
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            const note = document.createElement('div');
                            note.innerHTML = notes[Math.floor(Math.random() * notes.length)];
                            note.style.position = 'absolute';
                            note.style.left = e.pageX + (Math.random() - 0.5) * 60 + 'px';
                            note.style.top = e.pageY + (Math.random() - 0.5) * 60 + 'px';
                            note.style.pointerEvents = 'none';
                            note.style.fontSize = '1.5rem';
                            note.style.zIndex = '9999';
                            note.style.animation = 'noteFloat 1.2s ease-out forwards';
                            document.body.appendChild(note);
                            
                            setTimeout(() => note.remove(), 1200);
                        }, i * 150);
                    }
                });
            });
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes noteFloat {
                    0% { opacity: 1; transform: translateY(0px) scale(1) rotate(0deg); }
                    100% { opacity: 0; transform: translateY(-40px) scale(0.3) rotate(360deg); }
                }
            `;
            document.head.appendChild(style);

            // Set copyright year
            const currentYear = new Date().getFullYear();
            const startYear = 2024;
            const yearDisplay = currentYear > startYear ? `${startYear}-${currentYear}` : currentYear;
            document.getElementById('copyright-year').textContent = yearDisplay;
        });
    </script>

    <footer class="disclaimer-footer">
        <p>This tool is intended for songwriting and creative purposes. Please review all generated content for appropriateness and originality before commercial use. Songs are generated by AI and may require editing for professional use.</p>
        <p>Lyrics, Image, Audio Generation Powered by Pollinations.ai</p>
        <p>© <span id="copyright-year"></span> AI-Ministries.com - All Rights Reserved</p>
    </footer>

</body>
</html>