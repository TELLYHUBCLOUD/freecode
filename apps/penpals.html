<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Penpal Exchange</title>
    <script src="/js/nav-loader.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Homemade+Apple&family=Caveat&display=swap" rel="stylesheet">
	<style>
	@import url('https://fonts.googleapis.com/css2?family=Homemade+Apple&family=Caveat&display=swap');

	body {
		background: #1a1a2e;
		min-height: calc(100vh - var(--nav-height));
		color: #e1e2e6;
		margin: 0;
		padding: 1rem;
	}

	:root {
		--frame-border: #463e2e;
		--paper-bg: #f8f5e6;
		--paper-line: #e1d5c9;
		--nav-height: 72px;  /* Add this */
	}

	.app-container {
		max-width: 1400px;
		margin: 0 auto;
		height: calc(100vh - var(--nav-height) - 2rem);  /* Update this */
		display: grid;
		grid-template-columns: minmax(300px, 400px) 1fr;
		gap: 1rem;
		position: relative;
		overflow: hidden;
	}

	.portrait-gallery {
		background: #2a2a3e;
		border: 12px solid var(--frame-border);
		border-radius: 0.5rem;
		display: flex;
		flex-direction: column;
		width: 400px;
		transition: all 0.3s ease;
		position: relative;
		height: 100%;
	}

	.portrait-gallery.hidden {
		transform: translateX(-100%);
		width: 0;
		visibility: hidden;  /* Add this */
		margin: 0;
		padding: 0;
		border: none;       /* Add this */
	}

	.portrait-gallery.expanded {
		width: 800px;  /* or could be even wider */
	}

	.portrait-frame {
	position: relative;
	flex: 1;
	overflow: hidden;
	min-height: 0;
	}

	.gallery-image {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	object-fit: cover;
	opacity: 0;
	transition: opacity 0.3s ease;
	}

	.gallery-image.active {
	opacity: 1;
	}

	.gallery-controls {
	position: absolute;
	top: 50%;
	left: 0;
	right: 0;
	transform: translateY(-50%);
	display: flex;
	justify-content: space-between;
	padding: 0 1rem;
	pointer-events: none;
	}

	.gallery-control {
	width: 40px;
	height: 40px;
	border-radius: 50%;
	background: rgba(0, 0, 0, 0.5);
	color: white;
	display: flex;
	align-items: center;
	justify-content: center;
	cursor: pointer;
	pointer-events: auto;
	transition: all 0.2s ease;
	}

	.gallery-control.expand {
		position: absolute;
		right: -40px;
		top: 50%;
		transform: translateY(-50%);
		z-index: 30;
	}

	.gallery-control:hover {
	background: rgba(0, 0, 0, 0.7);
	}

	.signature-required {
		border-color: #ff6b6b !important;
	}

	.loading-message, .error-message {
		text-align: center;
		padding: 2rem;
		opacity: 0.7;
	}

	.error-message {
		color: #ff6b6b;
	}

	.thumbnail-strip {
	display: flex;
	gap: 0.5rem;
	padding: 0.5rem;
	overflow-x: auto;
	background: rgba(0, 0, 0, 0.2);
	min-height: 80px;
	}

	.thumbnail {
	flex: 0 0 60px;
	height: 60px;
	border: 2px solid transparent;
	border-radius: 0.25rem;
	cursor: pointer;
	transition: all 0.2s ease;
	object-fit: cover;
	}

	.thumbnail:hover {
	transform: translateY(-2px);
	}

	.thumbnail.active {
	border-color: #ffd700;
	}

	.letters-container {
		position: relative;
		height: 100%;
		display: flex;
		flex-direction: column;
		transition: all 0.3s ease;
		flex: 1;
	}

	.letter-content {
		height: 100%;
		padding: 1.5rem;
		padding-top: 4rem;
		overflow-y: auto;
	}

	.letters-container.full-width {
	  grid-column: 1 / -1;
	}

	.app-container.docked {
	  grid-template-columns: 0fr 1fr;
	}

	.letter-paper {
		background: var(--paper-bg);
		color: #2c2c2c;
		box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
		background-image: repeating-linear-gradient(var(--paper-bg) 0px, var(--paper-bg) 24px, var(--paper-line) 25px);
		border-radius: 0.5rem;
		position: relative;
		height: 100%;
		transition: all 0.3s ease;
	}

	.handwritten {
	font-family: 'Homemade Apple', cursive;
	line-height: 25px;
	padding-top: 6px;
	}

	.ai-section {
	flex: 1;
	position: relative;
	transition: all 0.3s ease;
	}

	.user-section {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
	height: 30%;
	transform: translateY(calc(100% - 50px));
	transition: all 0.3s ease;
	z-index: 10;
	}

	.user-section:hover,
	.user-section.expanded {
	transform: translateY(0);
	}

	.user-section .letter-paper {
	height: 100%;
	padding: 1.5rem;
	}

	.dock-button {
	  right: -2rem;
	  width: 2rem;
	  height: 60px;
	  background: var(--frame-border);
	  border: none;
	  color: white;
	  cursor: pointer;
	  border-radius: 0 0.25rem 0.25rem 0;
	  position: absolute;
	  top: 50%;
	  transform: translateY(-50%);
	  z-index: 20;
	}

	.dock-button:hover {
	right: -1.75rem;
	}

	.writing-tools {
	position: absolute;
	bottom: 1rem;
	right: 1rem;
	display: flex;
	gap: 0.5rem;
	}

	.tts-word {
	display: inline-block;
	padding: 0 2px;
	border-radius: 2px;
	transition: all 0.2s ease;
	}

	.tts-word.highlight {
	background: rgba(255, 223, 137, 0.4);
	}

	.polaroid {
	background: white;
	padding: 0.75rem;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	transform: rotate(-2deg);
	display: inline-block;
	margin: 1rem;
	max-width: 180px;
	}

	.polaroid img {
	width: 100%;
	height: 150px;
	object-fit: cover;
	margin-bottom: 0.5rem;
	}

	.polaroid-caption {
	font-family: 'Caveat', cursive;
	text-align: center;
	color: #333;
	font-size: 1.1rem;
	}

	.portrait-controls {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 0.5rem;
	background: linear-gradient(to bottom, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0) 100%);
	z-index: 20;
	}

	.control-group {
	display: flex;
	gap: 0.5rem;
	align-items: center;
	}

	.favorite-btn, .clear-btn {
	width: 32px;
	height: 32px;
	border: none;
	border-radius: 50%;
	color: white;
	cursor: pointer;
	transition: all 0.2s ease;
	display: flex;
	align-items: center;
	justify-content: center;
	background: rgba(0, 0, 0, 0.3);
	backdrop-filter: blur(2px);
	}

	.favorite-btn.active {
	color: gold;
	}

	.favorite-btn:hover {
	background: rgba(255, 215, 0, 0.3);
	}

	.clear-btn {
	background: rgba(220, 38, 38, 0.3);
	}

	.clear-btn:hover {
	background: rgba(220, 38, 38, 0.5);
	}

	.new-penpal-btn {
	background: rgba(0, 0, 0, 0.3);
	border: none;
	border-radius: 1rem;
	padding: 0.5rem 1rem;
	color: white;
	cursor: pointer;
	transition: all 0.2s ease;
	backdrop-filter: blur(2px);
	}

	.new-penpal-btn:hover {
	background: rgba(0, 0, 0, 0.5);
	}

	.penpal-list {
	  position: absolute;
	  right: -3rem;
	  top: 1rem;
	  z-index: 30;
	}

	.show-penpals-btn {
	  width: 2.5rem;
	  height: 2.5rem;
	  border-radius: 50%;
	  background: var(--frame-border);
	  color: white;
	  border: none;
	  cursor: pointer;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  transition: all 0.2s;
	}

	.penpal-list-content {
	  position: absolute;
	  right: 3rem;
	  top: 0;
	  width: 250px;
	  background: #2a2a3e;
	  border: 1px solid var(--frame-border);
	  border-radius: 0.5rem;
	  padding: 1rem;
	  display: none;
	}

	.penpal-list-content.visible {
	  display: block;
	}

	.penpal-entry {
	  display: flex;
	  align-items: center;
	  gap: 0.5rem;
	  padding: 0.5rem;
	  cursor: pointer;
	  border-radius: 0.25rem;
	  transition: all 0.2s;
	}

	.penpal-entry:hover {
	  background: rgba(255, 255, 255, 0.1);
	}

	.penpal-entry img {
	  width: 40px;
	  height: 40px;
	  border-radius: 50%;
	  object-fit: cover;
	}

	.letter-controls {
	position: absolute;
	top: 1rem;
	right: 1rem;
	display: flex;
	gap: 0.5rem;
	z-index: 50;
	}

	.letter-content {
		height: 100%;
		padding: 1.5rem;
		padding-top: 4rem;  /* Added extra top padding */
		overflow-y: auto;
	}

	.control-button {
	background: rgba(0, 0, 0, 0.2);
	border: 1px solid rgba(255, 255, 255, 0.2);
	color: #2c2c2c;
	padding: 0.5rem 1rem;
	border-radius: 0.5rem;
	cursor: pointer;
	transition: all 0.2s ease;
	backdrop-filter: blur(5px);
	font-size: 0.9rem;
	min-width: 40px;
	min-height: 40px;
	display: flex;
	align-items: center;
	justify-content: center;
	}

	.control-button:hover {
	background: rgba(0, 0, 0, 0.3);
	transform: translateY(-1px);
	}
	
	#initial-selector {
	  display: block; /* Will be toggled by JS */
	}

	.selector-row {
	  display: flex;
	  align-items: center;
	  justify-content: space-between;
	  padding: 1rem;
	  background: rgba(255, 255, 255, 0.1);
	  border-radius: 0.5rem;
	  margin-bottom: 0.5rem;
	}

	.arrow-btn {
	  color: white;
	  width: 40px;
	  height: 40px;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  background: rgba(0, 0, 0, 0.3);
	  border-radius: 50%;
	  border: none;
	  cursor: pointer;
	  transition: all 0.2s;
	}

	.arrow-btn:hover {
	  background: rgba(0, 0, 0, 0.5);
	}

	.selection {
	  text-align: center;
	  color: white;
	}

	.selection .label {
	  display: block;
	  font-size: 0.8rem;
	  text-transform: uppercase;
	  opacity: 0.7;
	  margin-bottom: 0.25rem;
	}

	.selection span {
	  display: block;
	  font-size: 1.2rem;
	}

	.handwriting-neat { 
		font-family: 'Indie Flower', cursive;
		font-size: 1.1rem;
		line-height: 1.6;
	}

	.handwriting-formal { 
		font-family: 'Dancing Script', cursive;
		font-size: 1.2rem;
		line-height: 1.8;
	}

	.handwriting-casual { 
		font-family: 'Caveat', cursive;
		font-size: 1.15rem;
		line-height: 1.5;
	}

	.handwriting-bold { 
		font-family: 'Permanent Marker', cursive;
		font-size: 1.1rem;
		line-height: 1.4;
	}
	
	@media (max-width: 768px) {
	.app-container {
	  grid-template-columns: 0fr 1fr;
	  height: auto;
	  gap: 0.5rem;
	}

	.portrait-gallery {
	  height: 300px;
	}

	.letters-container {
	  height: calc(100vh - 320px);
	}

	.docked .portrait-gallery {
	  width: 100px;
	}

	.docked .letters-container {
	  margin-left: 120px;
	}
	}
	
	.modal {
		display: none;
		position: fixed;
		z-index: 1000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.7);
	}

	.modal-content {
		background-color: #2a2a3e;
		margin: 15% auto;
		padding: 20px;
		border: 2px solid #6c5ce7;
		border-radius: 10px;
		width: 300px;
		position: relative;
	}

	.close {
		color: #e1e2e6;
		float: right;
		font-size: 28px;
		font-weight: bold;
		cursor: pointer;
	}

	.close:hover {
		color: #6c5ce7;
	}

	.modal-content h2 {
		color: #6c5ce7;
		margin-bottom: 15px;
	}

	.modal-content input {
		width: 100%;
		padding: 8px;
		margin: 10px 0;
		background: #1a1a2e;
		border: 1px solid #3f4255;
		border-radius: 4px;
		color: #e1e2e6;
		text-transform: uppercase;
	}

	.modal-content button {
		background: #6c5ce7;
		color: white;
		border: none;
		padding: 8px 20px;
		border-radius: 4px;
		cursor: pointer;
		width: 100%;
		margin-top: 10px;
	}

	.modal-content button:hover {
		background: #8075e5;
	}

	.error {
		color: #ff6b6b;
		font-size: 12px;
		margin-top: 5px;
	}

	.code-display {
		background: #1a1a2e;
		padding: 10px;
		border-radius: 4px;
		text-align: center;
		font-family: monospace;
		font-size: 18px;
		margin: 10px 0;
	}

	.warning-btn {
		background: #ff6b6b !important;
	}

	.secondary-btn {
		background: #1a1a2e !important;
		border: 1px solid #3f4255 !important;
	}

	.secondary-btn:hover {
		border-color: #6c5ce7 !important;
		background: #2a2a3e !important;
	}

	.registered {
		background: #1a1a2e !important;
		cursor: default !important;
	}	
	</style>

</head>
<body>
	<div id="initial-selector" class="w-full max-w-2xl mx-auto p-4 mb-8">

	  <div class="flex justify-between items-center mb-8">
		<h1 class="text-3xl text-center text-white">AI Penpal Exchange</h1>
		<div id="registration-status" class="registration-button">
		  <button id="register-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
			ENTER UNLOCK CODE
		  </button>
		</div>
	  </div>
	  
	  <div class="grid gap-4 bg-gray-800 p-6 rounded-lg">
        <div class="selector-row">
          <button class="arrow-btn"><i class="fas fa-chevron-left"></i></button>
          <div class="selection">
            <span class="label">GENDER</span>
            <span id="gender-value">FEMALE</span>
          </div>
          <button class="arrow-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="selector-row">
          <button class="arrow-btn"><i class="fas fa-chevron-left"></i></button>
          <div class="selection">
            <span class="label">AGE</span>
            <span id="age-value">21-34</span>
          </div>
          <button class="arrow-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="selector-row">
          <button class="arrow-btn"><i class="fas fa-chevron-left"></i></button>
          <div class="selection">
            <span class="label">PERSONALITY</span>
            <span id="personality-value">CURIOUS</span>
          </div>
          <button class="arrow-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="selector-row">
          <button class="arrow-btn"><i class="fas fa-chevron-left"></i></button>
          <div class="selection">
            <span class="label">LOCATION</span>
            <span id="location-value">FOREIGN</span>
          </div>
          <button class="arrow-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="selector-row">
          <button class="arrow-btn"><i class="fas fa-chevron-left"></i></button>
          <div class="selection">
            <span class="label">RELATIONSHIP</span>
            <span id="relationship-value">FRIEND</span>
          </div>
          <button class="arrow-btn"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="flex justify-center gap-4 mt-4">
          <button id="write-penpal" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <i class="fas fa-pen-fancy mr-2"></i>Write Penpal
          </button>
		    <button id="random-penpal" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
				<i class="fas fa-random mr-2"></i>Random Penpal
			</button>
        </div>
      </div>
    </div>
    <div class="app-container" id="app" style="display: none;">
    <!-- Portrait Gallery -->
    <div class="portrait-gallery">
      <!-- New Control Buttons -->
        <div class="portrait-controls">
            <button class="new-penpal-btn">
                <i class="fas fa-user-plus"></i> Meet Someone New
            </button>
          <div class="control-group">
            <button class="favorite-btn">
              <i class="fas fa-star"></i>
            </button>
            <button class="clear-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        
        <div class="penpal-list">
          <button class="show-penpals-btn">
            <i class="fas fa-address-book"></i>
          </button>
          <div class="penpal-list-content hidden">
            <h3>Your Penpals</h3>
            <div id="penpal-entries">
              <!-- Penpal entries will be inserted here -->
            </div>
          </div>
        </div>

      <div class="portrait-frame">
        <button class="gallery-control expand">
            <i class="fas fa-expand"></i>
        </button>
        <div id="gallery-images">
          <!-- Images will be inserted here -->
        </div>
        <div class="gallery-controls">
          <button class="gallery-control prev">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="gallery-control next">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="thumbnail-strip" id="thumbnails">
        <!-- Thumbnails will be inserted here -->
      </div>
        <button class="dock-button">
          <i class="fas fa-chevron-left"></i>
        </button>
    </div>

    <!-- Letters Container -->
    <div class="letters-container">
      <!-- AI Letter Section -->
      <div class="ai-section">
        <div class="letter-paper">
          <!-- Add this block for TTS controls -->
            <div class="letter-controls">
              <button class="control-button start-reading">
                <i class="fas fa-play"></i>
              </button>
              <button class="control-button pause-reading hidden">
                <i class="fas fa-pause"></i>
              </button>
              <button class="control-button stop-reading hidden">
                <i class="fas fa-stop"></i>
              </button>
            </div>
          <!-- End TTS controls block -->
          
          <div id="ai-letter" class="letter-content handwritten">
            <!-- AI letter content will go here -->
          </div>
        </div>
      </div>

      <!-- User Writing Section -->
      <div class="user-section" id="userSection">
        <div class="letter-paper">
          <textarea 
            id="user-letter" 
            class="w-full h-full bg-transparent handwritten resize-none focus:outline-none p-4"
            placeholder="Write your letter here..."
          ></textarea>
            <div class="writing-tools">
                <select id="handwriting-style" class="bg-transparent border-b border-gray-400 focus:outline-none focus:border-gray-600 px-2 py-1">
                    <option value="casual">Casual</option>
                    <option value="neat">Neat</option>
                    <option value="formal">Formal</option>
                    <option value="bold">Bold</option>
                </select>
                <input 
                    type="text" 
                    id="signature-input"
                    class="bg-transparent handwritten border-b border-gray-400 focus:outline-none focus:border-gray-600 px-2 py-1 w-48"
                    placeholder="Sign your name here..."
                />
                <button class="send-letter-btn bg-green-700 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    Sign & Send
                </button>
            </div>
        </div>
      </div>
    </div>
    </div>

	<div id="register-modal" class="modal">
		<div class="modal-content">
			<span class="close">×</span>
			<h2>Enter Unlock Code</h2>
			
			<!-- Registration view -->
			<div id="registration-view">
				<p>Please enter your 6-character unlock code:</p>
				<input type="text" id="unlock-code" maxlength="6" placeholder="XXXXXX">
				<p id="code-error" class="error"></p>
				<button id="submit-code">Submit</button>
				
				<div class="code-actions">
					<button id="get-code-btn" class="secondary-btn">Get Free Code</button>
					<button id="donate-btn" class="secondary-btn">❤️ Support Development</button>
				</div>
			</div>

			<!-- Registered status view -->
			<div id="registered-view" style="display: none;">
				<p>Currently registered with code:</p>
				<p id="current-code" class="code-display"></p>
				<button id="return-to-demo" class="warning-btn">Return to Demo Mode</button>
				<button id="donate-btn-reg" class="secondary-btn">❤️ Support Development</button>
			</div>
		</div>
	</div>

    <script>
    let currentUtterance = null;

    const state = {
        currentPenpal: null,
        images: [],
        currentImageIndex: 0,
        isDocked: false,
        isWriting: false,
        userName: '',
        userSignature: '',
        favorites: JSON.parse(localStorage.getItem('favoritePenpals') || '[]'),
        conversations: JSON.parse(localStorage.getItem('penpalConversations') || '{}'),
        preferences: {
            gender: ['MALE', 'FEMALE'],
            age: ['16-20', '21-34', '35-44', '45-54', '55+'],
            personality: ['OUTGOING', 'LEADING', 'CURIOUS', 'SHY', 'SMART'],
            location: ['LOCAL', 'CROSS COUNTRY', 'FOREIGN'],
            relationship: ['FRIEND', 'COMPANION', 'ROMANTIC']
        },
        currentSelection: {
            gender: 'FEMALE',
            age: '21-34',
            personality: 'CURIOUS',
            location: 'FOREIGN',
            relationship: 'FRIEND'
        },    
        cachedContent: {
            images: [],    // Store full image URLs
            letters: []    // Store generated letter texts
        },
        userHandwritingStyle: localStorage.getItem('userHandwritingStyle') || 'casual',
        penpals: JSON.parse(localStorage.getItem('penpals') || '{}'),  // Moved to end, ensure it's an object not array
		currentLetterWords: null,
		currentLetterElement: null
    };

    const DEMO_RESTRICTIONS = {
        maxConversations: 1,
        maxImages: 2,
        availableTraits: {
            gender: ['FEMALE'],
            age: ['21-34'],
            personality: ['CURIOUS'],
            location: ['CROSS COUNTRY'],
            relationship: ['FRIEND']
        }
    };

	const invalidCodes = [
		'123456', '012345', '543210', '654321', '111111', '222222',
		'333333', '444444', '555555', '666666', '777777', '888888',
		'999999', '000000', 'AAAAAA', 'BBBBBB', 'CCCCCC', 'DDDDDD',
		'EEEEEE', 'FFFFFF'
	];

	const isValidFormat = (code) => /^[A-Z0-9]{6}$/.test(code);

	const isTooSimple = (code) => {
		return invalidCodes.includes(code) || 
			   /^(.)\1+$/.test(code) || 
			   /^(0|1|2|3|4|5|6|7|8|9|A|B|C|D|E|F){6}$/.test(code); 
	};

	function generateUnlockCode() {
		const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		let code;
		do {
			code = '';
			for(let i = 0; i < 6; i++) {
				code += chars[Math.floor(Math.random() * chars.length)];
			}
		} while(isTooSimple(code));
		return code;
	}

	function togglePenpalList() {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';
        if (!isRegistered) return alert('Saving penpals is a premium feature. Register to unlock!');
	  const list = document.querySelector('.penpal-list-content');
	  list.classList.toggle('visible');
	  updatePenpalList();
	}

	function toggleGallerySize() {
		const gallery = document.querySelector('.portrait-gallery');
		const icon = document.querySelector('.gallery-control.expand i');
		
		if (gallery.classList.contains('hidden')) {
			gallery.classList.remove('hidden');
			gallery.classList.remove('expanded');
			icon.className = 'fas fa-expand';
		} else if (gallery.classList.contains('expanded')) {
			gallery.classList.remove('expanded');
			icon.className = 'fas fa-expand';
		} else {
			gallery.classList.add('expanded');
			icon.className = 'fas fa-compress';
		}
	}

	function startNewPenpal() {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';

		if (!isRegistered && Object.keys(state.conversations).length >= DEMO_RESTRICTIONS.maxConversations) {
			alert('Demo mode is limited to one penpal. Register to unlock unlimited penpals!');
            return;
		}

		document.getElementById('initial-selector').style.display = 'block';
		document.getElementById('app').style.display = 'none';
		generateRandomSelections();
	}
	
	function updatePenpalList() {
	  const container = document.getElementById('penpal-entries');
	  container.innerHTML = '';
	  
	  Object.entries(state.conversations).forEach(([penpalId, messages]) => {
		const penpal = state.favorites.find(p => p.name === penpalId) || 
					  { name: penpalId, portrait: messages[0]?.portrait };
		
		const entry = document.createElement('div');
		entry.className = 'penpal-entry';
		entry.innerHTML = `
		  <img src="${penpal.portrait}" alt="${penpal.name}">
		  <span>${penpal.name}</span>
		`;
		// Remove onclick, add dataset
		entry.dataset.penpalId = penpalId;
		container.appendChild(entry);
	  });

	  // Add single event listener for all entries using event delegation
	  container.addEventListener('click', (e) => {
		const entry = e.target.closest('.penpal-entry');
		if (entry) {
		  loadPenpalConversation(entry.dataset.penpalId);
		}
	  });
	}

	async function fetchSafeImage(prompt, needsSafeFlag = false) {
		const safetyParam = needsSafeFlag ? '&safe=true' : '';
		const maxAttempts = 3; // Limit retries
		
		for (let attempt = 0; attempt < maxAttempts; attempt++) {
			const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&private=true&enhance=false${safetyParam}&seed=${Math.random()}`;
			
			try {
				// Attempt to fetch the image first to check for safety message
				const response = await fetch(imageUrl);
				const contentType = response.headers.get('content-type');
				
				// If it's text, it might be a safety rejection message
				if (contentType.includes('text')) {
					const text = await response.text();
					if (text.includes('safety') || text.includes('unsafe')) {
						console.log(`Attempt ${attempt + 1}: Image rejected for safety, retrying...`);
						continue; // Try again
					}
				}
				
				// If we got here, the image is good
				return imageUrl;
			} catch (error) {
				console.error('Error fetching image:', error);
				if (attempt === maxAttempts - 1) {
					throw new Error('Failed to generate safe image after multiple attempts');
				}
			}
		}
		
		// If we get here, we couldn't get a safe image after all attempts
		throw new Error('Unable to generate appropriate image');
	}

	function cycleOption(category, direction) {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';
		
		// If not registered, check if they're trying to change a restricted option
		if (!isRegistered) {
			// Show premium prompt if trying to change restricted options
			alert('Demo mode is limited to Female (21-34) Cross Country Penpals seeking friendship. Register to unlock all options!');
			return;
		}

		// Only registered users can cycle through options
		const options = state.preferences[category];
		const currentIndex = options.indexOf(state.currentSelection[category]);
		const newIndex = (currentIndex + (direction === 'next' ? 1 : -1) + options.length) % options.length;
		state.currentSelection[category] = options[newIndex];
		document.getElementById(`${category}-value`).textContent = state.currentSelection[category];
	}

    function randomizeSelections() {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';

        if (isRegistered) {
            // Full random selection for registered users
            Object.keys(state.preferences).forEach(category => {
                const options = state.preferences[category];
                const randomIndex = Math.floor(Math.random() * options.length);
                state.currentSelection[category] = options[randomIndex];
                document.getElementById(`${category}-value`).textContent = state.currentSelection[category];
            });
        } else {
            // Demo users get fixed options
            Object.keys(DEMO_RESTRICTIONS.availableTraits).forEach(category => {
                // Always use the first (and only) option for demo users
                state.currentSelection[category] = DEMO_RESTRICTIONS.availableTraits[category][0];
                document.getElementById(`${category}-value`).textContent = DEMO_RESTRICTIONS.availableTraits[category][0];
            });
        }
    }

	function startPenpalExperience() {
	  document.getElementById('initial-selector').style.display = 'none';
	  document.getElementById('app').style.display = 'grid';
	}

	function toggleDock() {
	  const gallery = document.querySelector('.portrait-gallery');
	  const letters = document.querySelector('.letters-container');
	  
	  gallery.classList.toggle('hidden');
	  letters.classList.toggle('full-width');
	  
	  const icon = document.querySelector('.dock-button i');
	  icon.className = gallery.classList.contains('hidden') ? 
		'fas fa-chevron-right' : 'fas fa-chevron-left';
	}

	document.querySelector('.dock-button').addEventListener('click', toggleDock);


    function toggleUserSection() {
      const section = document.getElementById('userSection');
      section.classList.toggle('expanded');
    }

	function switchImage(index) {
        const images = document.querySelectorAll('.gallery-image');
        const thumbnails = document.querySelectorAll('.thumbnail');
        
        if (state.images.length === 0) {
            console.warn("No images to switch. Skipping switchImage.");
            return;
        }
        
        if (state.currentImageIndex >= state.images.length) {
            state.currentImageIndex = 0;
        }
    
    
        if (images && images[state.currentImageIndex]) {
            images[state.currentImageIndex].classList.remove('active');
        }
        if (thumbnails && thumbnails[state.currentImageIndex]) {
            thumbnails[state.currentImageIndex].classList.remove('active');
        }
    
      state.currentImageIndex = index;
        
      if (images && images[index]) {
        images[index].classList.add('active');
      }
        if (thumbnails && thumbnails[index]) {
        thumbnails[index].classList.add('active');
      }
    }

    function nextImage() {
      const nextIndex = (state.currentImageIndex + 1) % state.images.length;
      switchImage(nextIndex);
    }

    function prevImage() {
      const prevIndex = (state.currentImageIndex - 1 + state.images.length) % state.images.length;
      switchImage(prevIndex);
    }

	function addImage(imageUrl, caption, isPortrait = false) {
		const index = state.images.length;
		state.images.push({ url: imageUrl, caption });
		
		// Add to gallery
		const gallery = document.getElementById('gallery-images');
		const image = document.createElement('img');
		image.src = imageUrl;
		image.className = `gallery-image ${(index === 0 || isPortrait) ? 'active' : ''}`;
		image.alt = caption || '';
		gallery.appendChild(image);
		
		// Add thumbnail
		const strip = document.getElementById('thumbnails');
		const thumb = document.createElement('img');
		thumb.src = imageUrl;
		thumb.className = `thumbnail ${(index === 0 || isPortrait) ? 'active' : ''}`;
		thumb.dataset.index = index;  // Add data attribute instead of onclick
		strip.appendChild(thumb);
	}

	// Add single event listener for all thumbnails in window.onload
	document.getElementById('thumbnails').addEventListener('click', (e) => {
		if (e.target.matches('.thumbnail')) {
			switchImage(parseInt(e.target.dataset.index));
		}
	});

	function addPolaroidToLetter(imageUrl, caption) {
		return `<div class="polaroid">
			<img src="${imageUrl}" alt="${caption}">
			<div class="polaroid-caption">${caption}</div>
		</div>`;
	}

	function updateSignature(value) {
		// Only update when actually submitting a letter or explicitly saving
		if (value.trim()) {
			state.userName = value;
			state.userSignature = value;
			localStorage.setItem('penpalSignature', value);
			document.getElementById('signature-input').classList.remove('signature-required');
		}
	}

	function toggleFavorite() {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';
        if (!isRegistered) return alert('Favorite penpals are a premium feature. Register to unlock!');

	  const penpal = state.currentPenpal;
	  if (!penpal) return;

	  const index = state.favorites.findIndex(p => p.name === penpal.name);
	  if (index === -1) {
		state.favorites.push(penpal);
		document.querySelector('.favorite-btn').classList.add('active');
	  } else {
		state.favorites.splice(index, 1);
		document.querySelector('.favorite-btn').classList.remove('active');
	  }
	  
	  localStorage.setItem('favoritePenpals', JSON.stringify(state.favorites));
	}

	function confirmClear() {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';
        const isFavorite = state.favorites.some(p => p.name === state.currentPenpal.name);

        let message;
        if (!isRegistered) {
            message = "Demo mode is limited to a single conversation. Starting a new penpal will clear this one. Continue?";
        } else if (isFavorite) {
            message = "This will clear your current conversation but keep your penpal in favorites. Continue?";
        } else {
            message = "This will remove this penpal and all conversations. Continue?";
        }
		
	  if (confirm(message)) {
		clearCurrentPenpal(isFavorite);
	  }
	}

	function clearCurrentPenpal(keepInFavorites = false) {
		const penpalId = state.currentPenpal?.name;
		
		// Clear ALL images
		const gallery = document.getElementById('gallery-images');
		const thumbnails = document.getElementById('thumbnails');
		while (gallery.firstChild) {
			gallery.removeChild(gallery.firstChild);
		}
		while (thumbnails.firstChild) {
			thumbnails.removeChild(thumbnails.firstChild);
		}
		
		// Clear all state related to images
		state.images = [];
		state.currentImageIndex = 0;
		
		// Add these two lines to clear TTS state
		state.currentLetterWords = null;
		state.currentLetterElement = null;
		
		// Clear conversation
		if (penpalId && state.conversations[penpalId]) {
			delete state.conversations[penpalId];
			localStorage.setItem('penpalConversations', JSON.stringify(state.conversations));
		}
		
		// Remove from favorites if not keeping
		if (!keepInFavorites && penpalId) {
			const index = state.favorites.findIndex(p => p.name === penpalId);
			if (index !== -1) {
				state.favorites.splice(index, 1);
				localStorage.setItem('favoritePenpals', JSON.stringify(state.favorites));
			}
		}
		
		document.getElementById('ai-letter').innerHTML = '';
		document.getElementById('user-letter').value = '';
		
		// Clear the signature input as well when fully clearing
		if (!keepInFavorites) {
			document.getElementById('signature-input').value = '';
			state.userName = '';
			state.userSignature = '';
			localStorage.removeItem('penpalSignature');
		}
	}

	function showPenpalList() {
        const isRegistered = localStorage.getItem('penpal-registered') === 'true';
        if (!isRegistered) return alert('Saving penpals is a premium feature. Register to unlock!');
		const listHTML = `
			<div class="penpal-list absolute right-0 top-0 bg-gray-800 p-4 rounded-lg shadow-lg">
				<h3 class="text-lg font-bold mb-4">Your Penpals</h3>
				<div class="penpal-entries space-y-2">
					${Object.entries(state.penpals).map(([id, penpal]) => `
						<div class="penpal-entry flex items-center gap-2 p-2 hover:bg-gray-700 rounded cursor-pointer"
							 onclick="loadPenpalConversation('${id}')">
							<img src="${penpal.portrait}" class="w-10 h-10 rounded-full object-cover">
							<div class="flex-1">
								<div class="font-bold">${penpal.name}</div>
								<div class="text-sm opacity-75">${penpal.location}</div>
							</div>
						</div>
					`).join('')}
				</div>
			</div>
		`;
		
		const container = document.createElement('div');
		container.innerHTML = listHTML;
		document.body.appendChild(container.firstChild);
	}

	// Add this to restore a previous conversation
	async function loadPenpalConversation(penpalId) {
		const penpal = state.penpals[penpalId];
		if (!penpal) return;
		
		clearCurrentPenpal();
		state.currentPenpal = penpal;
		
		// Restore images
		if (penpal.portrait) addImage(penpal.portrait, `${penpal.name}'s Portrait`, true);
		if (penpal.locationImage) addImage(penpal.locationImage, `View from ${penpal.location}`, false);
		
		// Restore last letter
		if (penpal.lastLetter) {
			await writeLetter(penpal.lastLetter, true);
		}
	}

	async function generateNewPenpal(preferences = null) {
		const isRegistered = localStorage.getItem('penpal-registered') === 'true';
        
		if (!isRegistered) {
            
             // Check if they already have a penpal
			if (Object.keys(state.conversations).length >= DEMO_RESTRICTIONS.maxConversations) {
                //Prevent message from showing on load
                if(document.getElementById('app').style.display !== 'grid'){
				    alert('Demo mode is limited to one penpal at a time. Register to unlock unlimited penpals!');
                }
				return;
			}
			
			// Force demo settings
			Object.keys(DEMO_RESTRICTIONS.availableTraits).forEach(category => {
				state.currentSelection[category] = DEMO_RESTRICTIONS.availableTraits[category][0];
			});
		}

        //Ensure only one is loaded even after refresh
        if (!isRegistered && Object.keys(state.conversations).length > 0) {
            console.warn('User is not registered and has a conversation saved, clearing.')
            state.conversations = {}
            localStorage.setItem('penpalConversations', JSON.stringify(state.conversations));
        }
        

		clearCurrentPenpal();
		document.getElementById('gallery-images').innerHTML = '';
		document.getElementById('thumbnails').innerHTML = '';
		document.getElementById('ai-letter').innerHTML = '';
		document.getElementById('user-letter').value = '';
		
		state.images = [];
		state.currentImageIndex = 0;
		
		const loadingMessage = document.createElement('div');
		loadingMessage.className = 'loading-message';
		loadingMessage.textContent = 'Meeting someone new...';
		document.getElementById('ai-letter').appendChild(loadingMessage);
		
		try {
			// Get current selections
			const gender = state.currentSelection.gender;
			const age = state.currentSelection.age;
			const personality = state.currentSelection.personality;
			const location = state.currentSelection.location;
			const relationship = state.currentSelection.relationship;
			
			// Create detailed character prompt that enforces selected traits
			const prompt = `Create a penpal character with EXACTLY these traits:
				- Gender: ${gender.toLowerCase()}
				- Age: ${age} years old
				- Personality: ${personality.toLowerCase()}
				- Location Type: ${location.toLowerCase()}
				- Relationship Sought: ${relationship.toLowerCase()}
				- Name: Must generate a specific unique ${gender.toLowerCase()} first name suitable to character's background

				For location, generate a RANDOM specific place based on the location type:
				- If FOREIGN: Pick a random non-US country and city (e.g. Japan-Tokyo, France-Paris, Brazil-Rio)
				- If CROSS COUNTRY: Pick a random US state and city (e.g. Florida-Miami, Oregon-Portland)
				- If LOCAL: Pick a random neighborhood type and setting (e.g. suburban cul-de-sac, downtown apartment)

				The character MUST be exactly as specified above. Format response as JSON with properties: 
				name, age, location, bio, writingStyle, interests.
				
				For age ${age}, ensure interests and writing style are age-appropriate.
				${relationship === 'ROMANTIC' ? 'Keep any romantic elements strictly platonic and penpal-appropriate.' : ''}`;
				
			const response = await fetch(`https://text.pollinations.ai/prompt/${encodeURIComponent(prompt)}?json=true&private=true&seed=${Math.random()}`);
			const data = await response.json();
			
			// Build image prompt that reflects exact traits with more natural phrasing
			const normalizedGender = gender.toUpperCase();

			let portraitPrompt;
			if (age === '16-20') {
				portraitPrompt = `${normalizedGender === 'MALE' ? 'teenage male student' : 'teenage female student'} portrait, 
					${personality.toLowerCase() === 'shy' ? 'gentle smile' : 
					  personality.toLowerCase() === 'outgoing' ? 'bright smile' :
					  personality.toLowerCase() === 'smart' ? 'studious expression' :
					  personality.toLowerCase() === 'curious' ? 'engaged expression' : 'friendly smile'},
					natural indoor lighting, casual attire, yearbook style photo`;
			} else {
				portraitPrompt = `${normalizedGender === 'MALE' ? 'male' : 'female'} portrait, 
					age range ${age}, casual attire,
					natural lighting, professional headshot`;
			}
			
			const locationPrompt = `${
				location === 'CROSS COUNTRY' ? 'American suburban home with neighborhood background' : 
				location === 'LOCAL' ? 'detailed view of a cozy home interior' : 
				'characteristic home or dwelling from foreign country'
			}, ${
				personality.toLowerCase() === 'outgoing' ? 'warm and inviting' :
				personality.toLowerCase() === 'shy' ? 'peaceful and quiet' :
				personality.toLowerCase() === 'smart' ? 'organized and studious' :
				'comfortable and personal'
			}, natural lighting, detailed view`;
			
			const needsSafeFlag = age === '16-20';
			let portraitUrl = null;
			let locationUrl = null;
			
			// Try up to 3 times to get each image
			for(let attempt = 0; attempt < 3; attempt++) {
				try {
					if (!portraitUrl) {
						const safetyParam = needsSafeFlag ? '&safe=true' : '';
						const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(portraitPrompt)}?nologo=true&private=true&enhance=false${safetyParam}&seed=${Math.random()}`;
						const response = await fetch(url);
						const contentType = response.headers.get('content-type');
						if (!contentType.includes('text')) {
							portraitUrl = url;
						}
					}
					
					if (!locationUrl) {
						const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(locationPrompt)}?nologo=true&private=true&enhance=false&seed=${Math.random()}`;
						const response = await fetch(url);
						const contentType = response.headers.get('content-type');
						if (!contentType.includes('text')) {
							locationUrl = url;
						}
					}
					
					if (portraitUrl && locationUrl) break;
				} catch (error) {
					console.error('Error fetching image:', error);
				}
			}
			
			// Make sure penpals exists in state
			if (!state.penpals) {
				state.penpals = {};
			}

			// Create unique ID for new penpal
			const penpalId = Date.now().toString();
			
			// Save penpal data first
			state.penpals[penpalId] = {
				...data,
				id: penpalId,
				portrait: portraitUrl,
				locationImage: locationUrl,
				traits: {
					gender,
					age,
					personality,
					location,
					relationship
				},
				conversations: []
			};
			
			// Set as current penpal
			state.currentPenpal = state.penpals[penpalId];
			
			// Add images to display
			if (portraitUrl) addImage(portraitUrl, `Portrait`, true);
			if (locationUrl) addImage(locationUrl, `Location View`, false);
			
			// Ensure letter prompt maintains character consistency
			const letterPrompt = `As a ${age} year old ${gender.toLowerCase()} who is ${personality.toLowerCase()},
				write a first letter to a new penpal. You MUST start with exactly the text "Dear Penpal," followed by introducing yourself and your name, ${data.name}.
				Share your enthusiasm for starting this correspondence and include details about your life in ${data.location}.
				${relationship === 'ROMANTIC' ? 'Keep tone friendly but appropriate for penpal correspondence.' : ''}
				Write in character matching your age and personality traits exactly.
				Do not address the recipient by name as you haven't learned it yet.`;
				
			const letterResponse = await fetch(`https://text.pollinations.ai/prompt/${encodeURIComponent(letterPrompt)}?json=false&private=true&seed=${Math.random()}`);
			const greeting = await letterResponse.text();

			console.log('Letter response status:', letterResponse.status);
			console.log('Letter content:', greeting);

			if (!greeting || greeting.trim() === '') {
				document.getElementById('ai-letter').innerHTML = 'Failed to generate letter. Please try again.';
				return;
			}

			saveConversation({
				content: greeting,
				from: data.name,
				timestamp: Date.now()
			}, true);

			state.penpals[penpalId].lastLetter = greeting;
			localStorage.setItem('penpals', JSON.stringify(state.penpals));

			document.getElementById('ai-letter').innerHTML = '';
			await writeLetter(greeting, true);
			
			return state.penpals[penpalId];
		} catch (error) {
			console.error('Error generating penpal:', error);
			loadingMessage.textContent = 'Error meeting someone new. Please try again.';
		}
	}

	async function writeLetter(content, isAI = true, polaroid = null) {
        const letterElement = document.getElementById(isAI ? 'ai-letter' : 'user-letter');
        
        if (isAI) {
            letterElement.innerHTML = '';
            state.isWriting = true;

            // AI uses personality-based style
            const style = (() => {
                const personality = state.currentPenpal.traits.personality.toLowerCase();
                const age = state.currentPenpal.traits.age;
                
                if (age === '16-20') {
                    if (personality === 'shy') return 'neat';
                    if (personality === 'outgoing') return 'bold';
                    if (personality === 'smart') return 'formal';
                    return 'casual';
                } else {
                    if (personality === 'formal') return 'formal';
                    if (personality === 'outgoing') return 'casual';
                    return 'neat';
                }
            })();
            
            letterElement.className = `letter-content handwriting-${style}`;

			// Store words for TTS
			const words = content.split(' ');
			state.currentLetterWords = words;
			state.currentLetterElement = letterElement;

			// Add text content as spans
			words.forEach(word => {
				const wordSpan = document.createElement('span');
				wordSpan.className = 'tts-word';
				wordSpan.textContent = word + ' ';
				letterElement.appendChild(wordSpan);
			});

            // Add polaroid separately if exists
            if (polaroid) {
                const polaroidContainer = document.createElement('div');
                polaroidContainer.innerHTML = polaroid;
                letterElement.appendChild(polaroidContainer);
            }

            state.isWriting = false;
        } else {
            // For user writing, use selected style from dropdown
            const userStyle = document.getElementById('handwriting-style').value;
            document.getElementById('user-letter').className = 
                `w-full h-full bg-transparent handwriting-${userStyle} resize-none focus:outline-none p-4`;
        }
    }

	function startReading() {
	  if (!('speechSynthesis' in window)) return;
	  
	  const words = document.querySelectorAll('.tts-word');
	  let currentIndex = 0;

	  // Show play controls
	  document.querySelector('.start-reading').classList.add('hidden');
	  document.querySelector('.pause-reading').classList.remove('hidden');
	  document.querySelector('.stop-reading').classList.remove('hidden');

	  const content = state.currentLetterWords.join(' ');
	  currentUtterance = new SpeechSynthesisUtterance(content);
	  currentUtterance.rate = 0.9;

	  currentUtterance.onboundary = (event) => {
		if (event.name === 'word') {
		  words.forEach(el => {
			el.classList.remove('highlight');
			el.classList.remove('opacity-0');
		  });
		  if (words[currentIndex]) {
			words[currentIndex].classList.add('highlight');
			words[currentIndex].classList.remove('opacity-0');
			currentIndex++;
		  }
		}
	  };

	  currentUtterance.onend = () => {
		words.forEach(el => {
		  el.classList.remove('highlight');
		  el.classList.remove('opacity-0');
		});
		document.querySelector('.start-reading').classList.remove('hidden');
		document.querySelector('.pause-reading').classList.add('hidden');
		document.querySelector('.stop-reading').classList.add('hidden');
	  };

	  window.speechSynthesis.speak(currentUtterance);
	}

	function pauseReading() {
	  window.speechSynthesis.pause();
	  document.querySelector('.pause-reading').innerHTML = '<i class="fas fa-play"></i>';
	  document.querySelector('.pause-reading').onclick = resumeReading;
	}

	function resumeReading() {
	  window.speechSynthesis.resume();
	  document.querySelector('.pause-reading').innerHTML = '<i class="fas fa-pause"></i>';
	  document.querySelector('.pause-reading').onclick = pauseReading;
	}

	function stopReading() {
	  window.speechSynthesis.cancel();
	  document.querySelectorAll('.tts-word').forEach(el => {
		el.classList.remove('highlight');
		el.classList.remove('opacity-0');
	  });
	  document.querySelector('.start-reading').classList.remove('hidden');
	  document.querySelector('.pause-reading').classList.add('hidden');
	  document.querySelector('.stop-reading').classList.add('hidden');
	}

		function saveConversation(messageData, isAI) {
		  const penpalId = state.currentPenpal.id; // Use ID instead of name
		  if (!state.conversations[penpalId]) {
			state.conversations[penpalId] = [];
		  }

		  state.conversations[penpalId].push({
			...messageData,
			isAI
		  });

		  localStorage.setItem('penpalConversations', JSON.stringify(state.conversations));
		}
	
	console.log('Current Penpal:', state.currentPenpal);

    function generateRandomSelections() {
		const isRegistered = localStorage.getItem('penpal-registered') === 'true';
		
		// Force demo settings if not registered
		if (!isRegistered) {
			// Always set to these specific demo values
			state.currentSelection = {
				gender: 'FEMALE',
				age: '21-34',
				personality: 'CURIOUS',
				location: 'CROSS COUNTRY',
				relationship: 'FRIEND'
			};
			
			// Update UI to show these fixed values
			Object.keys(state.currentSelection).forEach(category => {
				const element = document.getElementById(`${category}-value`);
				if (element) {
					element.textContent = state.currentSelection[category];
				}
			});
		} else {
			// Only do random selection if registered
			Object.keys(state.preferences).forEach(category => {
				const options = state.preferences[category];
				const randomIndex = Math.floor(Math.random() * options.length);
				state.currentSelection[category] = options[randomIndex];
				
				const element = document.getElementById(`${category}-value`);
				if (element) {
					element.textContent = state.currentSelection[category];
				}
			});
		}
	}

	document.addEventListener('DOMContentLoaded', () => {
		// Generate random selections immediately when DOM is ready
		generateRandomSelections();
	});

	async function sendLetter() {
		const userInput = document.getElementById('user-letter').value.trim();
		const signature = document.getElementById('signature-input').value;

		if (!state.currentPenpal) {
			console.error("No penpal is active. Cannot send letter.");
			return;
		}
		
		if (!userInput || state.isWriting || !signature) {
			if (!signature) {
				document.getElementById('signature-input').classList.add('signature-required');
				alert('Please sign your letter!');
			}
			if (!userInput) {
				alert('Please write a letter before sending!');
			}
			return;
		}
		
		// Update signature state when sending letter
		updateSignature(signature);
		
		// Add signature to user's letter
		const signedLetter = `${userInput}\n\nBest regards,\n${signature}`;
		document.getElementById('user-letter').value = '';
		const userSection = document.getElementById('userSection');
		userSection.classList.remove('expanded');
		
		// Save user's letter to conversation
		saveConversation({
			content: signedLetter,
			from: signature,
			timestamp: Date.now()
		}, false);

		try {
			// Show loading state
			document.getElementById('ai-letter').innerHTML = '<div class="loading-message">Your penpal is writing back...</div>';
			
			const prompt = `You are ${state.currentPenpal.name}, a ${state.currentPenpal.traits.age} year old ${state.currentPenpal.traits.gender.toLowerCase()} 
				from ${state.currentPenpal.location} who is ${state.currentPenpal.traits.personality.toLowerCase()}. 
				Using your background: ${state.currentPenpal.bio} and writing style: ${state.currentPenpal.writingStyle},
				write a personal letter responding to: "${signedLetter}".
				Start with exactly "Dear ${signature}," and maintain consistent personality throughout.`;
			
			const response = await fetch(`https://text.pollinations.ai/prompt/${encodeURIComponent(prompt)}?json=false&private=true&seed=${Math.random()}`);
			let aiResponse = await response.text();

			let polaroid = null;

			// Occasionally generate a new image to share (30% chance)
			if (Math.random() > 0.7 && state.images.length < 5) { // Limit max images
				const promptForImageIdea = `As ${state.currentPenpal.name} writing to ${signature}, 
					what specific thing in your life or surroundings would you want to share a photo of right now? 
					Consider pets, objects, places, or activities mentioned in your conversation.
					Respond with only a brief, specific photo description.`;

				const imageIdeaResponse = await fetch(`https://text.pollinations.ai/prompt/${encodeURIComponent(promptForImageIdea)}?json=false&private=true&seed=${Math.random()}`);
				const imageIdea = await imageIdeaResponse.text();

				const imagePrompt = `Clear, detailed photo of ${imageIdea}, photographic style`;
				
				let imageUrl = null;
				
				// Try up to 3 times to get a safe image
				for(let attempt = 0; attempt < 3; attempt++) {
					try {
						const needsSafeFlag = state.currentPenpal.traits.age === '16-20';
						const safetyParam = needsSafeFlag ? '&safe=true' : '';
						const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(imagePrompt)}?nologo=true&private=true&enhance=false${safetyParam}&seed=${Math.random()}`;
						const imgResponse = await fetch(url);
						const contentType = imgResponse.headers.get('content-type');
						
						if (!contentType.includes('text')) {
							imageUrl = url;
							break;
						}
					} catch (error) {
						console.error('Error fetching image:', error);
					}
				}
				
				if (imageUrl) {
					addImage(imageUrl, state.currentPenpal.name + "'s photo");
					const casualCaptions = [
						"Thought you'd like this!",
						"Check this out!",
						"A little snapshot for you",
						"Something special to share",
						"Just wanted to show you"
					];
					const randomCaption = casualCaptions[Math.floor(Math.random() * casualCaptions.length)];
					polaroid = addPolaroidToLetter(imageUrl, randomCaption);
				}
			}

			// Save AI's response to conversation
			saveConversation({
				content: aiResponse,
				from: state.currentPenpal.name,
				timestamp: Date.now()
			}, true);
			
			// Update penpal's last letter in state
			if (state.currentPenpal.id && state.penpals[state.currentPenpal.id]) {
				state.penpals[state.currentPenpal.id].lastLetter = aiResponse;
				localStorage.setItem('penpals', JSON.stringify(state.penpals));
			}
			
			await writeLetter(aiResponse, true, polaroid);
		} catch (error) {
			console.error('Error generating response:', error);
			document.getElementById('ai-letter').innerHTML = '<div class="error-message">Sorry, there was an error sending your letter. Please try again.</div>';
		}
	}

	window.onload = async () => {
		// Modal setup
		const modal = document.getElementById('register-modal');
		const closeBtn = document.querySelector('.close');
		const submitBtn = document.getElementById('submit-code');
		const codeInput = document.getElementById('unlock-code');
		const errorText = document.getElementById('code-error');
		const registerBtn = document.getElementById('register-btn');
		const isRegistered = localStorage.getItem('penpal-registered') === 'true';

		if (isRegistered) {
			registerBtn.textContent = 'REGISTERED';
			registerBtn.classList.add('registered');
		} else {
            //Disable navigation buttons in demo
            document.querySelector('.show-penpals-btn').style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
            document.querySelector('.show-penpals-btn').style.cursor = 'not-allowed';
            document.querySelector('.show-penpals-btn').disabled = true;
            document.querySelector('.gallery-controls button:first-child').style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
            document.querySelector('.gallery-controls button:first-child').style.cursor = 'not-allowed';
            document.querySelector('.gallery-controls button:first-child').disabled = true;
            document.querySelector('.gallery-controls button:last-child').style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
            document.querySelector('.gallery-controls button:last-child').style.cursor = 'not-allowed';
            document.querySelector('.gallery-controls button:last-child').disabled = true;
			// Disable all arrow buttons and add lock message
			document.querySelectorAll('.arrow-btn').forEach(btn => {
				btn.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
				btn.style.cursor = 'not-allowed';
				btn.disabled = true;
				btn.onclick = (e) => {
					e.preventDefault();
					alert('Demo mode is limited to default penpal options. Register to unlock all choices!');
				};
			});
		}		
		
		// Registration modal handlers
		registerBtn.onclick = () => {
			if (isRegistered) {
				document.getElementById('registration-view').style.display = 'none';
				document.getElementById('registered-view').style.display = 'block';
				document.getElementById('current-code').textContent = 
					localStorage.getItem('penpal-unlock-code') || 'Unknown';
			} else {
				document.getElementById('registration-view').style.display = 'block';
				document.getElementById('registered-view').style.display = 'none';
			}
			modal.style.display = 'block';
		};

		// Get code button handler
		document.getElementById('get-code-btn').onclick = () => {
			const code = generateUnlockCode();
			document.getElementById('unlock-code').value = code;
		};

		// Donation buttons
		document.getElementById('donate-btn').onclick = 
		document.getElementById('donate-btn-reg').onclick = () => {
			window.open('https://paypal.me/ReverendDrTolerant?country.x=US&locale.x=en_US', '_blank');
		};

		// Return to demo handler
		document.getElementById('return-to-demo').onclick = () => {
			if(confirm('Are you sure you want to return to demo mode? You can always register again later.')) {
				localStorage.removeItem('penpal-registered');
				localStorage.removeItem('penpal-unlock-code');
				window.location.reload();
			}
		};

		// Modal close handlers
		closeBtn.onclick = () => {
			modal.style.display = 'none';
			codeInput.value = '';
			errorText.textContent = '';
		};

		window.onclick = (event) => {
			if (event.target === modal) {
				modal.style.display = 'none';
				codeInput.value = '';
				errorText.textContent = '';
			}
		};

		// Code input formatting
		codeInput.addEventListener('input', (e) => {
			e.target.value = e.target.value.toUpperCase();
		});

		// Submit code handler
		submitBtn.onclick = () => {
			const code = codeInput.value.toUpperCase();
			if (!isValidFormat(code)) {
				errorText.textContent = 'Code must be 6 alphanumeric characters';
				return;
			}
			if (isTooSimple(code)) {
				errorText.textContent = 'Invalid code format. Try something more complex.';
				return;
			}
			localStorage.setItem('penpal-registered', 'true');
			localStorage.setItem('penpal-unlock-code', code);
			window.location.reload();
		};

		// Add TTS control listeners
		document.querySelector('.start-reading').addEventListener('click', startReading);
		document.querySelector('.pause-reading').addEventListener('click', pauseReading);
		document.querySelector('.stop-reading').addEventListener('click', stopReading);

		// Button handlers
        document.querySelector('.new-penpal-btn').addEventListener('click', () => {
            const isRegistered = localStorage.getItem('penpal-registered') === 'true';

            if (!isRegistered) {
                alert('Demo mode is limited to one penpal type. Register to unlock all penpal options!');
                return;
            }
           startNewPenpal();
        });
        
		if (!isRegistered) {
			const newPenpalBtn = document.querySelector('.new-penpal-btn');
			newPenpalBtn.innerHTML = '<i class="fas fa-lock"></i> Unlock More Penpals';
			newPenpalBtn.style.backgroundColor = '#6c5ce7';
            newPenpalBtn.disabled = true;
            newPenpalBtn.style.cursor = 'not-allowed';
		}
		
		document.querySelector('.favorite-btn').addEventListener('click', toggleFavorite);
		document.querySelector('.clear-btn').addEventListener('click', confirmClear);
		document.querySelector('.show-penpals-btn').addEventListener('click', togglePenpalList);
		document.querySelector('.gallery-control.expand').addEventListener('click', toggleGallerySize);
		document.querySelector('.dock-button').addEventListener('click', toggleDock);
		

		// Main buttons
		document.getElementById('write-penpal').addEventListener('click', startPenpalExperience);
		document.getElementById('random-penpal').addEventListener('click', () => {
            const isRegistered = localStorage.getItem('penpal-registered') === 'true';
			if (!isRegistered) {
				alert('Random penpal selection is a premium feature. Register to unlock!');
				return;
			}
			generateRandomSelections();
			setTimeout(() => {
				startPenpalExperience();
			}, 50);
		});
		
		document.querySelector('.send-letter-btn').addEventListener('click', sendLetter);
		
		// Handwriting style initialization
		document.getElementById('handwriting-style').value = state.userHandwritingStyle;
		document.getElementById('handwriting-style').addEventListener('change', (e) => {
            const isRegistered = localStorage.getItem('penpal-registered') === 'true';
			if (!isRegistered) {
				alert('Handwriting styles are a premium feature. Register to unlock!');
				e.target.value = 'casual';
				return;
			}
			state.userHandwritingStyle = e.target.value;
			localStorage.setItem('userHandwritingStyle', e.target.value);
		});
        
		// Load a default penpal for demo users if they don't already have one
		const isRegisteredOnLoad = localStorage.getItem('penpal-registered') === 'true';
		if(!isRegisteredOnLoad) {
			if(Object.keys(state.conversations).length === 0) {
				await generateNewPenpal(state.currentSelection);
			}
			startPenpalExperience();
		} else {
			// For registered users, just show the selector
			document.getElementById('app').style.display = 'none';
			document.getElementById('initial-selector').style.display = 'block';
		}

		// Initially hide the app container
		document.getElementById('app').style.display = 'none';

		// Selector arrows initialization
		document.querySelectorAll('.selector-row').forEach(row => {
			const category = row.querySelector('.label').textContent.toLowerCase();
			row.querySelector('button:first-child').addEventListener('click', () => cycleOption(category, 'prev'));
			row.querySelector('button:last-child').addEventListener('click', () => cycleOption(category, 'next'));
		});

		// Show premium info if not registered
		if (!isRegistered) {
			const aiLetter = document.getElementById('ai-letter');
			if (!aiLetter.innerHTML.trim()) {
				aiLetter.innerHTML = `
					<div class="premium-info">
						<p class="premium-header">🔓 Unlock Premium Features:</p>
						<ul class="premium-features">
							<li>✨ Unlimited Conversations</li>
							<li>🌍 More Locations & Personalities</li>
							<li>🎭 All Age Groups & Relationship Types</li>
							<li>📸 Unlimited Photo Sharing</li>
							<li>💌 Save All Your Letters</li>
						</ul>
						<p class="premium-note">Get your free unlock code to access all features!</p>
					</div>
				`;
			}
		}
        
        // Generate random selections on initial load
        generateRandomSelections();
	};
  </script>
</body>
</html>