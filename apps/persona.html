<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonaLens - AI-Powered Personality & Compatibility Tests</title>
	
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --secondary-light: #f472b6;
            --tertiary: #14b8a6;
            --bg-dark: #1e293b;
            --bg-light: #334155;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            --card-bg: #1e293b;
            --card-bg-hover: #273344;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-light));
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            text-align: center;
            padding: 2rem 0;
            position: relative;
        }

        header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
        }

        header p {
            font-size: 1.2rem;
            color: var(--text-muted);
            max-width: 700px;
            margin: 0 auto;
        }

		.results-grid {
		  display: flex;
		  flex-direction: column;
		  gap: 2rem;
		  max-width: 800px;
		  margin: 0 auto;
		}

		.results-chart {
		  background-color: rgba(255, 255, 255, 0.05);
		  border-radius: 12px;
		  padding: 1.5rem;
		  height: 350px;
		}

		.results-list {
		  display: flex;
		  flex-direction: column;
		  gap: 1rem;
		}

		.result-bar-item {
		  display: flex;
		  align-items: center;
		  gap: 1rem;
		}

		.result-bar-label {
		  width: 150px;
		  text-align: right;
		  font-weight: 600;
		  color: var(--text-light);
		}

		.result-bar-track {
		  flex-grow: 1;
		  height: 30px;
		  background-color: rgba(255, 255, 255, 0.1);
		  border-radius: 15px;
		  overflow: hidden;
		}

		.result-bar-fill {
		  height: 100%;
		  background: linear-gradient(to right, var(--primary), var(--secondary));
		  border-radius: 15px;
		  display: flex;
		  align-items: center;
		  justify-content: flex-end;
		  padding-right: 10px;
		  transition: width 1s ease-out;
		}

		.result-bar-value {
		  color: white;
		  font-weight: 700;
		}

		/* Update the result-image styling to constrain the image size properly */
		.result-image img {
		  width: 100%;
		  max-width: 800px;
		  max-height: 450px;
		  object-fit: cover;
		  border-radius: 12px;
		  margin: 0 auto 2rem auto;
		  display: block;
		  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
		  transition: transform 0.3s ease;
		}

		/* Improve the chat container to take up more space */
		.chat-container {
		  margin-top: 2rem;
		  background-color: rgba(255, 255, 255, 0.05);
		  border-radius: 12px;
		  padding: 1.5rem;
		  max-width: 800px;
		  margin-left: auto;
		  margin-right: auto;
		}

		.chat-messages {
		  max-height: 400px; /* Increased height */
		  overflow-y: auto;
		  margin-bottom: 1rem;
		  padding: 1rem;
		}

		/* Make the analysis text more readable and compact */
		.analysis-container {
		  max-width: 800px;
		  margin: 0 auto 2rem auto;
		}

		.analysis-text {
		  line-height: 1.7;
		  max-height: 300px;
		  overflow-y: auto;
		  padding-right: 1rem;
		}

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-light);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .badge svg {
            width: 14px;
            height: 14px;
            margin-right: 0.25rem;
        }

        .section {
            margin-bottom: 3rem;
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-light);
            display: flex;
            align-items: center;
        }

        .section-title svg {
            margin-right: 0.75rem;
            width: 24px;
            height: 24px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            height: 100%;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background-color: var(--card-bg-hover);
        }

        .card-border-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .border-primary {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
        }

        .border-secondary {
            background: linear-gradient(to right, var(--secondary), var(--secondary-light));
        }

        .border-tertiary {
            background: linear-gradient(to right, var(--tertiary), var(--tertiary-light));
        }

        .border-accent {
            background: linear-gradient(to right, var(--accent), var(--success));
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .test-card {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .test-card h3 {
            font-size: 1.4rem;
            margin-bottom: 0.75rem;
            color: var(--text-light);
        }

        .test-card p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }

        .test-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .test-meta {
            font-size: 0.875rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }

        .test-meta svg {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn svg {
            width: 18px;
            height: 18px;
            margin-left: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: #d6409f;
        }

        .btn-tertiary {
            background-color: var(--tertiary);
        }

        .btn-tertiary:hover {
            background-color: #0ea5a5;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 2.5rem;
        }

        .feature-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-5px);
            background-color: rgba(255, 255, 255, 0.08);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
        }

        .feature-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .feature-item h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .feature-item p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .welcome-screen, .test-selection, .test-content, .test-results {
            display: none;
        }

        .active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

.test-results .container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1rem;
}

.results-header {
  margin-bottom: 1.5rem;
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.header-top h1 {
  font-size: 1.8rem;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  margin: 0;
}

.results-header h2 {
  font-size: 1.6rem;
  margin-top: 0.5rem;
  color: var(--text-light);
}

.result-image img {
  width: 100%;
  max-width: 1000px;
  height: 320px;
  object-fit: cover;
  border-radius: 12px;
  margin: 0 auto 1.5rem auto;
  display: block;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.results-content-section {
  background-color: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
}

.analysis-audio {
  margin-bottom: 1.5rem;
}

.audio-player {
  width: 100%;
  border-radius: 8px;
  background-color: rgba(255, 255, 255, 0.1);
}

.analysis-text {
  color: var(--text-muted);
  line-height: 1.7;
  margin-bottom: 1.5rem;
  max-height: 350px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

.btn-container {
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.chat-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 1rem;
}

.chat-container {
  background-color: var(--bg-dark);
  border-radius: 12px;
  width: 100%;
  max-width: 800px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-header h3 {
  margin: 0;
  color: var(--text-light);
}

.chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  min-height: 300px;
  max-height: 50vh;
}

.chat-input-container {
  padding: 1rem 1.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  gap: 1rem;
}

.chat-input {
  flex-grow: 1;
  background-color: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  color: var(--text-light);
}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Question styles */
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .question-container {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .question-container h3 {
            font-size: 1.6rem;
            margin-bottom: 2rem;
            line-height: 1.4;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .option {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .option:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .option.selected {
            background-color: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
        }

        .option.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .btn-container {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Results styles */
        .results-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .results-header h2 {
            font-size: 2.2rem;
            margin-bottom: 1rem;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .results-header p {
            color: var(--text-muted);
            max-width: 700px;
            margin: 0 auto;
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-5px);
            background-color: rgba(255, 255, 255, 0.08);
        }

        .result-item h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .result-item .score {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 1rem 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .result-item p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .result-image img {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .result-image img:hover {
            transform: scale(1.02);
        }

        .result-audio {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-chart {
            height: 300px;
            margin: 2rem 0;
        }

        .analysis-container {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .analysis-container h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-light);
        }

        .analysis-text {
            color: var(--text-muted);
            line-height: 1.8;
            white-space: pre-line;
        }

		.score-summary {
		  display: flex;
		  flex-direction: column;
		  gap: 1rem;
		  max-width: 800px;
		  margin: 0 auto 2rem auto;
		  background-color: rgba(255, 255, 255, 0.05);
		  border-radius: 12px;
		  padding: 1.5rem;
		}

		.score-bar-item {
		  display: flex;
		  align-items: center;
		  gap: 1rem;
		}

		.score-bar-label {
		  width: 180px;
		  text-align: right;
		  font-weight: 600;
		  color: var(--text-light);
		  font-size: 0.95rem;
		}

		.score-bar-track {
		  flex-grow: 1;
		  height: 24px;
		  background-color: rgba(255, 255, 255, 0.1);
		  border-radius: 12px;
		  overflow: hidden;
		}

		.score-bar-fill {
		  height: 100%;
		  background: linear-gradient(to right, var(--primary), var(--secondary));
		  border-radius: 12px;
		  display: flex;
		  align-items: center;
		  justify-content: flex-end;
		  padding-right: 10px;
		  transition: width 1s ease-out;
		}

		.score-bar-value {
		  color: white;
		  font-weight: 700;
		  font-size: 0.9rem;
		}

        /* Chat interface */
		.chat-overlay {
		  display: none;
		  position: fixed;
		  top: 0;
		  left: 0;
		  width: 100%;
		  height: 100%;
		  background-color: rgba(0, 0, 0, 0.7);
		  z-index: 1000;
		  justify-content: center;
		  align-items: center;
		  padding: 1rem;
		}

		.chat-container {
		  background-color: var(--bg-dark);
		  border-radius: 12px;
		  width: 100%;
		  max-width: 800px;
		  max-height: 80vh;
		  display: flex;
		  flex-direction: column;
		  box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
		}

		.chat-header {
		  display: flex;
		  justify-content: space-between;
		  align-items: center;
		  padding: 1rem 1.5rem;
		  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.chat-header h3 {
		  margin: 0;
		  color: var(--text-light);
		}

		.chat-messages {
		  flex-grow: 1;
		  overflow-y: auto;
		  padding: 1.5rem;
		  display: flex;
		  flex-direction: column;
		  gap: 1rem;
		  min-height: 300px;
		  max-height: 50vh;
		}

		.chat-input-container {
		  padding: 1rem 1.5rem;
		  border-top: 1px solid rgba(255, 255, 255, 0.1);
		  display: flex;
		  gap: 1rem;
		}

		.chat-input {
		  flex-grow: 1;
		  background-color: rgba(255, 255, 255, 0.1);
		  border: 1px solid rgba(255, 255, 255, 0.2);
		  border-radius: 8px;
		  padding: 0.75rem 1rem;
		  color: var(--text-light);
		}

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-message {
            margin-bottom: 1rem;
            display: flex;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 1rem;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background-color: var(--secondary);
        }

        .message-content {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            max-width: 80%;
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
        }

        .chat-input {
            flex-grow: 1;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            font-size: 1rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Loading spinner */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(30, 41, 59, 0.8);
            z-index: 100;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-light);
            text-align: center;
        }

		.score-summary {
		  display: flex;
		  flex-direction: column;
		  gap: 1rem;
		  max-width: 800px;
		  margin: 0 auto 2rem auto;
		  background-color: rgba(255, 255, 255, 0.05);
		  border-radius: 12px;
		  padding: 1.5rem;
		}

		.score-bar-item {
		  display: flex;
		  align-items: center;
		  gap: 1rem;
		}

		.score-bar-label {
		  width: 180px;
		  text-align: right;
		  font-weight: 600;
		  color: var(--text-light);
		  font-size: 0.95rem;
		}

		.score-bar-track {
		  flex-grow: 1;
		  height: 24px;
		  background-color: rgba(255, 255, 255, 0.1);
		  border-radius: 12px;
		  overflow: hidden;
		}

		.score-bar-fill {
		  height: 100%;
		  background: linear-gradient(to right, var(--primary), var(--secondary));
		  border-radius: 12px;
		  display: flex;
		  align-items: center;
		  justify-content: flex-end;
		  padding-right: 10px;
		  transition: width 1s ease-out;
		}

		.score-bar-value {
		  color: white;
		  font-weight: 700;
		  font-size: 0.9rem;
		}

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .grid, .grid-3, .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-header .btn {
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PersonaLens</h1>
            <p>Discover deeper insights through AI-powered personality tests and compatibility analyses.</p>
        </header>
        
        <div id="welcome-screen" class="welcome-screen active">
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        Featured Personality Tests
                    </h2>
                    <a href="#all-tests" class="btn btn-sm btn-outline">View All Tests</a>
                </div>
                <div class="grid">
                    <div class="card test-card" data-category="personality">
                        <div class="card-border-top border-primary"></div>
                        <h3>Core Personality Dimensions</h3>
                        <p>Discover your key personality traits and understand how they shape your interactions with others and your approach to life's challenges.</p>
                        <div class="test-card-footer">
                            <div class="test-meta">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                10-15 minutes
                            </div>
                            <button class="btn btn-sm">Start Test</button>
                        </div>
                    </div>
                    
                    <div class="card test-card" data-category="relationship">
                        <div class="card-border-top border-secondary"></div>
                        <h3>Relationship Compatibility</h3>
                        <p>Explore how you connect with others and identify potential strengths and growth areas in your relationships.</p>
                        <div class="test-card-footer">
                            <div class="test-meta">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                12-18 minutes
                            </div>
                            <button class="btn btn-sm btn-secondary">Start Test</button>
                        </div>
                    </div>
                    
                    <div class="card test-card" data-category="career">
                        <div class="card-border-top border-tertiary"></div>
                        <h3>Career Path Alignment</h3>
                        <p>Identify which career paths and work environments might be most fulfilling based on your unique traits and preferences.</p>
                        <div class="test-card-footer">
                            <div class="test-meta">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                10-15 minutes
                            </div>
                            <button class="btn btn-sm btn-tertiary">Start Test</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="section">
                <div class="card">
                    <h2 class="section-title">How It Works</h2>
                    <p>PersonaLens uses advanced AI to create personalized insights that are unique to each session. Every test experience is different, with questions and analyses tailored specifically to you.</p>
                    
                    <div class="feature-grid">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <h3>Dynamic Questions</h3>
                            <p>Our AI generates unique questions for every test session, ensuring fresh insights each time.</p>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                </svg>
                            </div>
                            <h3>Personalized Analysis</h3>
                            <p>Receive detailed insights about your personality traits, tendencies, and potential growth areas.</p>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                </svg>
                            </div>
                            <h3>Interactive Experience</h3>
                            <p>Discuss your results with our AI assistant to gain deeper understanding of your results.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        All Test Categories
                    </h2>
                </div>
                <div class="grid-3">
                    <div class="card test-card" data-category="personality">
                        <div class="card-border-top border-primary"></div>
                        <h3>Core Personality</h3>
                        <p>Explore your fundamental personality traits and tendencies.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="relationship">
                        <div class="card-border-top border-secondary"></div>
                        <h3>Relationship Styles</h3>
                        <p>Understand your approach to connections and partnerships.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="communication">
                        <div class="card-border-top border-tertiary"></div>
                        <h3>Communication Patterns</h3>
                        <p>Discover how you express yourself and receive information.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="emotional">
                        <div class="card-border-top border-accent"></div>
                        <h3>Emotional Intelligence</h3>
                        <p>Assess your ability to understand and manage emotions.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="decision">
                        <div class="card-border-top border-primary"></div>
                        <h3>Decision Making</h3>
                        <p>Learn about your approach to choices and judgment.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="stress">
                        <div class="card-border-top border-secondary"></div>
                        <h3>Stress Response</h3>
                        <p>Identify your patterns of handling pressure and challenges.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="career">
                        <div class="card-border-top border-tertiary"></div>
                        <h3>Career Alignment</h3>
                        <p>Find professional paths that match your natural inclinations.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="creativity">
                        <div class="card-border-top border-accent"></div>
                        <h3>Creative Thinking</h3>
                        <p>Explore your unique creative problem-solving approach.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                    
                    <div class="card test-card" data-category="learning">
                        <div class="card-border-top border-primary"></div>
                        <h3>Learning Style</h3>
                        <p>Understand how you best absorb and process information.</p>
                        <button class="btn btn-sm">Take Test</button>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Test Selection Screen -->
        <div id="test-selection" class="test-selection">
            <div class="card">
                <button class="btn btn-sm btn-outline" id="back-to-welcome">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16" style="margin-right: 0.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </button>
                
                <div class="section-header" style="margin-top: 1.5rem;">
                    <h2 class="section-title" id="test-category-title">Core Personality Test</h2>
                </div>
                
                <p class="test-description" id="test-category-description">
                    This test will help you understand your core personality traits, behaviors, and tendencies. Each question is uniquely generated by our AI to provide fresh insights with every session.
                </p>
                
                <div class="feature-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3>Duration</h3>
                        <p>10-15 minutes to complete the full assessment</p>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3>What You'll Learn</h3>
                        <p>Insights about your traits, behaviors, and tendencies</p>
                    </div>
                </div>
                
                <div class="btn-container">
                    <button class="btn" id="start-test-btn">Begin Assessment</button>
                </div>
            </div>
        </div>
        
        <!-- Test Content Screen -->
        <div id="test-content" class="test-content">
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                
                <div class="question-container" id="question-container">
                    <h3 id="question-text">Question will appear here</h3>
                    
                    <div class="options-container" id="options-container">
                        <!-- Options will be dynamically added here -->
                    </div>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-outline" id="back-btn">Back</button>
                    <button class="btn" id="next-btn" disabled>Next</button>
                </div>
            </div>
        </div>
        
        <!-- Test Results Screen -->
		<div id="test-results" class="test-results">
		  <div class="container">
			<header class="results-header">
			  <div class="header-top">
				<h1>PersonaLens</h1>
				<button class="btn btn-sm btn-outline" id="back-to-home">
				  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16" style="margin-right: 0.5rem;">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
				  </svg>
				  Back to Home
				</button>
			  </div>
			  <h2>Your Personalized Results</h2>
			</header>
			
			<div class="result-image" id="result-image">
			  <!-- Image will be dynamically added here -->
			</div>
			
			<div id="results-container">
			  <!-- Score bars will be added here -->
			</div>
			
			<div class="results-content-section">
			  <div class="analysis-audio">
				<audio controls id="analysis-audio" class="audio-player">
				  <source src="" type="audio/mpeg" id="audio-source">
				</audio>
			  </div>
			  
			  <div class="analysis-text" id="analysis-text">
				<!-- AI analysis will be placed here -->
			  </div>
			  
			  <div class="btn-container">
				<button class="btn" id="discuss-results-btn">Discuss My Results</button>
				<button class="btn btn-outline" id="new-test-btn">Take Another Test</button>
			  </div>
			</div>
			
			<div class="chat-overlay" id="chat-overlay">
			  <div class="chat-container" id="chat-container">
				<div class="chat-header">
				  <h3>Discuss Your Results With AI</h3>
				  <button class="btn btn-sm btn-outline" id="close-chat-btn">Close</button>
				</div>
				
				<div class="chat-messages" id="chat-messages">
				  <!-- Chat messages will appear here -->
				</div>
				
				<div class="chat-input-container">
				  <input type="text" class="chat-input" id="chat-input" placeholder="Ask a question about your results...">
				  <button class="btn" id="send-message-btn">Send</button>
				</div>
			  </div>
			</div>
		  </div>
		</div>
    </div>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // -------------------- App State --------------------
        const appState = {
            currentScreen: 'welcome-screen',
            selectedCategory: null,
            currentQuestionIndex: 0,
            selectedAnswer: null,
            questions: [],
            responses: {},
            aiConversationHistory: {
                system: {
                    role: "system",
                    content: "You are a thoughtful personality test analyzer that provides insightful, personalized analysis based on user responses. Your goal is to help the user understand themselves better through reflective, nuanced insights."
                },
                messages: [] // Will contain up to 10 AI and 10 User messages, oldest first
            }
        };

        // -------------------- Core API Functions --------------------
        const API = {
            // Generate image based on prompt
            async generateImage(prompt, options = {}) {
                const params = new URLSearchParams({
                    width: options.width || 1024,
                    height: options.height || 1024,
                    model: options.model || 'flux',
                    nologo: options.nologo || 'true',
                    private: options.private || 'true'
                });
                
                if (options.seed) params.append('seed', options.seed);
                if (options.enhance) params.append('enhance', 'true');
                
                const encodedPrompt = encodeURIComponent(prompt);
                const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?${params.toString()}`;
                
                console.log("Generating image with URL:", url);
                return url;
            },
            
            // Generate text using the API
            async generateText(messages, options = {}) {
                try {
                    console.log("Generating text with options:", options);
                    
                    const apiBody = {
                        model: 'openai',
                        messages: messages,
                        seed: options.seed || Math.floor(Math.random() * 1000000),
                        private: true
                    };
                    
                    // Add function calling if requested
                    if (options.tools) {
                        apiBody.tools = options.tools;
                        apiBody.tool_choice = options.toolChoice || "auto";
                    }
                    
                    const response = await fetch('https://text.pollinations.ai/openai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiBody),
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error("Text generation error:", error);
                    throw error;
                }
            },
            
            // Generate audio from text
			async generateAudio(text, options = {}) {
			  try {
				// First, we need to create a prompt that instructs the AI to read verbatim
				const instructionPrefix = "READ THIS TEXT VERBATIM WITHOUT ANY COMMENTARY OR RESPONSE: ";
				const textToRead = instructionPrefix + text;
				const encodedText = encodeURIComponent(textToRead);
				const voice = options.voice || 'nova';
				
				const url = `https://text.pollinations.ai/${encodedText}?model=openai-audio&voice=${voice}`;
				
				console.log("Generating audio with URL:", url);
				return url;
			  } catch (error) {
				console.error("Audio generation error:", error);
				return null;
			  }
			}
        };
		
// -------------------- Test Selection & Generation --------------------
        function selectTestCategory(category) {
            appState.selectedCategory = category;
            
            // Update category title and description
            const titleMap = {
                personality: "Core Personality Test",
                relationship: "Relationship Compatibility Test",
                communication: "Communication Patterns Test",
                emotional: "Emotional Intelligence Assessment",
                decision: "Decision-Making Style Test",
                stress: "Stress Response Assessment",
                career: "Career Path Alignment",
                creativity: "Creative Thinking Assessment",
                learning: "Learning Style Analysis"
            };
            
            const descriptionMap = {
                personality: "This test will help you understand your core personality traits, behaviors, and tendencies. Each question is uniquely generated by our AI to provide fresh insights with every session.",
                relationship: "Explore how you connect with others and identify potential strengths and growth areas in your relationships. Discover your relationship patterns and compatibility factors.",
                communication: "Understand your unique communication style, how you express yourself, and how you receive information from others. Learn about your strengths and potential blind spots.",
                emotional: "Assess your ability to recognize, understand, and manage emotions in yourself and others. Discover your emotional intelligence profile and areas for growth.",
                decision: "Explore how you make choices, weigh options, and commit to decisions. Understand your decision-making style and how it impacts your life and relationships.",
                stress: "Identify your typical responses to stress, pressure, and challenges. Learn about your coping mechanisms and how to build resilience.",
                career: "Discover which career paths and work environments align with your natural tendencies, values, and strengths. Find professional directions that could be most fulfilling.",
                creativity: "Explore your creative thinking patterns, innovation approaches, and unique perspective. Understand how you generate and develop ideas.",
                learning: "Identify how you best process, retain, and apply new information. Understand your learning preferences and how to optimize your educational experiences."
            };
            
            // Add duration information map
            const durationMap = {
                personality: "10-15 minutes",
                relationship: "12-18 minutes",
                communication: "8-12 minutes",
                emotional: "10-15 minutes",
                decision: "7-10 minutes",
                stress: "10-12 minutes",
                career: "10-15 minutes",
                creativity: "12-15 minutes",
                learning: "8-10 minutes"
            };
            
            document.getElementById('test-category-title').textContent = titleMap[category] || `${category.charAt(0).toUpperCase() + category.slice(1)} Test`;
            document.getElementById('test-category-description').textContent = descriptionMap[category] || `This test will help you understand your ${category} traits and tendencies.`;
            
            // Update the duration text in the feature item
            const durationText = document.querySelector('.test-selection .feature-item:first-child p');
            if (durationText) {
                durationText.textContent = `${durationMap[category] || "10-15 minutes"} to complete the full assessment`;
            }
            
            // Navigate to test selection screen
            navigateTo('test-selection');
        }

        // Generate questions for the test
        async function generateTestQuestions(category, count = 10) {
            showLoading("Generating your unique test questions...");
            
            try {
                // Use the create_questions function calling
                const questionsResponse = await API.generateText([
                    { 
                        role: 'system', 
                        content: `You are an expert at creating insightful personality test questions.` 
                    },
                    { 
                        role: 'user', 
                        content: `Create ${count} unique personality test questions about ${category}. For each question, provide exactly 4 answer options that represent different approaches or tendencies.` 
                    }
                ], {
                    tools: [
                        {
                            "type": "function",
                            "function": {
                                "name": "create_questions",
                                "description": "Create a set of personality test questions",
                                "parameters": {
                                    "type": "object",
                                    "properties": {
                                        "questions": {
                                            "type": "array",
                                            "items": {
                                                "type": "object",
                                                "properties": {
                                                    "question": {
                                                        "type": "string",
                                                        "description": "The question text"
                                                    },
                                                    "options": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "string"
                                                        },
                                                        "description": "Exactly 4 answer options"
                                                    },
                                                    "category": {
                                                        "type": "string",
                                                        "description": "The category of the question"
                                                    }
                                                },
                                                "required": ["question", "options"]
                                            }
                                        }
                                    },
                                    "required": ["questions"]
                                }
                            }
                        }
                    ],
                    toolChoice: "auto"
                });
                
                console.log("Questions API response:", questionsResponse);
                
                // Check if we got tool calls in the response
                if (questionsResponse.choices && 
                    questionsResponse.choices[0] && 
                    questionsResponse.choices[0].message && 
                    questionsResponse.choices[0].message.tool_calls &&
                    questionsResponse.choices[0].message.tool_calls.length > 0) {
                    
                    const toolCall = questionsResponse.choices[0].message.tool_calls[0];
                    
                    if (toolCall.function && toolCall.function.name === "create_questions") {
                        try {
                            const args = JSON.parse(toolCall.function.arguments);
                            
                            if (args.questions && Array.isArray(args.questions) && args.questions.length > 0) {
                                // Make sure each question has the category property
                                const questions = args.questions.map(q => ({
                                    ...q,
                                    category: q.category || category
                                }));
                                
                                hideLoading();
                                return questions;
                            }
                        } catch (parseError) {
                            console.error("Error parsing function arguments:", parseError);
                        }
                    }
                }
                
                // Fallback: try to parse from the content directly
                if (questionsResponse.choices && 
                    questionsResponse.choices[0] && 
                    questionsResponse.choices[0].message && 
                    questionsResponse.choices[0].message.content) {
                    
                    const content = questionsResponse.choices[0].message.content;
                    const questions = parseQuestionsFromText(content, category);
                    
                    if (questions.length > 0) {
                        hideLoading();
                        return questions;
                    }
                }
                
                throw new Error("Failed to generate questions via function calling");
            } catch (error) {
                console.error("Error generating questions:", error);
                hideLoading();
                alert("Failed to generate test questions. Please try again.");
                navigateTo('welcome-screen');
                return [];
            }
        }

        // Function to parse questions from text format
        function parseQuestionsFromText(text, category) {
            const questions = [];
            
            // Split by numbered questions (1., 2., etc.)
            const questionBlocks = text.split(/\d+\.\s+/).filter(block => block.trim().length > 0);
            
            questionBlocks.forEach(block => {
                try {
                    // Extract the question text
                    const questionMatch = block.match(/^(.*?)(?:\n|$)/);
                    
                    if (!questionMatch) return;
                    
                    const questionText = questionMatch[1].trim();
                    
                    // Extract options (a., b., c., d. or A., B., C., D.)
                    const optionMatches = block.match(/[a-dA-D]\.?\s+(.*?)(?=(?:\n[a-dA-D]\.?)|$)/g);
                    
                    if (!optionMatches || optionMatches.length < 4) return;
                    
                    const options = optionMatches.map(match => {
                        const optionText = match.replace(/^[a-dA-D]\.?\s+/, '').trim();
                        return optionText;
                    });
                    
                    if (options.length === 4) {
                        questions.push({
                            question: questionText,
                            options: options,
                            category: category
                        });
                    }
                } catch (e) {
                    console.error("Error parsing question block:", e);
                }
            });
            
            return questions;
        }

        // Start the test with the selected category
        async function startTest() {
            // Reset test state
            appState.currentQuestionIndex = 0;
            appState.responses = {};
            
            // Generate questions for this test
            appState.questions = await generateTestQuestions(appState.selectedCategory);
            
            // Load the first question
            loadQuestion();
            
            // Navigate to test content screen
            navigateTo('test-content');
        }

        // Load the current question
        function loadQuestion() {
            const currentQuestion = appState.questions[appState.currentQuestionIndex];
            
            document.getElementById('question-text').textContent = currentQuestion.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.dataset.index = index;
                optionElement.textContent = option;
                optionsContainer.appendChild(optionElement);
                
                // Add click event listener
                optionElement.addEventListener('click', function() {
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    appState.selectedAnswer = parseInt(this.dataset.index);
                    document.getElementById('next-btn').disabled = false;
                });
            });
            
            // Reset selection
            appState.selectedAnswer = null;
            document.getElementById('next-btn').disabled = true;
            
            // Update progress bar
            const progress = ((appState.currentQuestionIndex + 1) / appState.questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        // Save the current response
        function saveResponse() {
            if (appState.selectedAnswer !== null) {
                const currentQuestion = appState.questions[appState.currentQuestionIndex];
                const category = currentQuestion.category || appState.selectedCategory;
                const response = {
                    question: currentQuestion.question,
                    answer: currentQuestion.options[appState.selectedAnswer],
                    index: appState.selectedAnswer
                };
                
                if (!appState.responses[category]) {
                    appState.responses[category] = [];
                }
                
                appState.responses[category].push(response);
            }
        }

        // -------------------- Results Generation --------------------
		// Calculate and display test results
		async function calculateResults() {
			showLoading("Analyzing your responses and generating insights...");
			
			try {
				// Prepare a summary of responses for the AI
				const responseSummary = Object.entries(appState.responses).map(([category, responses]) => {
					return {
						category,
						responses: responses.map(r => ({ 
							question: r.question, 
							answer: r.answer 
						}))
					};
				});
				
				// Calculate category scores
				const scores = {};
				Object.keys(appState.responses).forEach(category => {
					const responses = appState.responses[category];
					
					// Simple scoring algorithm - can be made more sophisticated
					// Scores are normalized to 0-100 range
					const score = Math.round(
						(responses.reduce((sum, r) => sum + (3 - Math.abs(r.index - 1.5)), 0) / 
						(responses.length * 3)) * 100
					);
					scores[category] = score;
				});
				
				// Create test summary for AI analysis
				const testSummary = {
					category: appState.selectedCategory,
					scores: scores,
					responses: responseSummary,
					patterns: findResponsePatterns()
				};
				
				// Generate personalized analysis
				const analysisResponse = await API.generateText([
				  { 
					role: "system", 
					content: `You are a thoughtful personality test analyzer specializing in ${appState.selectedCategory} assessments.
					  Provide a concise, personalized analysis based on test results.
					  Be specific and insightful but brief - aim for 2-3 paragraphs total.
					  Include key insights and potential growth areas.
					  Avoid generic statements and focus on the most important patterns.`
				  },
				  { 
					role: "user", 
					content: `Here are my test results for the '${appState.selectedCategory}' category: ${JSON.stringify(testSummary)}. 
					  Please provide a concise analysis of what these results reveal about me.`
				  }
				]);
				
				if (!analysisResponse.choices || 
					!analysisResponse.choices[0] || 
					!analysisResponse.choices[0].message || 
					!analysisResponse.choices[0].message.content) {
					throw new Error("Invalid analysis response format");
				}
				
				const aiAnalysis = analysisResponse.choices[0].message.content;
				
				// Generate a visual representation image
				const imagePrompt = `Abstract visualization of personality traits for ${appState.selectedCategory} profile: ${
					Object.entries(scores)
						.map(([category, score]) => `${formatCategoryName(category)} (${score}%)`)
						.join(', ')
				}. Modern_digital_art_style with vibrant colors. Artistic_metaphorical_representation that captures the essence of these traits.`;

				const imageUrl = await API.generateImage(imagePrompt, {
				  width: 1000,
				  height: 320, // Wider aspect ratio for landscape
				  model: 'flux',
				  enhance: true,
				  seed: Math.floor(Math.random() * 1000000)
				});
				
				// Generate audio summary
				const audioSummaryText = `Here's a summary of your ${appState.selectedCategory} test results. ${
					Object.entries(scores)
						.map(([category, score]) => `Your ${formatCategoryName(category)} score is ${score}%.`)
						.join(' ')
				} ${aiAnalysis.split('.')[0]}.`;
				
				const audioUrl = await API.generateAudio(audioSummaryText, { 
					voice: 'nova'
				});
				
				// Update conversation history for follow-up discussion
				updateAIConversationHistory("user", `I've just completed the ${appState.selectedCategory} test. Here are my results: ${JSON.stringify(testSummary)}`);
				updateAIConversationHistory("assistant", aiAnalysis);
				
				// Display results
				hideLoading();
				
				// Set image
				document.getElementById('result-image').innerHTML = `
				  <img src="${imageUrl}" alt="Personality Visualization">
				`;
				
				// Set audio
				if (audioUrl) {
					document.getElementById('audio-source').src = audioUrl;
					document.getElementById('analysis-audio').load();
				}
				
				// Display category scores
				const resultsContainer = document.getElementById('results-container');
				resultsContainer.innerHTML = `
				  <div class="score-summary">
					${Object.entries(scores).map(([category, score]) => `
					  <div class="score-bar-item">
						<div class="score-bar-label">${formatCategoryName(category)}</div>
						<div class="score-bar-track">
						  <div class="score-bar-fill" style="width: ${score}%">
							<span class="score-bar-value">${score}%</span>
						  </div>
						</div>
					  </div>
					`).join('')}
				  </div>
				`;
				
				// Set analysis text
				document.getElementById('analysis-text').textContent = aiAnalysis;
				
				// Navigate to results screen
				navigateTo('test-results');
			} catch (error) {
				console.error("Error calculating results:", error);
				hideLoading();
				alert("Error generating results. Please try again.");
				navigateTo('welcome-screen');
			}
		}

        // Format category name for display
        function formatCategoryName(category) {
            return category
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Find patterns in responses for AI analysis
        function findResponsePatterns() {
            const patterns = [];
            
            // Check for consistent high or low indices in responses
            Object.entries(appState.responses).forEach(([category, responses]) => {
                const avgIndex = responses.reduce((sum, r) => sum + r.index, 0) / responses.length;
                if (avgIndex > 2.5) {
                    patterns.push(`High tendency toward ${category} (avg index: ${avgIndex.toFixed(1)})`);
                } else if (avgIndex < 1.5) {
                    patterns.push(`Low tendency toward ${category} (avg index: ${avgIndex.toFixed(1)})`);
                }
            });
            
            return patterns;
        }

        // -------------------- Chat Functionality --------------------
        // Add a message to the chat interface
        function addChatMessage(role, content) {
            const messagesContainer = document.getElementById('chat-messages');
            
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const avatarElement = document.createElement('div');
            avatarElement.className = `message-avatar ${role}`;
            avatarElement.textContent = role === 'user' ? 'U' : 'AI';
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = content;
            
            messageElement.appendChild(avatarElement);
            messageElement.appendChild(contentElement);
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send a chat message to the AI
        async function sendChatMessage() {
            const inputElement = document.getElementById('chat-input');
            const message = inputElement.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage('user', message);
            inputElement.value = '';
            
            // Show loading indicator
            const sendButton = document.getElementById('send-message-btn');
            const originalText = sendButton.textContent;
            sendButton.disabled = true;
            sendButton.textContent = "Thinking...";
            
            // Update conversation history
            updateAIConversationHistory("user", message);
            
            // Prepare messages for API call, including history
            const messages = [
                appState.aiConversationHistory.system,
                ...appState.aiConversationHistory.messages
            ];
            
            // Get AI response
            try {
                const response = await API.generateText(messages);
                
                if (!response.choices || 
                    !response.choices[0] || 
                    !response.choices[0].message || 
                    !response.choices[0].message.content) {
                    throw new Error("Invalid chat response format");
                }
                
                const aiResponse = response.choices[0].message.content;
                
                // Update conversation history
                updateAIConversationHistory("assistant", aiResponse);
                
                // Add AI response to chat
                addChatMessage('assistant', aiResponse);
            } catch (error) {
                console.error("Error getting chat response:", error);
                addChatMessage('assistant', "I'm sorry, I encountered an error processing your request. Please try again.");
            }
            
            // Restore button
            sendButton.disabled = false;
            sendButton.textContent = originalText;
        }

        // Update the AI conversation history
        function updateAIConversationHistory(role, content) {
            appState.aiConversationHistory.messages.push({
                role: role,
                content: content
            });
            
            // Keep only the last 10 messages from each role
            const userMessages = appState.aiConversationHistory.messages.filter(m => m.role === "user");
            const assistantMessages = appState.aiConversationHistory.messages.filter(m => m.role === "assistant");
            
            if (userMessages.length > 10) {
                // Remove oldest user messages
                const toRemove = userMessages.length - 10;
                for (let i = 0; i < toRemove; i++) {
                    const index = appState.aiConversationHistory.messages.findIndex(m => m.role === "user");
                    if (index !== -1) {
                        appState.aiConversationHistory.messages.splice(index, 1);
                    }
                }
            }
            
            if (assistantMessages.length > 10) {
                // Remove oldest assistant messages
                const toRemove = assistantMessages.length - 10;
                for (let i = 0; i < toRemove; i++) {
                    const index = appState.aiConversationHistory.messages.findIndex(m => m.role === "assistant");
                    if (index !== -1) {
                        appState.aiConversationHistory.messages.splice(index, 1);
                    }
                }
            }
        }

        // -------------------- UI Navigation & Utility Functions --------------------
        // Navigate between screens
        function navigateTo(screenId) {
            // Hide current screen
            document.getElementById(appState.currentScreen).classList.remove('active');
            
            // Show new screen
            document.getElementById(screenId).classList.add('active');
            
            // Update current screen
            appState.currentScreen = screenId;
        }

        // Show loading spinner
        function showLoading(message = "Loading...") {
            // Create loading container if it doesn't exist
            let loadingContainer = document.querySelector('.loading-container');
            
            if (!loadingContainer) {
                loadingContainer = document.createElement('div');
                loadingContainer.className = 'loading-container';
                
                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                
                const text = document.createElement('div');
                text.className = 'loading-text';
                
                loadingContainer.appendChild(spinner);
                loadingContainer.appendChild(text);
                
                document.body.appendChild(loadingContainer);
            }
            
            // Update message
            loadingContainer.querySelector('.loading-text').textContent = message;
            
            // Show loading container
            loadingContainer.style.display = 'flex';
        }

        // Hide loading spinner
        function hideLoading() {
            const loadingContainer = document.querySelector('.loading-container');
            if (loadingContainer) {
                loadingContainer.style.display = 'none';
            }
        }

        // -------------------- Event Listeners --------------------
        document.addEventListener('DOMContentLoaded', function() {
            // Welcome screen event listeners
            document.querySelectorAll('.test-card').forEach(card => {
                card.addEventListener('click', function() {
                    const category = this.dataset.category;
                    selectTestCategory(category);
                });
                
                // Make the buttons inside the cards also work
                const button = card.querySelector('button');
                if (button) {
                    button.addEventListener('click', function(event) {
                        event.stopPropagation(); // Prevent triggering the card's click event
                        const category = card.dataset.category;
                        selectTestCategory(category);
                    });
                }
            });
            
            // Test selection screen event listeners
            document.getElementById('back-to-welcome').addEventListener('click', function() {
                navigateTo('welcome-screen');
            });
            
            document.getElementById('start-test-btn').addEventListener('click', function() {
                startTest();
            });
            
            // Test navigation event listeners
            document.getElementById('back-btn').addEventListener('click', function() {
                if (appState.currentQuestionIndex > 0) {
                    appState.currentQuestionIndex--;
                    loadQuestion();
                } else {
                    navigateTo('test-selection');
                }
            });
            
            document.getElementById('next-btn').addEventListener('click', function() {
                saveResponse();
                
                if (appState.currentQuestionIndex < appState.questions.length - 1) {
                    appState.currentQuestionIndex++;
                    loadQuestion();
                } else {
                    calculateResults();
                }
            });
            
            // Results screen event listeners
            document.getElementById('back-to-home').addEventListener('click', function() {
                navigateTo('welcome-screen');
            });
            
            document.getElementById('new-test-btn').addEventListener('click', function() {
                navigateTo('welcome-screen');
            });
            
			document.getElementById('discuss-results-btn').addEventListener('click', function() {
			  const chatOverlay = document.getElementById('chat-overlay');
			  chatOverlay.style.display = 'flex';
			  
			  // Add initial assistant message if there are no messages yet
			  const messagesContainer = document.getElementById('chat-messages');
			  if (messagesContainer.children.length === 0) {
				addChatMessage('assistant', "I'd be happy to discuss your results! What aspects would you like to explore further?");
			  }
			});

			// Replace the close-chat-btn click handler with this
			document.getElementById('close-chat-btn').addEventListener('click', function() {
			  document.getElementById('chat-overlay').style.display = 'none';
			});
            
            document.getElementById('send-message-btn').addEventListener('click', sendChatMessage);
            
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });
    </script>
</body>
</html>		
