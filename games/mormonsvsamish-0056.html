<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mormons vs Amish</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
        }

        #game-container {
            display: grid;
            grid-template-columns: 3fr 400px;
            gap: 20px;
            max-width: 1800px;
            margin: 0 20px;
            padding: 20px;
            min-height: calc(100vh - 100px);
        }

        #game-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }

        #map-container {
            position: relative;
            background: #222;
            border-radius: 10px;
            padding: 10px;
            height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #333;
            border-radius: 8px;
        }

        #action-bar {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #222;
            border-radius: 8px;
        }

        .action-button {
            padding: 10px 20px;
            background: #444;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .action-button:hover {
            background: #555;
        }

        .action-button.selected {
            background: #666;
            box-shadow: 0 0 0 2px #888;
        }

        #game-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
        }

		.player-card {
			background: #222;
			border-radius: 10px;
			padding: 10px;
			display: flex;
			align-items: center;
			gap: 10px;  /* Reduced gap to pull text closer to image */
			margin-bottom: 10px;
		}

		.player-portrait {
			width: 80px;     /* Slightly smaller image */
			height: 80px;
			background: #333;
			background-size: cover;
			background-position: center;
			border-radius: 8px;
			flex-shrink: 0;
		}

		.player-card h3 {
			display: none;   /* Remove the title since we want just image + stats */
		}

		.resource-list {
			flex-grow: 1;
			margin: 0;       /* Remove any margin */
			padding: 0;      /* Remove any padding */
		}

		.resource-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin: 2px 0;   /* Minimal spacing between stats lines */
		}

		.resource-item span:first-child {
			margin-right: 10px;  /* Space between label and value */
		}

        .resource-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }

        #game-log {
            max-height: 200px;
            overflow-y: auto;
            background: #222;
            border-radius: 10px;
            padding: 15px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }

        .log-entry.system { background: #2c3e50; }
        .log-entry.mormon { background: #c0392b; }
        .log-entry.amish { background: #16a085; }

        #status-bar {
            background: #222;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
		
		#refresh-overlay {
			position: absolute;
			top: 10px;
			left: 10px;
			background: rgba(0, 0, 0, 0.6);
			border-radius: 50%;
			width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background 0.3s;
			z-index: 10;
		}

		#refresh-overlay:hover {
			background: rgba(0, 0, 0, 0.8);
		}

		#refresh-overlay svg {
			width: 20px;
			height: 20px;
			fill: white;
		}
		
    </style>
</head>

<body>
    <script src="https://freecode.ai-ministries.com/js/nav-loader.js"></script>
    <div id="game-container">
        <div id="game-main">
            <div id="map-container">
                <canvas id="map"></canvas>
				<div id="refresh-overlay">
					<svg viewBox="0 0 24 24">
						<path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
					</svg>
				</div>
            </div>
            <div id="action-bar">
                <button class="action-button" id="choose-mormon">Play as Mormons</button>
                <button class="action-button" id="choose-amish">Play as Amish</button>
                <button class="action-button" id="settle-button">Settle (2ðŸ‘¥)</button>
                <button class="action-button" id="convert-button">Convert (10ðŸ’°)</button>
                <button class="action-button" id="upgrade-button">Upgrade (50ðŸ’°)</button>
                <button class="action-button" id="end-turn-button">End Turn</button>
            </div>
            <div id="status-bar">
                Select your faction to begin
            </div>
        </div>
        
        <div id="game-sidebar">
            <div class="player-card" id="player-info">
                <div class="player-portrait"></div>
                <h3>Your Faction</h3>
                <div class="resource-list">
                    <div class="resource-item">
                        <span>Population</span>
                        <span id="player-population">100</span>
                    </div>
                    <div class="resource-item">
                        <span>Settlements</span>
                        <span id="player-settlements">1</span>
                    </div>
                    <div class="resource-item">
                        <span>Resources</span>
                        <span id="player-resources">1000</span>
                    </div>
                </div>
            </div>

            <div class="player-card" id="ai-info">
                <div class="player-portrait"></div>
                <h3>Opponent</h3>
                <div class="resource-list">
                    <div class="resource-item">
                        <span>Population</span>
                        <span id="ai-population">100</span>
                    </div>
                    <div class="resource-item">
                        <span>Settlements</span>
                        <span id="ai-settlements">1</span>
                    </div>
                    <div class="resource-item">
                        <span>Influence</span>
                        <span id="ai-influence">Medium</span>
                    </div>
                </div>
            </div>

            <div id="game-log">
                <div class="log-entry system">Welcome! Choose your faction to begin...</div>
            </div>
        </div>
    </div>
    <script>
		document.addEventListener('DOMContentLoaded', async function() {
			// Core game state initialization
			const canvas = document.getElementById('map');
			const ctx = canvas.getContext('2d');

			// Keep track of seeds for consistency
			const imageSeed = Math.floor(Math.random() * 10000);

			const gameState = {
				currentTurn: 'none',
				phase: 'setup',
				selectedAction: null,
				playerSide: null,
				turnNumber: 1,
				resources: {
					mormon: {
						people: 100,
						missionaries: 10,
						funds: 1000,
						settlements: []
					},
					amish: {
						people: 100,
						farmers: 20,
						grain: 1000,
						settlements: []
					}
				},
				baseLocations: {
					mormon: {x: 300, y: 250},  // Utah
					amish: {x: 600, y: 250}    // Pennsylvania
				}
			};

			const ImageCache = {
                images: {},
                loadingPromises: {},
                maxConcurrent: 3,
                loadingCount: 0,

				async loadImage(key, url) {
					// Try to get from localStorage first
					const savedData = localStorage.getItem(`image_${key}`);
					if (savedData) {
						const storedImg = new Image();
						storedImg.src = savedData;
						this.images[key] = storedImg;
						return storedImg;
					}

					// Return cached memory image if exists
					if (this.images[key]) {
						return this.images[key];
					}

					// Return existing promise if already loading
					if (this.loadingPromises[key]) {
						return this.loadingPromises[key];
					}

					this.loadingCount++;
					
					// Create new loading promise
					this.loadingPromises[key] = new Promise((resolve, reject) => {
						const img = new Image();
						
						img.onload = () => {
							// Store in both memory and localStorage
							this.images[key] = img;
							try {
								localStorage.setItem(`image_${key}`, img.src);
							} catch(e) {
								console.warn('Could not save to localStorage:', e);
							}
							
							delete this.loadingPromises[key];
							this.loadingCount--;
							resolve(img);
						};
						
						img.onerror = () => {
							delete this.loadingPromises[key];
							this.loadingCount--;
							reject(new Error(`Failed to load image: ${url}`));
						};

						img.crossOrigin = 'anonymous';  // Required for CORS images
						img.src = url + '&nologo=true';
					});

					return this.loadingPromises[key];
				},

                preloadImages() {
                    // Preload title screen, map, and both faction portraits
                    const titlePrompt = "epic fantasy battle scene between a Mormon missionary in suit and an Amish elder in traditional clothing, large centered text reads 'AMISH vs MORMONS', anime illustration style)";
                    const mapPrompt = "USA Map vector style clean outlines only state boundaries on white background no text no icons minimalist design";
                    const mormonPrompt = "young Mormon missionary wearing suit with nametag, portrait, headshot, anime illustration style";
                    const amishPrompt = "Amish elder with beard wearing traditional clothes, portrait, headshot, anime illustration style";
                    
                    const seed1 = Math.floor(Math.random() * 10000);
                    const seed2 = Math.floor(Math.random() * 10000);
                    
                    const promises = [
                        this.loadImage('title', `https://image.pollinations.ai/prompt/${encodeURIComponent(titlePrompt)}?width=1600&height=900&seed=${imageSeed}&nologo=true`),
                        this.loadImage('map', `https://image.pollinations.ai/prompt/${encodeURIComponent(mapPrompt)}?width=1600&height=900&seed=${imageSeed + 1}&nologo=true`),
                        this.loadImage('mormon', `https://image.pollinations.ai/prompt/${encodeURIComponent(mormonPrompt)}?width=400&height=400&seed=${seed1}&nologo=true`),
                        this.loadImage('amish', `https://image.pollinations.ai/prompt/${encodeURIComponent(amishPrompt)}?width=400&height=400&seed=${seed2}&nologo=true`)
                    ];

                    return Promise.all(promises);
                }
            };

            // Ensure images are loaded before anything else
			await ImageCache.preloadImages();

			// Set default portraits immediately 
			const playerPortrait = document.querySelector('#player-info .player-portrait');
			const aiPortrait = document.querySelector('#ai-info .player-portrait');
			playerPortrait.style.backgroundImage = `url('${ImageCache.images['mormon'].src}')`;
			aiPortrait.style.backgroundImage = `url('${ImageCache.images['amish'].src}')`;

			renderCanvas();

			const factionRules = {
				mormon: {
					settleCost: { people: 2, funds: 100 },
					range: 150,
					color: '#ff6b6b',
					growthRate: 0.05,  // 5% population growth
					fundingPerPerson: 10,
					conversionRange: 100
				},
				amish: {
					settleCost: { people: 6, grain: 200 },
					range: 80,
					farmRadius: 40,
					color: '#4ecdc4',
					growthRate: 0.08,  // 8% population growth
					grainPerFarmer: 20,
					farmEfficiency: 0.9
				}
			};
	
			function initGame(side) {
				gameState.playerSide = side;
				gameState.phase = 'playing';
				gameState.currentTurn = 'player';
				
				// Clear any existing settlements
				gameState.resources.mormon.settlements = [];
				gameState.resources.amish.settlements = [];
				
				// Load map and wait for it to finish before adding settlements
				loadMapBackground();
				if (gameState.mapImage.complete) {
					// Map was cached, add settlements immediately
					addSettlement(side, gameState.baseLocations[side], true);
					const aiSide = side === 'mormon' ? 'amish' : 'mormon';
					addSettlement(aiSide, gameState.baseLocations[aiSide], true);
				} else {
					// Wait for map to load before adding settlements
					gameState.mapImage.onload = () => {
						addSettlement(side, gameState.baseLocations[side], true);
						const aiSide = side === 'mormon' ? 'amish' : 'mormon';
						addSettlement(aiSide, gameState.baseLocations[aiSide], true);
					};
				}
				
				setupPortraits();
				updateUI();
				addGameLog('system', 'Game started - Place your settlements from your base');
			}

			async function showTitleScreen() {
				try {
					if (ImageCache.images['title']) {
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						ctx.drawImage(ImageCache.images['title'], 0, 0, canvas.width, canvas.height);
						return;
					} else {
						throw new Error('Title image not found in cache');
					}
				} catch (error) {
					console.error(error);
					ctx.fillStyle = '#333';
					ctx.fillRect(0, 0, canvas.width, canvas.height);
					ctx.fillStyle = '#fff';
					ctx.font = '48px Arial';
					ctx.fillText('Mormons vs Amish', canvas.width/2 - 150, canvas.height/2);
				}
			}

			async function loadMapBackground() {
				// Skip loading - use cached image
				if (ImageCache.images['map']) {
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					ctx.drawImage(ImageCache.images['map'], 0, 0, canvas.width, canvas.height);
					renderSettlements();
					return;
				}

				// Fallback if cache failed
				ctx.fillStyle = '#fff';
				ctx.fillRect(0, 0, canvas.width, canvas.height);
				ctx.strokeStyle = '#333';
				ctx.strokeRect(0, 0, canvas.width, canvas.height);
			}


			async function renderCanvas() {
				if (!gameState.playerSide) {
					showTitleScreen();
				} else {
					loadMapBackground();
				}
			}

			function resizeCanvas() {
				const rect = canvas.getBoundingClientRect();
				canvas.width = rect.width;
				canvas.height = rect.height;
				renderCanvas();
			}

			const refreshBtn = document.getElementById('refresh-overlay');
			refreshBtn.addEventListener('click', async () => {
				// Generate new seed
				const newSeed = Math.floor(Math.random() * 10000);
				
				// Save current game state
				const currentState = gameState.phase;
				
				// Reload images with new seed
				try {
					if (currentState === 'setup') {
						// If we're in setup, reload title screen
						const titlePrompt = "epic fantasy battle scene between a Mormon missionary in suit and an Amish elder in traditional clothing, large centered text reads 'AMISH vs MORMONS', anime illustration style)";
						await ImageCache.loadImage('title', `https://image.pollinations.ai/prompt/${encodeURIComponent(titlePrompt)}?width=1600&height=900&seed=${newSeed}&nologo=true`);
					} else {
						// If we're in game, reload map
						const mapPrompt = "USA Map vector style clean outlines only state boundaries on white background no text no icons minimalist design";
						await ImageCache.loadImage('map', `https://image.pollinations.ai/prompt/${encodeURIComponent(mapPrompt)}?width=1600&height=900&seed=${newSeed}&nologo=true`);
					}
					
					// Re-render the canvas
					renderCanvas();
					addGameLog('system', 'Generated new map image');
				} catch (error) {
					console.error('Failed to refresh image:', error);
					addGameLog('system', 'Failed to generate new image');
				}
			});

            // Initialize game for chosen faction
            function initGame(side) {
                gameState.playerSide = side;
                gameState.phase = 'playing';
                gameState.currentTurn = 'player';
                
                // Clear any existing settlements
                gameState.resources.mormon.settlements = [];
                gameState.resources.amish.settlements = [];
                
                // Load map and set up game
                loadMapBackground();
                setupPortraits();
                
                // Initialize base locations
                addSettlement(side, gameState.baseLocations[side], true);
                const aiSide = side === 'mormon' ? 'amish' : 'mormon';
                addSettlement(aiSide, gameState.baseLocations[aiSide], true);
                
                updateUI();
                addGameLog('system', 'Game started - Place your settlements from your base');
            }

            // Set up faction portraits
			async function setupPortraits() {
				const playerPortrait = document.querySelector('#player-info .player-portrait');
				const aiPortrait = document.querySelector('#ai-info .player-portrait');
				
				try {
					// Use already cached images
					const mormonImage = ImageCache.images['mormon'];
					const amishImage = ImageCache.images['amish'];
					
					if (!mormonImage || !amishImage) {
						throw new Error('Portrait images not found in cache');
					}
					
					if (gameState.playerSide === 'mormon') {
						playerPortrait.style.backgroundImage = `url('${mormonImage.src}')`;
						aiPortrait.style.backgroundImage = `url('${amishImage.src}')`;
					} else {
						playerPortrait.style.backgroundImage = `url('${amishImage.src}')`;
						aiPortrait.style.backgroundImage = `url('${mormonImage.src}')`;
					}
				} catch (error) {
					console.error('Failed to set portraits:', error);
					playerPortrait.style.backgroundColor = '#444';
					aiPortrait.style.backgroundColor = '#444';
				}
			}

            // Settlement handling
            function addSettlement(side, position, isBase = false) {
                const settlement = {
                    x: position.x,
                    y: position.y,
                    isBase,
                    population: isBase ? 50 : 20
                };
                
                gameState.resources[side].settlements.push(settlement);
                
                if (!isBase) {
                    const rules = factionRules[side];
                    gameState.resources[side].people -= rules.settleCost.people;
                    if (side === 'mormon') {
                        gameState.resources[side].funds -= rules.settleCost.funds;
                    } else {
                        gameState.resources[side].grain -= rules.settleCost.grain;
                    }
                }
                
                renderSettlements();
                addGameLog(side, `New settlement established${isBase ? ' (Base)' : ''}`);
            }

            function tryPlaceSettlement(x, y) {
                const side = gameState.playerSide;
                const rules = factionRules[side];
                const resources = gameState.resources[side];
                
                if (resources.people < rules.settleCost.people) {
                    addGameLog('system', 'Not enough people for new settlement');
                    return;
                }
                
                if (side === 'mormon' && resources.funds < rules.settleCost.funds) {
                    addGameLog('system', 'Not enough funds for new settlement');
                    return;
                }
                
                if (side === 'amish' && resources.grain < rules.settleCost.grain) {
                    addGameLog('system', 'Not enough grain for new settlement');
                    return;
                }
                
                if (isValidSettlementLocation({x, y}, side)) {
                    addSettlement(side, {x, y});
                    updateUI();
                    endPlayerTurn();
                } else {
                    addGameLog('system', 'Invalid settlement location - must be within range of existing settlement');
                }
            }

			function isValidSettlementLocation(pos, side) {
				const settlements = gameState.resources[side].settlements;
				const rules = factionRules[side];
				
				// Handle base settlement case
				if (settlements.length === 0) {
					const base = gameState.baseLocations[side];
					return Math.abs(pos.x - base.x) < 20 && Math.abs(pos.y - base.y) < 20;
				}

				return settlements.some(settlement => {
					const distance = Math.sqrt(
						Math.pow(pos.x - settlement.x, 2) + 
						Math.pow(pos.y - settlement.y, 2)
					);
					
					if (side === 'mormon') {
						// Mormon settlements just need to be within range
						return distance <= rules.range;
					} else {
						// Amish settlements need to overlap with existing farm radius
						// but not be too close to center of another settlement
						const minDistance = 20; // Minimum distance from other settlement centers
						return distance <= rules.range + rules.farmRadius && distance >= minDistance;
					}
				});
			}

			function handleAITurn() {
				const aiSide = gameState.playerSide === 'mormon' ? 'amish' : 'mormon';
				const aiRules = factionRules[aiSide];
				const aiResources = gameState.resources[aiSide];
				
				// Check if AI can afford a settlement
				if ((aiSide === 'mormon' && aiResources.people >= 2 && aiResources.funds >= 100) ||
					(aiSide === 'amish' && aiResources.people >= 6 && aiResources.grain >= 200)) {
					
					// Find valid settlement location
					const baseSettlement = aiResources.settlements[0]; // Start from base
					const angle = Math.random() * Math.PI * 2; // Random angle
					const distance = aiSide === 'mormon' ? 
						aiRules.range * 0.8 : // Mormon: Try to expand outward
						aiRules.range * 1.5;  // Amish: Allow for farm overlap
					
					const newPos = {
						x: baseSettlement.x + Math.cos(angle) * distance,
						y: baseSettlement.y + Math.sin(angle) * distance
					};
					
					// Validate and place settlement
					if (isValidSettlementLocation(newPos, aiSide)) {
						addSettlement(aiSide, newPos);
						addGameLog('system', `AI (${aiSide}) placed a new settlement`);
					}
				}
				
				// End AI turn
				gameState.currentTurn = 'player';
				updateUI();
			}

			function handleAITurn() {
				const aiSide = gameState.playerSide === 'mormon' ? 'amish' : 'mormon';
				const aiRules = factionRules[aiSide];
				const aiResources = gameState.resources[aiSide];
				
				// Check if AI can afford a settlement
				if ((aiSide === 'mormon' && aiResources.people >= 2 && aiResources.funds >= 100) ||
					(aiSide === 'amish' && aiResources.people >= 6 && aiResources.grain >= 200)) {
					
					// Find valid settlement location
					const baseSettlement = aiResources.settlements[0]; // Start from base
					const angle = Math.random() * Math.PI * 2; // Random angle
					const distance = aiSide === 'mormon' ? 
						aiRules.range * 0.8 : // Mormon: Try to expand outward
						aiRules.range * 1.5;  // Amish: Allow for farm overlap
					
					const newPos = {
						x: baseSettlement.x + Math.cos(angle) * distance,
						y: baseSettlement.y + Math.sin(angle) * distance
					};
					
					// Validate and place settlement
					if (isValidSettlementLocation(newPos, aiSide)) {
						addSettlement(aiSide, newPos);
						addGameLog('system', `AI (${aiSide}) placed a new settlement`);
					}
				}
				
				// End AI turn
				gameState.currentTurn = 'player';
				updateUI();
			}

            // Rendering functions
            function renderSettlements() {
                ['mormon', 'amish'].forEach(side => {
                    const settlements = gameState.resources[side].settlements;
                    const rules = factionRules[side];
                    
                    settlements.forEach(settlement => {
                        // Draw connection lines or farm radius
                        if (side === 'mormon') {
                            if (!settlement.isBase) {
                                const nearest = findNearestSettlement(settlement, settlements);
                                ctx.beginPath();
								ctx.strokeStyle = rules.color;
								ctx.lineWidth = 2;
								ctx.moveTo(settlement.x, settlement.y);
								ctx.lineTo(nearest.x, nearest.y);
								ctx.stroke();
							}
						} else if (side === 'amish') {
							ctx.beginPath();
							ctx.fillStyle = rules.color + '33';
							ctx.arc(settlement.x, settlement.y, rules.farmRadius, 0, Math.PI * 2);
							ctx.fill();
						}
						
						// Draw settlement point
						ctx.beginPath();
						ctx.fillStyle = rules.color;
						ctx.arc(settlement.x, settlement.y, settlement.isBase ? 8 : 5, 0, Math.PI * 2);
						ctx.fill();
					});
				});
			}

			function findNearestSettlement(current, settlements) {
				let nearest = settlements[0];
				let minDistance = Infinity;
				
				settlements.forEach(settlement => {
					if (settlement === current) return;
					
					const distance = Math.sqrt(
						Math.pow(current.x - settlement.x, 2) + 
						Math.pow(current.y - settlement.y, 2)
					);
					
					if (distance < minDistance) {
						minDistance = distance;
						nearest = settlement;
					}
				});
				
				return nearest;
			}

			function addGameLog(type, message) {
				const log = document.getElementById('game-log');
				const entry = document.createElement('div');
				entry.className = `log-entry ${type}`;
				entry.textContent = message;
				log.insertBefore(entry, log.firstChild);
			}

			// Resource generation and turn processing
			function processTurn(side) {
				generateResources(side);
				growPopulation(side);
				updateInfluenceZones(side);
			}

			function generateResources(side) {
				const resources = gameState.resources[side];
				const rules = factionRules[side];
				
				if (side === 'mormon') {
					// Mormons generate funds based on population
					const totalPop = resources.settlements.reduce((sum, s) => sum + s.population, 0);
					resources.funds += Math.floor(totalPop * rules.fundingPerPerson);
				} else {
					// Amish generate grain based on farmers and farm area
					resources.settlements.forEach(settlement => {
						const farmersHere = Math.floor(settlement.population * 0.4); // 40% are farmers
						const grainProduced = Math.floor(
							farmersHere * rules.grainPerFarmer * rules.farmEfficiency
						);
						resources.grain += grainProduced;
					});
				}
			}

			function growPopulation(side) {
				const resources = gameState.resources[side];
				const rules = factionRules[side];
				
				resources.settlements.forEach(settlement => {
					const growth = Math.floor(settlement.population * rules.growthRate);
					settlement.population += growth;
				});
			}

			function updateInfluenceZones(side) {
				const otherSide = side === 'mormon' ? 'amish' : 'mormon';
				const resources = gameState.resources[side];
				const otherResources = gameState.resources[otherSide];
				
				// Calculate religious influence in overlapping areas
				resources.settlements.forEach(settlement => {
					otherResources.settlements.forEach(otherSettlement => {
						const distance = Math.sqrt(
							Math.pow(settlement.x - otherSettlement.x, 2) + 
							Math.pow(settlement.y - otherSettlement.y, 2)
						);
						
						if (side === 'mormon' && distance <= factionRules.mormon.conversionRange) {
							// Mormon conversion attempt
							const conversionChance = 0.1; // 10% base chance
							const popToConvert = Math.floor(otherSettlement.population * conversionChance);
							if (popToConvert > 0) {
								otherSettlement.population -= popToConvert;
								settlement.population += popToConvert;
								addGameLog(side, `Converted ${popToConvert} people from nearby Amish settlement`);
							}
						}
					});
				});
			}

			// Victory check function
			function checkVictoryConditions() {
				const mormon = gameState.resources.mormon;
				const amish = gameState.resources.amish;
				
				// Calculate total populations
				const mormonPop = mormon.settlements.reduce((sum, s) => sum + s.population, 0);
				const amishPop = amish.settlements.reduce((sum, s) => sum + s.population, 0);
				
				// Victory conditions
				if (mormonPop >= 1000) {
					endGame('mormon');
				} else if (amishPop >= 1000) {
					endGame('amish');
				}
			}

			function endGame(winner) {
				gameState.phase = 'ended';
				addGameLog('system', `Game Over - ${winner.charAt(0).toUpperCase() + winner.slice(1)} Victory!`);
				// Disable further actions
				document.querySelectorAll('.action-button').forEach(btn => btn.disabled = true);
			}

			// Modify your existing endPlayerTurn function to use these:
			function endPlayerTurn() {
				gameState.currentTurn = 'ai';
				gameState.selectedAction = null;
				document.querySelectorAll('.action-button').forEach(btn => 
					btn.classList.remove('selected'));
				
				// Process turn for player side first
				processTurn(gameState.playerSide);
				updateUI();
				
				// Add slight delay before AI moves
				setTimeout(() => {
					// Process AI turn
					processTurn(gameState.playerSide === 'mormon' ? 'amish' : 'mormon');
					handleAITurn();
					checkVictoryConditions();
				}, 1000);
			}

			// UI Updates
			function updateUI() {
				const playerResources = gameState.resources[gameState.playerSide];
				if (!playerResources) return;
				
				document.getElementById('player-population').textContent = 
					playerResources.settlements.reduce((sum, s) => sum + s.population, 0);
				document.getElementById('player-settlements').textContent = playerResources.settlements.length;
				
				const resourceText = gameState.playerSide === 'mormon' ? 
					`${playerResources.funds}ðŸ’°` : 
					`${playerResources.grain}ðŸŒ¾`;
				document.getElementById('player-resources').textContent = resourceText;
				
				document.getElementById('status-bar').textContent = 
					`Turn ${gameState.turnNumber} - ${gameState.currentTurn === 'player' ? 
						'Your turn - Select an action' : 'AI is thinking...'}`;
				
				// Refresh canvas to show updated settlement info
				renderCanvas();
			}

			// Add event listeners
			resizeCanvas();
			window.addEventListener('resize', resizeCanvas);

			canvas.addEventListener('click', (e) => {
				if (gameState.currentTurn !== 'player' || !gameState.selectedAction) return;
				
				const rect = canvas.getBoundingClientRect();
				const x = e.clientX - rect.left;
				const y = e.clientY - rect.top;
				
				if (gameState.selectedAction === 'settle') {
					tryPlaceSettlement(x, y);
				}
			});

			// Add faction selection handlers
			document.getElementById('choose-mormon').addEventListener('click', () => {
				initGame('mormon');
				// Remove faction choice buttons
				document.getElementById('choose-mormon').remove();
				document.getElementById('choose-amish').remove();
			});

			document.getElementById('choose-amish').addEventListener('click', () => {
				initGame('amish');
				// Remove faction choice buttons
				document.getElementById('choose-mormon').remove();
				document.getElementById('choose-amish').remove();
			});

			// Add action button handlers
			document.querySelectorAll('.action-button').forEach(button => {
				if (button.id === 'choose-mormon' || button.id === 'choose-amish') return;
				
				button.addEventListener('click', () => {
					if (gameState.currentTurn !== 'player') return;
					
					document.querySelectorAll('.action-button').forEach(btn => 
						btn.classList.remove('selected'));
					button.classList.add('selected');
					
					gameState.selectedAction = button.id.replace('-button', '');
					
					if (button.id === 'end-turn-button') {
						endPlayerTurn();
					}
				});
			});
		});
		
	</script>
</body>
</html>
