async function sendMessage() {
  if (!currentModel) return;
  
  const input = document.getElementById('chat-input');
  const chatArea = document.getElementById('chat-area');
  const text = input.value.trim();
  const systemMessageInput = document.getElementById('system-message');
  const personaMessage = systemMessageInput.value.trim();
  const useWrappedPersona = document.getElementById('persona-method').value === 'wrapped';
  
  if (!text) return;

  let messages = [];
  const managedHistory = await manageHistory(currentModel.name, chatHistory[currentModel.name]);
  
  if (personaMessage) {
    if (useWrappedPersona) {
      messages.push({
        role: 'user',
        content: `CONTEXT: ${personaMessage}\nUSER: ${text}`
      });
    } else {
      messages.push({ role: 'system', content: personaMessage });
      messages.push(...managedHistory);
      messages.push({ role: 'user', content: text });
    }
  } else {
    messages.push(...managedHistory);
    messages.push({ role: 'user', content: text });
  }

  try {
    input.disabled = true;
    const userMsg = document.createElement('div');
    userMsg.className = 'chat-message user-message';
    userMsg.textContent = text;
    chatArea.appendChild(userMsg);

    // Add CoT instruction to the message list for this API call only
    const messagesWithCoT = [
      ...messages,
      {
        role: 'system',
        content: 'Please think through this step-by-step before providing your answer. Include your reasoning process followed by a clear conclusion.'
      }
    ];

    const response = await callAPI(messagesWithCoT, currentModel.name, {
      seed: Math.floor(Math.random() * 2147483647)
    });

    if (response.ok) {
      const botMsg = document.createElement('div');
      botMsg.className = 'chat-message bot-message';
      botMsg.textContent = response.result;
      addReplayButton(botMsg, response.result);
      chatArea.appendChild(botMsg);

      if (voiceEnabled) {
        speak(response.result);
      }

      // Store just the original user message and the complete response
      chatHistory[currentModel.name].push({ role: 'user', content: text });
      chatHistory[currentModel.name].push({ role: 'assistant', content: response.result });
      saveHistory();
    }
  } catch (error) {
    console.error('Error:', error);
    const errorMsg = document.createElement('div');
    errorMsg.className = 'chat-message';
    errorMsg.textContent = 'Error sending message. Please try again.';
    errorMsg.style.color = '#ef4444';
    chatArea.appendChild(errorMsg);
  } finally {
    input.value = '';
    input.disabled = false;
    input.focus();
    chatArea.scrollTop = chatArea.scrollHeight;
  }
}
