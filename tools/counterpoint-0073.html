<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point Counter Point Simulator</title>
    <script src="https://www.ai-ministries.com/js/nav-loader.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 0;
            margin: 0;
            background-color: #181818;
            color: #f0f0f0;
            overflow-x: hidden;
        }

		.ai-ministries-nav-only {
			width: 100vw;
			font-family: Arial, sans-serif;
			background: black;
			color: white;
			z-index: 9999;  /* Keep this high to stay on top */
			position: relative;
			padding: 15px 0;
			height: 50px;
			display: flex;
			align-items: center;
			margin-left: calc(-50vw + 50%);
			margin-right: calc(-50vw + 50%);
		}
        
		main {
			margin-top: 20px;  /* Reduced from 40px */
			padding-bottom: 40px;
			width: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
        
        .concept-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            margin-top: 20px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        .image-container {
            position: relative;
            width: 100%;
            height: 35vh;
            background-color: #292929;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #conceptImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #conceptImage.loaded {
            opacity: 1;
        }
        
        .refresh-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .refresh-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .refresh-button svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        #conceptCaption {
            font-size: 1.5rem;
            text-align: center;
            margin: 10px 0;
            min-height: 40px;
        }
        
        #results {
            display: flex;
            width: 100%;
            max-width: 1200px;
            gap: 20px;
            margin: 20px 0;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
		.resultPanel {
			flex: 1;
			background: #292929;
			border-radius: 10px;
			padding: 20px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
			min-height: 150px;
			font-size: 1.1rem;
			line-height: 1.5;
			display: flex;
			flex-direction: column;
		}

		.panel-title {
			font-size: 1.2rem;
			font-weight: bold;
			margin-bottom: 15px;
			color: #6200ea;
		}
        
        #userInput {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #292929;
            color: #f0f0f0;
            font-size: 1.1rem;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #6200ea;
            color: white;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3700b3;
        }
        
        .loading {
            opacity: 0.6;
        }

		.history-panel {
			width: 250px;
			background: #292929;
			position: fixed;
			left: 0;
			top: 0;
			bottom: 0;
			padding: 90px 20px 20px 20px;
			transform: translateX(-280px);
			transition: transform 0.3s;
			z-index: 50;
			display: flex;
			flex-direction: column;
		}

		/* Ensure proper spacing for content sections */
		.history-header {
			flex: 0 0 auto;
			margin-bottom: 10px;
		}

		.history-controls {
			flex: 0 0 auto;
			margin-bottom: 10px;
		}


		.history-header h3 {
			margin: 0;
			color: #6200ea;
		}

		.history-footer {
			flex: 0 0 auto;
			padding-top: 10px;
			border-top: 1px solid #444;
			margin-top: auto;
		}
		
		.demo-info {
			font-size: 0.8em;
			color: #888;
		}


		.history-controls button {
			padding: 8px 12px;
			background: #292929;
			border: 1px solid #444;
			border-radius: 8px;
			color: white;
			cursor: pointer;
			transition: all 0.3s;
		}

		.history-controls button:hover {
			border-color: #6200ea;
		}

		#saved-debates {
			flex: 1 1 auto;
			overflow-y: auto;
			min-height: 100px;
			margin-bottom: 60px; /* Give space for the footer content */
		}

		.debate-item {
			position: relative;
			background: #333;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 5px;
			cursor: pointer;
			width: 100%;
			box-sizing: border-box;
			overflow: hidden; /* Add this to contain the wider image */
		}

		.debate-thumb {
			width: 150px !important;  /* Small fixed width */
			height: 65px !important;  /* Maintains roughly the 1900:820 ratio at this smaller size */
			object-fit: cover;
			border-radius: 4px;
			margin-bottom: 8px;
			display: block;  /* Ensures it sits nicely above the text */
		}
		
		.debate-topic {
			font-size: 14px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			padding-right: 30px; /* Make room for star */
			margin-bottom: 5px;
		}

		.star-btn {
			position: absolute;
			right: 10px;
			top: 10px;
			color: #666;
			cursor: pointer;
			z-index: 2;  /* Ensure star is above other elements */
			padding: 5px;  /* Larger click target */
			user-select: none;  /* Prevent text selection */
		}

		.star-btn.starred {
			color: #ffd700;
		}

		.debate-item .controls {
			display: flex;
			gap: 5px;
		}

		.debate-item .controls button {
			background: #444;
			border: none;
			color: #fff;
			padding: 3px 8px;
			border-radius: 3px;
			cursor: pointer;
			font-size: 0.9em;
		}

		.debate-text {
			width: calc(100% - 30px); /* Leave room for star */
		}


		.storage-info {
			font-size: 0.9em;
			color: #888;
			text-align: center;
		}

		#unlock-code {
			width: 100%;
			padding: 12px 15px;  /* Added right padding */
			margin: 15px 0;
			background: #292929;
			border: 1px solid #444;
			border-radius: 8px;
			color: white;
			font-size: 16px;
			text-transform: uppercase;
			box-sizing: border-box;
		}

		.unlock-btn {
			width: 100%;
			padding: 10px;
			background: #6200ea;
			border: none;
			border-radius: 8px;
			color: white;
			cursor: pointer;
			margin: 8px 0;  /* Adjusted margins to fit better */
		}

		.unlock-btn:hover {
			background: #7722ff;
		}

		.game-mode-btn {
			width: 100%;
			padding: 10px;
			background: #292929;
			border: 1px solid #444;
			border-radius: 8px;
			color: white;
			cursor: pointer;
			margin-top: 8px;
		}

		.history-panel.open {
			transform: translateX(0);
		}

		.history-toggle {
			position: absolute;  /* Added position */
			right: -30px;
			top: 50%;
			transform: translateY(-50%);  /* Center vertically */
			width: 30px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #6200ea;  /* Added background */
			border-radius: 0 5px 5px 0;  /* Added border radius */
			cursor: pointer;
		}



		.locked-feature {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.locked-feature::after {
			content: '🔒';
			margin-left: 5px;
		}

		/* Button alignment */
		.ai-expand-btn {
			background: #444;
			border: none;
			color: white;
			padding: 10px 15px;
			border-radius: 5px;
			margin-top: 15px;
			width: 100%;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.ai-expand-btn:hover {
			background: #555;
		}

		.ai-expand-btn.locked {
			background: #333;
			cursor: not-allowed;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.7);
			justify-content: center;
			align-items: center;
		}

		.modal-content {
			background-color: #1f1f2f;
			border: 1px solid #6200ea;
			border-radius: 8px;
			width: 600px;  /* Increased width for better content display */
			max-width: 90%;
			padding: 20px;
			position: relative;
			position: absolute;  /* Add this */
			top: 50%;          /* Add this */
			left: 50%;         /* Add this */
			transform: translate(-50%, -50%);  /* Add this */
		}

		.modal.show {
			display: flex;
		}

		#unlock-code {
			width: 100%;
			padding: 12px;
			margin: 15px 0;
			background: #292929;
			border: 1px solid #444;
			border-radius: 8px;
			color: white;
			font-size: 16px;
			text-transform: uppercase;
		}

		.close {
			position: absolute;
			right: 15px;
			top: 10px;
			color: white;
			font-size: 24px;
			cursor: pointer;
		}

		.secondary-btn {
			width: 100%;
			padding: 12px;
			margin: 5px 0;
			background: #292929;
			border: 1px solid #444;
			border-radius: 8px;
			color: white;
			cursor: pointer;
			transition: all 0.3s;
		}

		.secondary-btn:hover {
			border-color: #6200ea;
			background: #1f1f2f;
		}

		#registered-view {
			text-align: center;
		}

		#submit-code {
			width: 100%;
			padding: 12px;
			background: #6200ea;
			border: none;
			border-radius: 8px;
			color: white;
			cursor: pointer;
			margin: 15px 0;
			font-size: 16px;
		}

		#submit-code:hover {
			background: #7722ff;
		}

		.tab-pane {
			display: none;
			padding: 20px;
			background: #292929;
			border-radius: 8px;
			margin-top: 15px;
			max-height: 60vh;
			overflow-y: auto;
		}

		/* Tab button styling */
		.tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
		}

		.tab-btn {
			flex: 1;
			padding: 10px;
			background: #292929;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.tab-btn:hover {
			background: #333;
		}

		.tab-btn.active {
			background: #6200ea;
		}

		.tab-content {
			min-height: 100px;
			margin-bottom: 15px;
		}

		#copy-content {
			width: 100%;
			padding: 8px;
			background: #6200ea;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		.info-message {
			padding: 20px;
			color: #f0f0f0;
			background: #292929;
			border-radius: 8px;
			margin: 15px 0;
		}

		.info-message p {
			margin: 10px 0;
		}

		.mode-toggle {
			position: absolute;
			right: 80px; /* Position it near refresh button */
			top: 10px;
			display: flex;
			align-items: center;
			gap: 8px;
			background: rgba(0, 0, 0, 0.6);
			padding: 5px 10px;
			border-radius: 20px;
			cursor: pointer;
		}

		.mode-toggle.game-active {
			background: rgba(98, 0, 234, 0.6);
		}

		.panel-vote-button {
			width: 100%;
			padding: 10px;
			margin-top: 10px;
			border: 2px solid transparent;
			border-radius: 5px;
			cursor: pointer;
			transition: all 0.3s;
		}

		.panel-vote-button.voted {
			border-color: #4CAF50;
			background: rgba(76, 175, 80, 0.2);
		}

		.panel-vote-button.not-voted {
			border-color: #f44336;
			background: rgba(244, 67, 54, 0.2);
		}

		.resultPanel.voted {
			border: 2px solid #4CAF50;
		}

		.resultPanel.not-voted {
			border: 2px solid #f44336;
		}

		.game-badge {
			background: #6200ea;
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 0.9em;
			margin-bottom: 8px;
		}

		.in-progress {
			color: #4CAF50;
			font-weight: bold;
		}

		.game-history {
			background: #2d2d2d;
			border-left: 4px solid #6200ea;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.loading-spinner {
			width: 50px;
			height: 50px;
			border: 5px solid #f3f3f3;
			border-top: 5px solid #6200ea;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		.thinking {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 1.2rem;
			color: #6200ea;
		}

        @media (max-height: 800px) {
            #conceptImage {
                height: 30vh;
            }
            .resultPanel {
                min-height: 120px;
            }
            #results {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div id="nav-container"></div>
    
	<div class="history-panel">
		<div class="history-toggle">≡</div>
		<div class="history-header">
			<h3>Saved Debates</h3>
			<span class="demo-info">(3 max in demo)</span>
		</div>
		<div class="history-controls">
			<button class="sort-btn" title="Sort by Date">
				<span>Sort</span> ↕️
			</button>
			<button class="clear-btn" title="Clear All">
				🗑️
			</button>
		</div>
		<div id="saved-debates"></div>
		<div class="history-footer">
			<div class="storage-info">
				<span id="used-slots">0</span>/<span id="total-slots">3</span> slots used
			</div>
			<button id="unlock-more" class="unlock-btn">🔓 Unlock More Slots</button>
			<button id="game-mode" class="game-mode-btn">🎮 Game Mode</button>
		</div>
	</div>
    
    <main>
        <div class="concept-container">
            <div class="image-container">
                <img id="conceptImage" alt="Concept visualization">
                <div id="imageSpinner" class="loading-spinner" style="display: none;"></div>
				<div class="refresh-button" title="Generate new image">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
						<path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
					</svg>
				</div>
            </div>
            <div id="conceptCaption"></div>
        </div>

        <div id="results">
            <div class="resultPanel">
                <div class="panel-title">POINT</div>
                <div id="pointOutput"></div>
				<button class="ai-expand-btn locked" data-type="point" onclick="expandAIAnalysis('point')">
					Get Extended Point Analysis 🔒
				</button>
            </div>
            
            <div class="resultPanel">
                <div class="panel-title">COUNTERPOINT</div>
                <div id="counterOutput"></div>
				<button class="ai-expand-btn locked" data-type="counterpoint" onclick="expandAIAnalysis('counterpoint')">
					Get Extended Counterpoint Analysis 🔒
				</button>
            </div>
        </div>

        <div id="userInput">
            <input type="text" id="topicInput" placeholder="Type your topic..." onkeypress="handleKeyPress(event)">
            <button onclick="sendRequest()">SEND</button>
        </div>
    </main>

	<!-- Analysis Modal -->
	<div id="ai-modal" class="modal">
		<div class="modal-content">
			<span class="close">&times;</span>
			<div class="tabs">
				<button class="tab-btn active" data-tab="prose">Full Prose</button>
				<button class="tab-btn" data-tab="points">Talking Points</button>
			</div>
			<div class="tab-content">
					<div class="info-message">
					<div style="text-align: left;">
						<p>🎯 <strong>Full Prose:</strong> Get a comprehensive, essay-style expansion of your argument with deeper context and supporting evidence.</p>
						<p>📝 <strong>Talking Points:</strong> Receive a concise, bullet-point breakdown perfect for quick reference in debates and discussions.</p>
					</div>
					</div>
				<div id="prose-content" class="tab-pane active"></div>
				<div id="points-content" class="tab-pane"></div>
			</div>
			<button id="copy-content">Copy to Clipboard</button>
		</div>
	</div>
				
    <!-- Registration Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Enter Unlock Code</h2>
            <div id="registration-view">
                <p>Please enter your 6-character unlock code:</p>
                <input type="text" id="unlock-code" maxlength="6" placeholder="XXXXXX">
                <p id="code-error" class="error"></p>
                <button id="submit-code">Submit</button>
                <div class="code-actions">
                    <button id="get-code-btn" class="secondary-btn">Get Free Code</button>
                    <button id="donate-btn" class="secondary-btn">❤️ Support Development</button>
                </div>
            </div>
            <div id="registered-view" style="display: none;">
                <p>Currently registered with code:</p>
                <p id="current-code" class="code-display"></p>
                <button id="return-to-demo" class="warning-btn">Return to Demo Mode</button>
                <button id="donate-btn-reg" class="secondary-btn">❤️ Support Development</button>
            </div>
        </div>
    </div>

	<!-- Add this to your HTML -->
	<div id="game-intro-modal" class="modal">
		<div class="modal-content">
			<span class="close">×</span>
			<h2>🎮 Welcome to Debate Analysis Mode!</h2>
			<div class="info-message">
				<p>In this mode, you'll:</p>
				<ul style="text-align: left; margin: 20px 0; list-style: none;">
					<li>👍 Vote on which side of each debate you agree with</li>
					<li>🧠 Build a profile of your views and decision patterns</li>
					<li>🏆 Unlock achievements as you explore different topics</li>
					<li>📊 Track your stance on various issues</li>
				</ul>
				<p>Each vote helps build your personality matrix and reveals insights about your decision-making style.</p>
			</div>
			<button id="start-game" class="secondary-btn" style="background: #6200ea;">Start Game Mode</button>
		</div>
	</div>

    <script>
        let currentTopic = '';

		const APP_NAME = 'point-counterpoint';  // Unique identifier for this app
		const REGISTERED_KEY = `${APP_NAME}_registered`;
		const UNLOCK_CODE_KEY = `${APP_NAME}_unlock_code`;
		const DEMO_MAX_SAVES = 3;
		const REGISTERED_MAX_SAVES = 30;
		const DEMO_MAX_STARS = 1;
		const REGISTERED_MAX_STARS = 30;
		const DEFAULT_IMAGE = './counterpoint_logo.jpg';
        const DEFAULT_IMAGE_PROMPT = "3D text showing COUNTERPOINT with two dramatic faces in intense debate, one passionate and one opposing, extreme expressions with open mouths yelling at each other, dramatic lighting, metallic red text, dark background";
		const GAME_DATA_KEY = `${APP_NAME}_game_data`;

		const GAME_CATEGORIES = {
			ethics: [
				"Should lying ever be justified?",
				"Is genetic engineering ethical?",
				"Should privacy be sacrificed for security?",
				// Add more ethical dilemmas
			],
			social: [
				"Should social media be regulated?",
				"Is remote work better than office work?",
				"Should college be free?",
				// Add more social topics
			],
			technology: [
				"Are AI assistants beneficial to society?",
				"Should cryptocurrency be mainstream?",
				"Is space exploration worth the cost?",
				// Add more tech topics
			],
			philosophy: [
				"Does free will exist?",
				"Is happiness more important than truth?",
				"Should we prioritize individual or collective good?",
				// Add more philosophical questions
			]
		};

        // Function to convert image URL to base64
		async function imageUrlToBase64(url) {
			try {
				const response = await fetch(url);
				const blob = await response.blob();
				return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onloadend = () => resolve(reader.result);
					reader.onerror = reject;
					reader.readAsDataURL(blob);
				});
			} catch (error) {
				console.error('Error converting image to base64:', error);
				return null;
			}
		}

		// Check registration status and update UI accordingly
		function checkRegistrationStatus() {
			const isRegistered = localStorage.getItem(REGISTERED_KEY) === 'true';
			const unlockCode = localStorage.getItem(UNLOCK_CODE_KEY);
			
			// Update UI based on registration status
			if (isRegistered && unlockCode) {
				// Update unlock button text
				const unlockButton = document.getElementById('unlock-more');
				unlockButton.textContent = '✅ REGISTERED';
				unlockButton.style.backgroundColor = '#28a745';
				
				// Update AI expand buttons - FIXED THIS PART
				document.querySelectorAll('.ai-expand-btn').forEach(btn => {
					btn.classList.remove('locked');
					btn.textContent = btn.textContent.replace(' 🔒', '');  // Added space before 🔒
				});
				
				// Update registration view
				const registrationView = document.getElementById('registration-view');
				const registeredView = document.getElementById('registered-view');
				if (registrationView && registeredView) {
					registrationView.style.display = 'none';
					registeredView.style.display = 'block';
					const currentCodeElement = document.getElementById('current-code');
					if (currentCodeElement) {
						currentCodeElement.textContent = unlockCode;
					}
				}
				
				// Update history panel
				document.querySelector('.demo-info').style.display = 'none';
				const totalSlots = document.getElementById('total-slots');
				if (totalSlots) {
					totalSlots.textContent = REGISTERED_MAX_SAVES;
				}
			}
		}

		// Handle registration submission
		function handleRegistration(code) {
			if (!isValidFormat(code)) {
				document.getElementById('code-error').textContent = 'Code must be 6 alphanumeric characters';
				return false;
			}
			
			if (isTooSimple(code)) {
				document.getElementById('code-error').textContent = 'Invalid code format. Try something more complex.';
				return false;
			}
			
			// Store registration
			localStorage.setItem(REGISTERED_KEY, 'true');
			localStorage.setItem(UNLOCK_CODE_KEY, code);
			
			// Update UI
			checkRegistrationStatus();
			
			// Close modal
			document.getElementById('register-modal').classList.remove('show');
			document.getElementById('unlock-code').value = '';
			document.getElementById('code-error').textContent = '';
			
			return true;
		}

		async function storeDefaultImage() {
			document.getElementById('imageSpinner').style.display = 'block';
			try {
				const imageUrl = await generateImage(DEFAULT_IMAGE_PROMPT);
				const base64 = await imageUrlToBase64(imageUrl);
				localStorage.setItem('defaultDebateImage', base64);
				document.getElementById('conceptImage').src = base64;
				document.getElementById('conceptImage').classList.add('loaded');
			} catch (error) {
				console.error('Error storing default image:', error);
			} finally {
				document.getElementById('imageSpinner').style.display = 'none';
			}
		}

		function getRandomTopic() {
			const categories = Object.keys(GAME_CATEGORIES);
			const randomCategory = categories[Math.floor(Math.random() * categories.length)];
			const topics = GAME_CATEGORIES[randomCategory];
			return {
				topic: topics[Math.floor(Math.random() * topics.length)],
				category: randomCategory
			};
		}

		function startGameMode() {
			const gameData = getGameData();
			gameData.inProgress = true;
			gameData.currentSession = {
				startTime: Date.now(),
				topicsAnswered: 0,
				categoriesExplored: new Set(),
				responses: []
			};
			localStorage.setItem(GAME_DATA_KEY, JSON.stringify(gameData));
			
			// Generate first topic
			generateNextGameTopic();
		}

		async function generateNextGameTopic() {
			const { topic, category } = getRandomTopic();
			document.getElementById('topicInput').value = topic;
			await sendRequest(); // This will generate the image and points/counterpoints
			
			// Add summary button if it doesn't exist
			if (!document.querySelector('#game-summary-btn')) {
				const summaryBtn = document.createElement('button');
				summaryBtn.id = 'game-summary-btn';
				summaryBtn.innerHTML = '📊 View Progress';
				summaryBtn.className = 'secondary-btn';
				summaryBtn.style.marginTop = '20px';
				document.querySelector('#userInput').appendChild(summaryBtn);
				
				summaryBtn.addEventListener('click', showGameSummary);
			}
		}

		function handleGameVote(choice) {
			const gameData = getGameData();
			const currentTopic = document.getElementById('topicInput').value;
			
			// Store the vote
			gameData.currentSession.responses.push({
				topic: currentTopic,
				choice: choice,
				timestamp: Date.now()
			});
			gameData.currentSession.topicsAnswered++;
			
			localStorage.setItem(GAME_DATA_KEY, JSON.stringify(gameData));
			
			// Generate next topic after short delay
			setTimeout(generateNextGameTopic, 1000);
		}

		function showGameSummary() {
			const gameData = getGameData();
			const modal = document.createElement('div');
			modal.className = 'modal show';
			modal.innerHTML = `
				<div class="modal-content">
					<span class="close">×</span>
					<h2>🎮 Game Progress</h2>
					<div class="game-stats">
						<p>Topics Answered: ${gameData.currentSession.topicsAnswered}</p>
						<p>Categories Explored: ${gameData.currentSession.categoriesExplored.size}</p>
						<p>Time Played: ${formatTimePlayed(gameData.currentSession.startTime)}</p>
					</div>
					<div class="game-actions">
						<button onclick="continueGame()">Continue Playing</button>
						<button onclick="endGame()">End Game</button>
					</div>
				</div>
			`;
			document.body.appendChild(modal);
		}

		function sortDebates(order = 'newest') {
			let savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			savedDebates.sort((a, b) => {
				return order === 'newest' ? 
					new Date(b.date) - new Date(a.date) : 
					new Date(a.date) - new Date(b.date);
			});
			localStorage.setItem(`${APP_NAME}_debates`, JSON.stringify(savedDebates));
			updateHistoryPanel();
		}

		function clearAllDebates() {
			if (confirm('Are you sure you want to clear all saved debates?')) {
				localStorage.setItem(`${APP_NAME}_debates`, '[]');
				updateHistoryPanel();
			}
		}

		// Show game stats
		function updateGameStats() {
			const gameData = getGameData();
			// You can add a stats display here later
			console.log('Game Stats:', {
				'Total Votes': Object.keys(gameData.votes).length,
				'Streak Days': gameData.streakDays,
				'Categories': gameData.categories
			});
		}

		// Initialize game features when topic loads
		function initializeGameFeatures() {
			const gameData = getGameData();
			gameData.inProgress = true;
			gameData.currentSession = {
				id: Date.now(),
				startTime: Date.now(),
				topics: [],
				votes: [],
				patterns: {
					ethics: 0,
					social: 0,
					technology: 0,
					philosophy: 0
				}
			};
			localStorage.setItem(GAME_DATA_KEY, JSON.stringify(gameData));

			// Clear welcome text
			document.getElementById('pointOutput').innerHTML = '';
			document.getElementById('counterOutput').innerHTML = '';

			// Immediately generate first topic
			generateNextGameTopic();
		}

		function saveGameToHistory(gameData) {
			const savedGames = JSON.parse(localStorage.getItem(`${APP_NAME}_game_history`) || '[]');
			const gameHistory = {
				id: gameData.currentSession.id,
				date: new Date().toISOString(),
				lastActive: Date.now(),
				inProgress: true,
				stats: {
					topicsAnswered: gameData.currentSession.votes.length,
					patterns: gameData.currentSession.patterns
				},
				rounds: gameData.currentSession.votes.map(vote => ({
					topic: vote.topic,
					choice: vote.choice,
					timestamp: vote.timestamp
				}))
			};
			
			// Update if exists, otherwise add new
			const existingIndex = savedGames.findIndex(g => g.id === gameHistory.id);
			if (existingIndex >= 0) {
				savedGames[existingIndex] = gameHistory;
			} else {
				savedGames.unshift(gameHistory);
			}
			
			localStorage.setItem(`${APP_NAME}_game_history`, JSON.stringify(savedGames));
		}

		// Handle voting
		function handleVote(panelId) {
			const gameData = getGameData();
			const today = new Date().toDateString();
			const currentContent = document.getElementById(panelId).innerText;
			const currentPanel = document.getElementById(panelId).closest('.resultPanel');
			const otherPanel = currentPanel.nextElementSibling || currentPanel.previousElementSibling;

			// Update streak if it's a new day
			if (gameData.lastVoteDate !== today) {
				gameData.streakDays++;
				gameData.lastVoteDate = today;
			}

			// Analyze the content for categories and values
			const contentAnalysis = analyzeContent(currentContent);
			
			// Store the vote with analysis
			if (!gameData.currentSession) {
				gameData.currentSession = {
					startTime: Date.now(),
					topics: [],
					votes: [],
					patterns: {
						ethics: 0,
						social: 0,
						technology: 0,
						philosophy: 0
					}
				};
			}

			gameData.currentSession.votes.push({
				topic: currentTopic,
				choice: panelId,
				content: currentContent,
				analysis: contentAnalysis,
				timestamp: Date.now()
			});

			// Update pattern tracking
			Object.keys(contentAnalysis.categories).forEach(category => {
				if (contentAnalysis.categories[category]) {
					gameData.currentSession.patterns[category]++;
				}
			});

			// Save updated game data
			localStorage.setItem(GAME_DATA_KEY, JSON.stringify(gameData));

			// Visual feedback
			currentPanel.style.border = '2px solid #4CAF50';
			currentPanel.querySelector('.vote-button').style.background = '#4CAF50';
			otherPanel.style.border = '2px solid #f44336';
			otherPanel.querySelector('.vote-button').style.background = '#f44336';

			// Generate next topic after delay
			setTimeout(generateNextGameTopic, 1500);
		}

		function analyzeContent(content) {
			const analysis = {
				categories: {
					ethics: false,
					social: false,
					technology: false,
					philosophy: false
				},
				sentiment: 0,
				keywords: []
			};

			// Simple keyword analysis
			const ethicsWords = ['moral', 'right', 'wrong', 'ethical', 'justice', 'fair'];
			const socialWords = ['society', 'community', 'people', 'social', 'public'];
			const techWords = ['technology', 'digital', 'innovation', 'scientific', 'technical'];
			const philosophyWords = ['meaning', 'truth', 'reality', 'consciousness', 'existence'];

			const contentLower = content.toLowerCase();

			analysis.categories.ethics = ethicsWords.some(word => contentLower.includes(word));
			analysis.categories.social = socialWords.some(word => contentLower.includes(word));
			analysis.categories.technology = techWords.some(word => contentLower.includes(word));
			analysis.categories.philosophy = philosophyWords.some(word => contentLower.includes(word));

			return analysis;
		}

		function updateResultsPanel() {
			const isGameMode = localStorage.getItem('gameMode') === 'true';
			const pointPanel = document.getElementById('pointOutput');
			const counterPanel = document.getElementById('counterOutput');
			const gameData = getGameData();

			// Don't modify panels if they contain welcome text
			if (pointPanel.textContent.includes('Welcome!') || 
				counterPanel.textContent.includes('Welcome!')) {
				if (isGameMode) {
					// If in game mode and showing welcome text, start a new topic
					generateNextGameTopic();
				}
				return;
			}

			if (isGameMode) {
				// Add vote buttons if they don't exist
				['pointOutput', 'counterOutput'].forEach(panelId => {
					const panel = document.getElementById(panelId);
					const parentPanel = panel.closest('.resultPanel');
					
					if (!parentPanel.querySelector('.vote-button')) {
						const button = document.createElement('button');
						button.className = 'vote-button';
						button.innerHTML = '👍 I Agree With This';
						button.style.width = '100%';
						button.style.marginTop = '15px';
						button.style.padding = '10px';
						button.style.background = '#333';
						button.style.border = '1px solid #444';
						button.style.borderRadius = '5px';
						button.style.cursor = 'pointer';
						button.onclick = () => handleVote(panelId);
						parentPanel.appendChild(button);
					}
				});

				// Show any previous votes
				if (gameData.votes[currentTopic]) {
					const votedPanelId = gameData.votes[currentTopic];
					const panels = document.querySelectorAll('.resultPanel');
					panels.forEach(panel => {
						const isVotedPanel = panel.querySelector(`#${votedPanelId}`);
						if (isVotedPanel) {
							panel.style.border = '2px solid #4CAF50';
							panel.querySelector('.vote-button').style.background = '#4CAF50';
						} else {
							panel.style.border = '2px solid #f44336';
							panel.querySelector('.vote-button').style.background = '#f44336';
						}
					});
				}
			} else {
				// Remove vote buttons and styling if game mode is off
				document.querySelectorAll('.vote-button').forEach(btn => btn.remove());
				document.querySelectorAll('.resultPanel').forEach(panel => {
					panel.style.border = 'none';
				});
			}
		}

		function showGameSummary() {
			const gameData = getGameData();
			if (!gameData.currentSession) return;

			// Calculate pattern percentages
			const totalVotes = gameData.currentSession.votes.length;
			const patterns = gameData.currentSession.patterns;
			const percentages = {};
			Object.keys(patterns).forEach(category => {
				percentages[category] = totalVotes > 0 ? 
					Math.round((patterns[category] / totalVotes) * 100) : 0;
			});

			const timePlayed = Math.floor((Date.now() - gameData.currentSession.startTime) / 60000);

			const modal = document.createElement('div');
			modal.className = 'modal show';
			modal.innerHTML = `
				<div class="modal-content">
					<span class="close" onclick="this.closest('.modal').remove()">×</span>
					<h2>🎮 Game Analysis</h2>
					<div class="game-stats">
						<p>Topics Analyzed: ${totalVotes}</p>
						<p>Time Active: ${timePlayed} minutes</p>
						<div class="pattern-breakdown">
							<h3>Decision Pattern Breakdown:</h3>
							<p>Ethics Focus: ${percentages.ethics}%</p>
							<p>Social Focus: ${percentages.social}%</p>
							<p>Technology Focus: ${percentages.technology}%</p>
							<p>Philosophy Focus: ${percentages.philosophy}%</p>
						</div>
					</div>
					<div class="game-actions">
						<button onclick="continueGame()" class="secondary-btn">Continue Playing</button>
						<button onclick="endGame()" class="secondary-btn">End Game</button>
					</div>
				</div>
			`;
			document.body.appendChild(modal);
		}

		function continueGame() {
			document.querySelector('.modal.show').remove();
			generateNextGameTopic();
		}

		function endGame() {
			const gameData = getGameData();
			if (gameData.currentSession) {
				saveGameToHistory(gameData);
			}
			localStorage.setItem('gameMode', 'false');
			document.getElementById('game-mode').style.background = '#292929';
			window.location.reload();
		}

		// Function to initialize or get game data
		function getGameData() {
			return JSON.parse(localStorage.getItem(GAME_DATA_KEY) || JSON.stringify({
				votes: {},          // Store vote history
				streakDays: 0,      // Track daily participation
				lastVoteDate: null, // Track when last voted
				categories: {       // Track category participation
					ethics: 0,
					social: 0,
					technology: 0,
					philosophy: 0,
					controversial: 0
				}
			}));
		}

		// Update the updateHistoryPanel function to include more info
		function updateHistoryPanel() {
			const container = document.getElementById('saved-debates');
			const savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			const savedGames = JSON.parse(localStorage.getItem(`${APP_NAME}_game_history`) || '[]');
			const isRegistered = localStorage.getItem(REGISTERED_KEY) === 'true';
			
			// Update slots info
			const totalSlots = isRegistered ? REGISTERED_MAX_SAVES : DEMO_MAX_SAVES;
			document.getElementById('used-slots').textContent = savedDebates.length;
			document.getElementById('total-slots').textContent = totalSlots;
			
			let html = '';

			// Add games first
			savedGames.forEach(game => {
				html += `
					<div class="debate-item game-history" onclick="loadGame(${game.id})">
						<div class="game-badge">🎮 Analysis Game</div>
						<div class="game-stats">
							<span>Topics: ${game.stats.topicsAnswered}</span>
							${game.inProgress ? '<span class="in-progress">In Progress</span>' : ''}
						</div>
						<span class="star-btn ${game.starred ? 'starred' : ''}" 
							  onclick="event.stopPropagation(); toggleStar(${game.id}, 'game')">⭐</span>
					</div>
				`;
			});

			// Then add regular debates
			savedDebates.forEach(debate => {
				html += `
					<div class="debate-item" onclick="loadDebate(${debate.id})">
						<img src="${debate.image}" alt="${debate.topic}" class="debate-thumb">
						<div class="debate-topic">${debate.topic}</div>
						<span class="star-btn ${debate.starred ? 'starred' : ''}" 
							  onclick="event.stopPropagation(); toggleStar(${debate.id})">⭐</span>
						<div class="controls">
							<button onclick="event.stopPropagation(); renameDebate(${debate.id})">✏️</button>
							${isRegistered ? `<button onclick="event.stopPropagation(); deleteDebate(${debate.id})">🗑️</button>` : ''}
						</div>
					</div>
				`;
			});
			
			container.innerHTML = html || '<div class="no-debates">No saved debates yet</div>';
		}

		function loadGame(gameId) {
			const savedGames = JSON.parse(localStorage.getItem(`${APP_NAME}_game_history`) || '[]');
			const game = savedGames.find(g => g.id === gameId);
			
			if (game) {
				localStorage.setItem('gameMode', 'true');
				document.getElementById('game-mode').style.background = '#6200ea';
				
				const gameData = getGameData();
				gameData.currentSession = {
					id: game.id,
					startTime: game.startTime,
					topics: game.rounds.map(r => r.topic),
					votes: game.rounds,
					patterns: game.stats.patterns
				};
				localStorage.setItem(GAME_DATA_KEY, JSON.stringify(gameData));
				
				initializeGameFeatures();
			}
		}

		function renameDebate(id) {
			const savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			const debate = savedDebates.find(d => d.id === id);
			if (debate) {
				const newTopic = prompt('Enter new name for this debate:', debate.topic);
				if (newTopic && newTopic.trim()) {
					debate.topic = newTopic.trim();
					localStorage.setItem(`${APP_NAME}_debates`, JSON.stringify(savedDebates));
					updateHistoryPanel();
				}
			}
		}

        async function generateImage(prompt) {
            const seed = Math.floor(Math.random() * 1000000);
            const encodedPrompt = encodeURIComponent(prompt);
            return `https://image.pollinations.ai/prompt/${encodedPrompt}?nologo=true&private=true&enhance=true&seed=${seed}&width=2048&height=1152`;
        }

		async function refreshImage() {
			const isDefaultImage = !currentTopic && (!document.getElementById('conceptCaption').innerText);
			document.getElementById('imageSpinner').style.display = 'block';
			const refreshButton = document.querySelector('.refresh-button');
			refreshButton.style.backgroundColor = 'rgba(98, 0, 234, 0.6)';
			refreshButton.style.pointerEvents = 'none';
			
			try {
				const prompt = isDefaultImage ? DEFAULT_IMAGE_PROMPT : currentTopic;
				const newImageUrl = await generateImage(prompt);
				const base64 = await imageUrlToBase64(newImageUrl);
				
				if (isDefaultImage) {
					localStorage.setItem('defaultDebateImage', base64);
				} else {
					// Update the current debate's image in storage
					let savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
					const currentDebate = savedDebates.find(d => d.topic === currentTopic);
					if (currentDebate) {
						currentDebate.image = base64;
						localStorage.setItem(`${APP_NAME}_debates`, JSON.stringify(savedDebates));
						updateHistoryPanel(); // Refresh the history panel display
					}
				}
				
				document.getElementById('conceptImage').src = base64;
				document.getElementById('conceptImage').classList.add('loaded');
			} catch (error) {
				console.error('Error refreshing image:', error);
			} finally {
				document.getElementById('imageSpinner').style.display = 'none';
				refreshButton.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
				refreshButton.style.pointerEvents = 'auto';
			}
		}

		async function sendRequest() {
			const topic = document.getElementById('topicInput').value;
			const refreshButton = document.querySelector('.refresh-button');
			
			if (!topic) {
				document.getElementById('conceptImage').src = localStorage.getItem('defaultDebateImage');
				refreshButton.style.display = 'none';  // HIDE the button completely
				return;
			}

			// Show refresh button with topic
			refreshButton.style.display = 'block';

			currentTopic = topic;

			// Clear previous outputs and show loading state
			document.getElementById('conceptImage').classList.add('loading');
			document.getElementById('pointOutput').innerText = 'Generating...';
			document.getElementById('counterOutput').innerText = 'Generating...';

			// Update caption and generate image
			document.getElementById('conceptCaption').innerText = topic;
			const imageUrl = await generateImage(topic);
			const base64Image = await imageUrlToBase64(imageUrl);  // Convert to base64 immediately
			document.getElementById('conceptImage').src = base64Image;
			document.getElementById('conceptImage').classList.remove('loading');

			const systemPrompts = {
				point: "You are a fierce advocate arguing IN FAVOR of the given topic. Make ONE strong, compelling argument SUPPORTING and DEFENDING the topic in a SINGLE short paragraph (max 3 sentences). Be absolutely convinced of your position and use powerful language to advocate FOR it.",
				counter: "You are a passionate opponent arguing AGAINST the given topic. Make ONE strong argument OPPOSING and ATTACKING the topic in a SINGLE short paragraph (max 3 sentences). Be absolutely convinced of your position and use powerful language to argue AGAINST it."
			};

			// Generate point and counterpoint in parallel
			const [pointResponse, counterResponse] = await Promise.all([
				fetchResponse(topic, systemPrompts.point, 'pointOutput'),
				fetchResponse(topic, systemPrompts.counter, 'counterOutput')
			]);

			// Save the debate after successful generation
			if (pointResponse && counterResponse) {
				// Save debate with the already converted base64 image
				saveDebate(
					topic,
					pointResponse,
					counterResponse,
					base64Image  // Use the base64 we already created
				);
			}

			document.getElementById('topicInput').value = '';
		}

        async function fetchResponse(topic, systemPrompt, outputId) {
            try {
                const response = await fetch('https://text.pollinations.ai/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: topic }
                        ],
                        model: 'openai',
                        seed: Math.floor(Math.random() * 1000)
                    })
                });

                const data = await response.json();
                const content = data?.choices?.[0]?.message?.content || 'Error generating response';
                document.getElementById(outputId).innerText = content;
                return content;
            } catch (error) {
                document.getElementById(outputId).innerText = 'Error generating response';
                console.error('Error:', error);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendRequest();
            }
        }

		// Save and load debates
		function saveDebate(topic, pointText, counterpointText, imageData) {
			const isRegistered = localStorage.getItem(REGISTERED_KEY) === 'true';
			let savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			
			const debate = {
				id: Date.now(),
				topic,
				point: pointText,
				counterpoint: counterpointText,
				image: imageData,
				starred: false,  // Make sure stars start as false
				date: new Date().toISOString()
			};

			savedDebates.unshift(debate);
			
			// Limit based on registration status, but keep starred items
			const maxSaves = isRegistered ? REGISTERED_MAX_SAVES : DEMO_MAX_SAVES;
			
			// First keep all starred items
			const starredDebates = savedDebates.filter(d => d.starred);
			const unstarredDebates = savedDebates.filter(d => !d.starred);
			
			// Then trim unstarred items to fit remaining slots
			const remainingSlots = maxSaves - starredDebates.length;
			const trimmedUnstarred = unstarredDebates.slice(0, Math.max(0, remainingSlots));
			
			// Combine starred and trimmed unstarred items
			savedDebates = [...starredDebates, ...trimmedUnstarred];
			
			localStorage.setItem(`${APP_NAME}_debates`, JSON.stringify(savedDebates));
			updateHistoryPanel();
		}

		function loadDebate(id) {
			const savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			const debate = savedDebates.find(d => d.id === id);
			if (debate) {

				document.getElementById('pointOutput').innerText = debate.point;
				document.getElementById('counterOutput').innerText = debate.counterpoint;
				document.getElementById('conceptImage').src = debate.image || localStorage.getItem('defaultDebateImage');
				document.getElementById('conceptCaption').innerText = debate.topic;
				currentTopic = debate.topic;
				
				// If debate has default image, generate a new one
				if (!debate.image || debate.image === localStorage.getItem('defaultDebateImage')) {
					refreshImage(); // This will now update storage and UI
				}
			}
		}

		function toggleStar(id) {
			const isRegistered = localStorage.getItem(REGISTERED_KEY) === 'true';
			let savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			const debateIndex = savedDebates.findIndex(d => d.id === id);
			
			if (debateIndex !== -1) {
				// Count current starred items
				const starredCount = savedDebates.filter(d => d.starred).length;
				const maxStars = isRegistered ? REGISTERED_MAX_STARS : DEMO_MAX_STARS;
				
				// Only allow starring if under limit or if this item is already starred
				if (!savedDebates[debateIndex].starred || starredCount < maxStars) {
					savedDebates[debateIndex].starred = !savedDebates[debateIndex].starred;
					localStorage.setItem(`${APP_NAME}_debates`, JSON.stringify(savedDebates));
					updateHistoryPanel();
				}
			}
		}

		function deleteDebate(id) {
			let savedDebates = JSON.parse(localStorage.getItem(`${APP_NAME}_debates`) || '[]');
			savedDebates = savedDebates.filter(d => d.id !== id);
			localStorage.setItem(`${APP_NAME}_debates`, JSON.stringify(savedDebates));
			updateHistoryPanel();
		}

		// AI expansion functionality
		async function expandAIAnalysis(type) {
			const isRegistered = localStorage.getItem(REGISTERED_KEY) === 'true';
			if (!isRegistered) {
				showRegistrationPrompt();
				return;
			}
			
			const content = document.getElementById(`${type}Output`).innerText;
			
			// Reset modal content first
			document.getElementById('prose-content').innerHTML = '';
			document.getElementById('points-content').innerHTML = '';
			
			// Check if there's actual generated content (not the welcome message)
			if (!content || content.includes('Welcome!') || content.includes('This panel will show')) {
				document.getElementById('ai-modal').classList.add('show');
				document.querySelector('.info-message').style.display = 'block';
				document.getElementById('prose-content').style.display = 'none';
				document.getElementById('points-content').style.display = 'none';
				document.getElementById('copy-content').style.display = 'none';
				return;
			}
			
			// Show loading state in modal
			document.querySelector('.info-message').style.display = 'none';
			document.getElementById('prose-content').style.display = 'block';
			document.getElementById('points-content').style.display = 'none';
			document.getElementById('copy-content').style.display = 'block';
			document.getElementById('prose-content').innerHTML = 'Generating detailed analysis...';
			document.getElementById('points-content').innerHTML = 'Preparing talking points...';
			document.getElementById('ai-modal').classList.add('show');
			
			try {
				const response = await fetch('https://text.pollinations.ai/openai', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						messages: [
							{
								role: 'system',
								content: `Analyze this ${type} and provide two sections:
		1) A comprehensive prose expansion of the argument
		2) A numbered list of key talking points
		Separate the sections with [SECTION_BREAK]`
							},
							{ role: 'user', content }
						],
						model: 'openai'
					})
				});
				
				const data = await response.json();
				const expandedContent = data.choices[0].message.content;
				
				if (expandedContent.includes('[SECTION_BREAK]')) {
					const [prose, points] = expandedContent.split('[SECTION_BREAK]');
					document.getElementById('prose-content').innerHTML = prose.trim();
					document.getElementById('points-content').innerHTML = points.trim();
				} else {
					document.getElementById('prose-content').innerHTML = expandedContent;
					document.getElementById('points-content').innerHTML = 'No specific talking points provided.';
				}
			} catch (error) {
				console.error('Error:', error);
				document.getElementById('prose-content').innerHTML = 'Failed to generate analysis.';
				document.getElementById('points-content').innerHTML = 'Failed to generate talking points.';
			}
		}
		
		function showRegistrationPrompt() {
			document.getElementById('register-modal').classList.add('show');
		}

		function generateUnlockCode() {
			const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
			let code;
			do {
				code = '';
				for(let i = 0; i < 6; i++) {
					code += chars[Math.floor(Math.random() * chars.length)];
				}
			} while(isTooSimple(code));
			return code;
		}

		function isTooSimple(code) {
			const invalidCodes = [
				'123456', '012345', '543210', '654321', '111111', '222222',
				'333333', '444444', '555555', '666666', '777777', '888888',
				'999999', '000000', 'AAAAAA', 'BBBBBB', 'CCCCCC', 'DDDDDD',
				'EEEEEE', 'FFFFFF'
			];
			return invalidCodes.includes(code) || /^(.)\1+$/.test(code);
		}

		// Update submit code handler
		document.getElementById('submit-code').onclick = () => {
			const code = document.getElementById('unlock-code').value.toUpperCase();
			handleRegistration(code);
		};

		// Add this helper function
		function isValidFormat(code) {
			return /^[A-Z0-9]{6}$/.test(code);
		}

		// Handle voting
		document.addEventListener('click', (e) => {
			if (e.target.classList.contains('panel-vote-button')) {
				const panel = e.target.closest('.resultPanel');
				const otherPanel = panel.nextElementSibling || panel.previousElementSibling;
				
				// Visual feedback
				panel.classList.add('voted');
				otherPanel.classList.add('not-voted');
				e.target.classList.add('voted');
				otherPanel.querySelector('.panel-vote-button').classList.add('not-voted');
				
				// Store choice
				const choice = {
					topic: currentTopic,
					timestamp: Date.now(),
					choice: panel.querySelector('.panel-title').textContent,
					category: detectCategory(currentTopic)  // We'll need to create this function
				};
				
				let choices = JSON.parse(localStorage.getItem('userChoices') || '[]');
				choices.push(choice);
				localStorage.setItem('userChoices', JSON.stringify(choices));
			}
		});
			
		// Initialize event listeners
		document.addEventListener('DOMContentLoaded', () => {
			document.getElementById('topicInput').value = ''; 
			
			// Check registration status on page load
			checkRegistrationStatus();
			
			// Update unlock button click handler
			document.getElementById('unlock-more').addEventListener('click', () => {
				const isRegistered = localStorage.getItem(REGISTERED_KEY) === 'true';
				if (!isRegistered) {
					showRegistrationPrompt();
				}
			});

			document.getElementById('donate-btn').onclick = 
			document.getElementById('donate-btn-reg').onclick = () => {
				window.open('https://paypal.me/ReverendDrTolerant?country.x=US&locale.x=en_US', '_blank');
			};

			document.getElementById('return-to-demo').addEventListener('click', () => {
				localStorage.removeItem(REGISTERED_KEY);
				localStorage.removeItem(UNLOCK_CODE_KEY);
				window.location.reload(); // Force page refresh to reset everything
			});
	
			document.querySelector('.refresh-button').addEventListener('click', refreshImage);
		
			document.querySelector('.sort-btn').addEventListener('click', () => sortDebates());
			
			document.querySelector('.clear-btn').addEventListener('click', clearAllDebates);
			
			document.getElementById('unlock-more').addEventListener('click', showRegistrationPrompt);
			
			document.getElementById('get-code-btn').onclick = () => {
				const code = generateUnlockCode();
				document.getElementById('unlock-code').value = code;
			};			

			// Handle mode toggle - ONE handler for the game mode button
			document.getElementById('game-mode').addEventListener('click', function() {
				// First time or switching back on - show intro
				if (localStorage.getItem('gameMode') !== 'true') {
					document.getElementById('game-intro-modal').classList.add('show');
				} else {
					// Turning game mode off
					localStorage.setItem('gameMode', 'false');
					this.style.background = '#292929';
					updateResultsPanel();
				}
			});

			// Initialize game mode if it was on
			if (localStorage.getItem('gameMode') === 'true') {
				initializeGameFeatures();
				document.getElementById('game-mode').style.background = '#6200ea';
			}

			// Handle starting the game from intro modal
			document.getElementById('start-game').addEventListener('click', function() {
				localStorage.setItem('gameMode', 'true');
				document.getElementById('game-mode').style.background = '#6200ea';
				document.getElementById('game-intro-modal').classList.remove('show');
				updateResultsPanel();
				initializeGameFeatures();
			});

			// Handle closing modal
			document.querySelector('#game-intro-modal .close').addEventListener('click', function() {
				document.getElementById('game-intro-modal').classList.remove('show');
			});
		
			// History panel toggle
			document.querySelector('.history-toggle').addEventListener('click', () => {
				document.querySelector('.history-panel').classList.toggle('open');
			});
			
			// AI expand buttons
			document.querySelectorAll('.ai-expand-btn').forEach(btn => {
				btn.addEventListener('click', () => expandAIAnalysis(btn.dataset.type));
			});
			
			// Copy button
			document.getElementById('copy-content').addEventListener('click', () => {
				const activeTab = document.querySelector('.tab-pane.active');
				navigator.clipboard.writeText(activeTab.innerText);
			});
			
			// Tab switching
			document.querySelectorAll('.tab-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
					document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
					btn.classList.add('active');
					document.getElementById(`${btn.dataset.tab}-content`).classList.add('active');
				});
			});
			
			// Modal close buttons
			document.querySelectorAll('.close').forEach(btn => {
				btn.addEventListener('click', () => {
					const modal = btn.closest('.modal');
					modal.classList.remove('show');
					// Reset content if it's the AI modal
					if (modal.id === 'ai-modal') {
						document.getElementById('prose-content').innerHTML = '';
						document.getElementById('points-content').innerHTML = '';
						document.querySelector('.info-message').style.display = 'block';
					}
				});
			});
			
			// Initialize history panel
			updateHistoryPanel();
		});

		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				// Update button states
				document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
				btn.classList.add('active');
				
				// Update content visibility
				const isProse = btn.dataset.tab === 'prose';
				document.getElementById('prose-content').style.display = isProse ? 'block' : 'none';
				document.getElementById('points-content').style.display = isProse ? 'none' : 'block';
			});
		});

        // Handle image loading
        document.getElementById('conceptImage').addEventListener('load', function() {
            this.classList.add('loaded');
        });

		// Initialize container
		document.getElementById('conceptImage').style.display = 'block';
		document.querySelector('.refresh-button').style.display = 'none';

		// Force replace any existing stored image with our logo
		fetch(DEFAULT_IMAGE)
			.then(response => response.blob())
			.then(blob => {
				const reader = new FileReader();
				reader.onloadend = () => {
					// Force store the correct logo in localStorage
					localStorage.setItem('defaultDebateImage', reader.result);
					// Display the logo
					document.getElementById('conceptImage').src = reader.result;
					document.getElementById('conceptImage').classList.add('loaded');
				};
				reader.readAsDataURL(blob);
			});

		// Add startup info text to panels
		document.getElementById('pointOutput').innerHTML = 
			'👋 This panel will display a passionate argument FOR your topic. Enter any topic, concept, or question in the input box below and watch as two perspectives emerge. The system will generate a strong, concise case supporting your topic. 💡 Try topics like "remote work", "social media", or "space exploration"!';

		document.getElementById('counterOutput').innerHTML = 
			'🤔 This panel will show the opposing viewpoint to your topic. For every point, there\'s a counter point! The response here will challenge the other panel\'s position with equal conviction. 🎯 The goal is to explore different perspectives and encourage critical thinking. Ready to start a debate?';
	
    </script>
</body>
</html>