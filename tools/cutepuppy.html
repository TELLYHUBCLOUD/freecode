<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppy Cuteness Meter</title>
    <style>
        :root {
            --primary-color: #f0f6ff;
            --secondary-color: #e0edff;
            --accent-color-1: #FF5757; /* Red */
            --accent-color-2: #FFBD59; /* Orange */
            --accent-color-3: #FFDE59; /* Yellow */
            --accent-color-4: #59FF8E; /* Green */
            --accent-color-5: #5CE1E6; /* Blue */
            --accent-color-6: #C47AFF; /* Purple */
            --text-color: #333333;
            --text-secondary: #5271ff;
            --border-radius: 16px;
            --box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary-color);
            color: var(--text-color);
            min-height: 100vh;
            height: auto;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }

        /* Header Styles */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: linear-gradient(to right, var(--accent-color-5), var(--accent-color-6));
            border-bottom: none;
            box-shadow: var(--box-shadow);
            z-index: 1000;
        }

        .logo-container {
            color: white;
            text-decoration: none; 
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            font-size: 1.25rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .paw-icon {
            width: 28px;
            height: 28px;
            vertical-align: middle;
            margin-right: 4px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        /* Main Conversation Area */
        .conversation-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            margin-top: 60px;
            margin-bottom: 70px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        /* Initial State Styles */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2rem;
            padding: 1rem;
            text-align: center;
        }

        .puppy-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .greeting {
            font-size: 2rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 800;
        }

        .assistant-intro {
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        /* Upload area */
        .upload-zone {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,246,255,0.7));
            border: 3px dashed var(--accent-color-5);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .upload-zone:hover {
            border-color: var(--accent-color-4);
            transform: translateY(-5px);
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(230,240,255,0.8));
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 1rem;
            color: var(--accent-color-6);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--accent-color-1), var(--accent-color-6));
            -webkit-background-clip: text;
            color: transparent;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* Message Styles */
        .message {
            max-width: 80%;
            padding: 1.25rem 1.5rem;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.6;
            box-shadow: var(--box-shadow);
        }
        
        .message.user {
            background: linear-gradient(135deg, var(--accent-color-5), var(--accent-color-6));
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            color: white;
        }

        .message.assistant {
            background: white;
            align-self: flex-start;
            border-radius: var(--border-radius);
            border-bottom-left-radius: 4px;
            border-left: 4px solid var(--accent-color-4);
        }

        .message img.uploaded-photo {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Input container styling */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: white;
            display: flex;
            gap: 0.5rem;
            border-top: none;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            z-index: 1000;
            border-radius: 16px 16px 0 0;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--accent-color-5);
            background: white;
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(92, 225, 230, 0.3);
        }

        .image-upload-button {
            background: var(--accent-color-4);
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            color: white;
        }

        .image-upload-button:hover {
            background: var(--accent-color-3);
            transform: translateY(-2px);
        }

        .image-upload-button svg {
            width: 24px;
            height: 24px;
        }

        .send-button {
            padding: 0.75rem;
            background: var(--accent-color-6);
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            background: var(--text-secondary);
            transform: translateY(-2px);
        }

        .send-button svg {
            width: 24px;
            height: 24px;
        }

        /* Recent uploads gallery */
        .recent-uploads {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 12px;
            padding: 15px;
            background: linear-gradient(to right, rgba(255, 189, 89, 0.1), rgba(89, 255, 142, 0.1));
            border-radius: 12px;
            margin-top: 20px;
            margin-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color-3) white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        .recent-uploads::-webkit-scrollbar {
            height: 6px;
        }

        .recent-uploads::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
        }

        .recent-uploads::-webkit-scrollbar-thumb {
            background: linear-gradient(to right, var(--accent-color-3), var(--accent-color-4));
            border-radius: 10px;
        }

        .thumbnail {
            min-width: 85px;
            height: 85px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            border: 3px solid white;
        }

        .thumbnail:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .thumbnail.active {
            border: 3px solid var(--accent-color-6);
        }
        
        /* Score history panel */
        .score-history {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--accent-color-2);
        }
        
        .score-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .score-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(240, 246, 255, 0.5);
            border-radius: 8px;
        }
        
        .score-name {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .score-value {
            font-weight: bold;
            color: var(--accent-color-6);
        }

        /* Cute Meter */
        .cuteness-meter {
            margin-top: 15px;
            background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--accent-color-3);
        }

        .meter-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .meter-value {
            font-size: 1.2rem;
            color: var(--accent-color-6);
            font-weight: 800;
        }

        .meter-bar {
            height: 12px;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(to right, 
                var(--accent-color-1), 
                var(--accent-color-2),
                var(--accent-color-3),
                var(--accent-color-4),
                var(--accent-color-5),
                var(--accent-color-6));
            border-radius: 6px;
            transition: width 1s ease-in-out;
        }

        .cuteness-traits {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .trait-tag {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .uploaded-image-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .drag-over {
            background-color: rgba(255, 158, 128, 0.15);
            transform: scale(1.02);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }
            
            .upload-zone {
                padding: 1.5rem;
            }
            
            .greeting {
                font-size: 1.75rem;
            }
            
            .assistant-intro {
                font-size: 1rem;
            }
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: auto;
            padding: 1rem;
            font-size: 0.8rem;
            color: #888;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="paw-icon" fill="currentColor">
                <path d="M256 224c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 240c-52.9 0-96-43.1-96-96s43.1-96 96-96 96 43.1 96 96-43.1 96-96 96zm143.8-295.2c0-33.8-27.4-61.2-61.2-61.2-16.8 0-32.1 6.8-43.2 17.8-10.8 10.7-17.8 25.4-17.8 41.3 0 7.8 6.3 14.1 14.1 14.1s14.1-6.3 14.1-14.1c0-7 2.7-13.3 7.1-18 4.4-4.4 10.6-7.1 17.8-7.1 13.9 0 25.1 11.3 25.1 25.1 0 13.9-11.3 25.1-25.1 25.1-7.8 0-14.1 6.3-14.1 14.1s6.3 14.1 14.1 14.1c33.8 0 61.2-27.4 61.2-61.2zm-184.8-61.2c-33.8 0-61.2 27.4-61.2 61.2 0 33.8 27.4 61.2 61.2 61.2 7.8 0 14.1-6.3 14.1-14.1s-6.3-14.1-14.1-14.1c-13.9 0-25.1-11.3-25.1-25.1 0-13.9 11.3-25.1 25.1-25.1 7 0 13.3 2.7 18 7.1 4.4 4.4 7.1 10.6 7.1 18 0 7.8 6.3 14.1 14.1 14.1s14.1-6.3 14.1-14.1c0-16.8-6.8-32.1-17.8-43.2-11.2-10.8-26.5-17.7-43.3-17.7zm90.9 59.4c0-20.3-20.7-32.1-41-14.1-20.3-18-41 0-41 17.4 0 20.3 16.9 37.1 37.2 37.1 20.3 0 44.8-9.1 44.8-40.4zm-17.9 13.4a20.3 20.3 0 1 1-40.6 0 20.3 20.3 0 0 1 40.6 0zM90.8 228.8C56.9 228.8 29.6 256.2 29.6 290s27.4 61.2 61.2 61.2c33.8 0 61.2-27.4 61.2-61.2s-27.4-61.2-61.2-61.2zm0 98.5c-20.6 0-37.2-16.6-37.2-37.2s16.6-37.2 37.2-37.2S128 269.5 128 290s-16.6 37.3-37.2 37.3z"/>
            </svg>
            Puppy Cuteness Meter
        </div>
    </header>    
    <div class="conversation-container" id="conversation-container">
        <div class="initial-state" id="initial-state">                
            <div>
                <img src="https://cdn.pixabay.com/photo/2016/12/13/05/15/puppy-1903313_960_720.png" alt="Cute puppy illustration" class="puppy-icon">
                <h2 class="greeting">Puppy Cuteness Meter</h2>
                <p class="assistant-intro">Upload photos of your puppies and our AI assistant will measure their cuteness score, identify adorable features, and let you compare them side by side. Perfect for celebrating your furry friends' irresistible charm!</p>
            </div>

            <div class="upload-zone" id="upload-zone">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Upload a puppy photo</p>
                <p class="upload-subtext">or drag and drop here</p>
            </div>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>
        
        <!-- This will hold the recent uploads thumbnails -->
        <div class="recent-uploads" id="recent-uploads" style="display: none;">
            <!-- Thumbnails will be added here dynamically -->
        </div>
        
        <!-- Score comparison panel -->
        <div class="score-history" id="score-history" style="display: none;">
            <div class="score-title">
                Cuteness Leaderboard
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 6h10"></path>
                    <path d="M6 12h12"></path>
                    <path d="M4 18h16"></path>
                </svg>
            </div>
            <div class="score-list" id="score-list">
                <!-- Scores will be added here dynamically -->
            </div>
        </div>
    </div>

    <div class="input-container" id="question-input" style="display: none;">
        <input type="text" class="message-input" placeholder="Ask about this puppy..." id="message-input">

        <button class="image-upload-button" id="image-upload-button" title="Upload a new puppy">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
        </button>
        
        <button class="send-button" id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>

    <script>
        let conversationHistory = [];
        let currentImageData = null;
        let imagePreviewElement = null;
        let recentUploads = [];
        let scoreHistory = [];
        
        // Color assignments for traits
        const colorList = [
            'var(--accent-color-1)',
            'var(--accent-color-2)',
            'var(--accent-color-3)',
            'var(--accent-color-4)',
            'var(--accent-color-5)',
            'var(--accent-color-6)'
        ];
        
        // State management
        let state = {
            messages: [],
            controller: null,
            isLoading: false,
            systemPrompt: "You are a Puppy Cuteness Meter assistant. Your job is to analyze puppy photos with enthusiasm and positivity. When a user uploads a puppy image: 1) Comment on specific visible features (fur color, eyes, ears, size, breed if recognizable) 2) Rate cuteness on a scale of 85-100 (all puppies are cute!) 3) List 3-5 cute traits you notice by starting with 'Cute Traits:' and then listing them with bullets or commas 4) Be playful and warm in your tone. If the image doesn't contain a puppy, kindly ask for a puppy photo instead. Always format your response to include a Cuteness Rating: [NUMBER] that can be easily parsed. Sign responses as 'Puppy Cuteness Meter 🐾'"
        };

        // DOM Elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const conversationContainer = document.getElementById('conversation-container');
        const initialState = document.getElementById('initial-state');
        const questionInput = document.getElementById('question-input');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const imageUploadButton = document.getElementById('image-upload-button');
        const recentUploadsContainer = document.getElementById('recent-uploads');

// Create cuteness meter
        function createCutenessMeter(score, traits, puppyName = null) {
            const meterDiv = document.createElement('div');
            meterDiv.className = 'cuteness-meter';
            
            const meterTitle = document.createElement('div');
            meterTitle.className = 'meter-title';
            
            // Allow for naming the puppy or use default
            let displayName = puppyName || "This Puppy";
            meterTitle.innerHTML = `${displayName}'s Cuteness <span class="meter-value">${score}/100</span>`;
            
            const meterBar = document.createElement('div');
            meterBar.className = 'meter-bar';
            
            const meterFill = document.createElement('div');
            meterFill.className = 'meter-fill';
            meterFill.style.width = '0%'; // Start at 0 for animation
            meterBar.appendChild(meterFill);
            
            const traitsDiv = document.createElement('div');
            traitsDiv.className = 'cuteness-traits';
            
            // Create colorful trait tags
            traits.forEach((trait, index) => {
                const traitTag = document.createElement('span');
                traitTag.className = 'trait-tag';
                traitTag.textContent = trait;
                
                // Cycle through colors for each trait
                const colorIndex = index % colorList.length;
                traitTag.style.backgroundColor = colorList[colorIndex];
                
                traitsDiv.appendChild(traitTag);
            });
            
            meterDiv.appendChild(meterTitle);
            meterDiv.appendChild(meterBar);
            meterDiv.appendChild(traitsDiv);
            
            // Animate the meter fill after a short delay
            setTimeout(() => {
                meterFill.style.width = `${score}%`;
            }, 300);
            
            // Add to score history
            if (!scoreHistory.some(item => item.score === score && item.name === displayName)) {
                addToScoreHistory(displayName, score);
            }
            
            return meterDiv;
        }
        
        // Add to score history
        function addToScoreHistory(name, score) {
            scoreHistory.push({
                name: name,
                score: score,
                timestamp: new Date().getTime()
            });
            
            // Sort by score (highest first)
            scoreHistory.sort((a, b) => b.score - a.score);
            
            // Update UI
            updateScoreHistoryUI();
            
            // Show the score history panel
            document.getElementById('score-history').style.display = 'block';
        }
        
        // Update score history UI
        function updateScoreHistoryUI() {
            const scoreList = document.getElementById('score-list');
            scoreList.innerHTML = '';
            
            scoreHistory.forEach((item, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                
                const scoreName = document.createElement('span');
                scoreName.className = 'score-name';
                
                // Add rank emoji for top 3
                if (index === 0) {
                    scoreName.textContent = `🥇 ${item.name}`;
                } else if (index === 1) {
                    scoreName.textContent = `🥈 ${item.name}`;
                } else if (index === 2) {
                    scoreName.textContent = `🥉 ${item.name}`;
                } else {
                    scoreName.textContent = item.name;
                }
                
                const scoreValue = document.createElement('span');
                scoreValue.className = 'score-value';
                scoreValue.textContent = `${item.score}`;
                
                scoreItem.appendChild(scoreName);
                scoreItem.appendChild(scoreValue);
                scoreList.appendChild(scoreItem);
            });
        }

        // Process the image file
        function processImageFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64Image = e.target.result.split(',')[1]; // Remove the data URL part
                currentImageData = base64Image;
                
                // Create a name for the puppy based on timestamp and file name
                const fileName = file.name.split('.')[0];
                const puppyName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
                
                // Store in recent uploads with name
                addToRecentUploads(e.target.result, puppyName);
                
                // Show image preview if in chat mode
                if (initialState.style.display === 'none') {
                    showImagePreview(e.target.result);
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Add to recent uploads
        function addToRecentUploads(dataUrl, name) {
            // Create unique ID for this upload
            const uploadId = 'upload_' + new Date().getTime();
            
            // Add to front of array (most recent first)
            recentUploads.unshift({
                id: uploadId,
                dataUrl: dataUrl,
                base64: dataUrl.split(',')[1],
                name: name || `Puppy ${recentUploads.length + 1}`,
                timestamp: new Date().getTime()
            });
            
            // Limit to 10 recent uploads
            if (recentUploads.length > 10) {
                recentUploads.pop();
            }
            
            // Update the UI
            updateRecentUploadsUI();
            
            // Show the recent uploads section
            recentUploadsContainer.style.display = 'flex';
        }

        // Update recent uploads UI
        function updateRecentUploadsUI() {
            recentUploadsContainer.innerHTML = '';
            
            recentUploads.forEach((upload) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = upload.dataUrl;
                thumbnail.className = 'thumbnail';
                thumbnail.title = upload.name;
                
                if (upload.base64 === currentImageData) {
                    thumbnail.classList.add('active');
                }
                
                thumbnail.addEventListener('click', () => {
                    currentImageData = upload.base64;
                    
                    // Prompt for name if not provided
                    let puppyName = upload.name;
                    if (puppyName === `Puppy ${recentUploads.indexOf(upload) + 1}`) {
                        const newName = prompt('Name this puppy:', puppyName);
                        if (newName && newName.trim()) {
                            upload.name = newName.trim();
                            puppyName = newName.trim();
                        }
                    }
                    
                    sendQuestion(`What do you think of ${puppyName}?`);
                    
                    // Update active state
                    document.querySelectorAll('.thumbnail').forEach(thumb => {
                        thumb.classList.remove('active');
                    });
                    thumbnail.classList.add('active');
                });
                
                recentUploadsContainer.appendChild(thumbnail);
            });
        }

        // Show image preview next to input
        function showImagePreview(dataUrl) {
            // Remove existing preview if any
            if (imagePreviewElement) {
                imagePreviewElement.remove();
            }
            
            // Create preview element
            imagePreviewElement = document.createElement('img');
            imagePreviewElement.src = dataUrl;
            imagePreviewElement.className = 'uploaded-image-preview';
            imagePreviewElement.title = "Click to remove image";
            
            imagePreviewElement.onclick = () => {
                currentImageData = null;
                imagePreviewElement.remove();
                imagePreviewElement = null;
            };
            
            // Insert before input container
            questionInput.insertBefore(imagePreviewElement, messageInput);
        }

        // Switch to Assistant Mode
        function switchToAssistantMode() {
            if (initialState) {
                initialState.style.display = 'none';
            }
            questionInput.style.display = 'flex';
            messageInput.focus();
        }

        // Add Message to Conversation
        async function addMessage(content, role) {
            const message = document.createElement('div');
            message.classList.add('message', role);
            
            if (role === 'assistant') {
                // Process for cuteness information
                let processedContent = content;
                
                // Parse the content for cuteness score and traits
                const scoreMatch = content.match(/Cuteness Rating:?\s*(\d+)/i);
                const traitsMatch = content.match(/Cute Traits:([^]*?)(?=\n\n|\n$|$)/is);
                
                let score = 0;
                let traits = [];
                let puppyName = '';
                
                // Try to extract puppy name from user's last message
                if (state.messages.length > 0) {
                    const lastUserMessage = state.messages.filter(msg => msg.role === 'user').pop();
                    if (lastUserMessage) {
                        const nameMatch = lastUserMessage.content.match(/(?:of|about)\s+([A-Za-z]+)(?:\?|\.|\s|$)/i);
                        if (nameMatch && nameMatch[1]) {
                            puppyName = nameMatch[1];
                        }
                    }
                }
                
                if (scoreMatch && scoreMatch[1]) {
                    score = parseInt(scoreMatch[1], 10);
                }
                
                if (traitsMatch && traitsMatch[1]) {
                    // Extract traits from the matching content
                    traits = traitsMatch[1].split(/[,•\n-]/)
                        .map(trait => trait.trim())
                        .filter(trait => trait.length > 0 && trait !== "-" && !trait.startsWith("Puppy"));
                }
                
                // Apply line breaks
                processedContent = processedContent.replace(/\n/g, '<br>');
                message.innerHTML = processedContent;
                
                // Add cuteness meter if score was found
                if (score > 0) {
                    const cutenessMeter = createCutenessMeter(score, traits, puppyName);
                    message.appendChild(cutenessMeter);
                }
            } else {
                // For user messages
                message.textContent = content;
                
                // If there's an image, add it
                if (currentImageData && role === 'user') {
                    const img = document.createElement('img');
                    img.src = `data:image/jpeg;base64,${currentImageData}`;
                    img.className = 'uploaded-photo';
                    img.alt = 'Uploaded puppy photo';
                    message.appendChild(img);
                }
            }
            
            conversationContainer.appendChild(message);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
            state.messages.push({ role, content });
        }
        
        // Add loading indicator
        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'assistant', 'loading');
            loadingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            conversationContainer.appendChild(loadingDiv);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
            return loadingDiv;
        }

        // Analyze image using AI
        async function analyzeImage(base64Image) {
            // We need a format that works with the text generation API
            const requestBody = {
                "model": "openai",
                "messages": [
                    {
                        "role": "system",
                        "content": state.systemPrompt
                    },
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": "What do you think of this puppy? Please analyze its cuteness level."
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": `data:image/jpeg;base64,${base64Image}`
                                }
                            }
                        ]
                    }
                ]
            };

            try {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Failed to analyze image');
                }

                const responseData = await response.json();
                const analysisText = responseData.choices?.[0]?.message?.content || '';
                
                return analysisText;
            } catch (error) {
                console.error('Image analysis error:', error);
                throw error;
            }
        }

        // Fetch an image and use it
        async function fetchImageAsBase64(url) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64data = reader.result.split(',')[1];
                        resolve(base64data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error fetching image:", error);
                return null;
            }
        }

        // Send Question to API
        async function sendQuestion(content) {
            if ((!content.trim() && !currentImageData) || state.isLoading) return;

            // Cancel any existing request
            if (state.controller) {
                state.controller.abort();
            }
            
            state.isLoading = true;

            // Create new AbortController for this request
            state.controller = new AbortController();

            try {
                // Prepare messages
                let messages = [
                    {
                        role: 'system',
                        content: state.systemPrompt
                    }
                ];
                
                // Add previous messages from history
                state.messages.forEach(msg => {
                    messages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });
                
                // Add current user message, possibly with image
                if (currentImageData) {
                    // Create a message with both text and image
                    const userMessage = {
                        role: 'user',
                        content: [
                            { 
                                type: 'text', 
                                text: content.trim() ? content : "What do you think of this puppy?"
                            },
                            { 
                                type: 'image_url', 
                                image_url: { 
                                    url: `data:image/jpeg;base64,${currentImageData}` 
                                } 
                            }
                        ]
                    };
                    
                    messages.push(userMessage);
                    
                    // Display the message to the user (text only)
                    addMessage(userMessage.content[0].text, 'user');
                } else {
                    // Text-only message
                    messages.push({
                        role: 'user',
                        content: content
                    });
                    
                    // Display the message
                    addMessage(content, 'user');
                }
                
                // Clear input field
                messageInput.value = '';
                
                // Show loading indicator
                const loadingIndicator = addLoadingIndicator();

                // Use direct image analysis for first message with an image
                let responseText;
                if (currentImageData && state.messages.length <= 2) {
                    responseText = await analyzeImage(currentImageData);
                } else {
                    // Use standard API for follow-up conversations
                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: messages,
                            seed: Math.floor(Math.random() * 1000000),
                            model: 'openai-large',
                            jsonMode: false
                        }),
                        signal: state.controller.signal
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    responseText = await response.text();
                }

                // Remove loading indicator
                loadingIndicator.remove();

                // Add the response to the conversation
                addMessage(responseText, 'assistant');
                
                // Add the user message to history (text-only version)
                if (currentImageData && !state.messages.some(msg => msg.role === 'user')) {
                    state.messages.push({
                        role: 'user',
                        content: content.trim() ? content : "What do you think of this puppy?"
                    });
                } else if (!currentImageData) {
                    state.messages.push({
                        role: 'user',
                        content: content
                    });
                }
                
                // Add assistant response to history
                state.messages.push({
                    role: 'assistant',
                    content: responseText
                });
                
                // Don't clear image data after first upload to allow follow-up questions
                // But do clear image preview in input field
                if (imagePreviewElement) {
                    imagePreviewElement.remove();
                    imagePreviewElement = null;
                }
                
                // Update recent uploads UI to highlight the current image
                updateRecentUploadsUI();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was cancelled');
                } else {
                    console.error('Error:', error);
                    
                    // Remove loading indicator if it exists
                    const loadingIndicator = document.querySelector('.message.loading');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    addMessage('Sorry, I had trouble analyzing that image. Please try again or upload a different puppy photo. Puppy Cuteness Meter 🐾', 'assistant');
                }
            } finally {
                state.controller = null;
                state.isLoading = false;
                messageInput.focus();
            }
        }

        // Event Listeners
        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Drag and drop functionality
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                processImageFile(files[0]);
                switchToAssistantMode();
                
                // Use file name for the puppy name if available
                const fileName = files[0].name.split('.')[0];
                const puppyName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
                
                sendQuestion(`What do you think of ${puppyName}?`);
            }
        });

        sendButton.addEventListener('click', () => {
            if (messageInput.value.trim() || currentImageData) {
                sendQuestion(messageInput.value);
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && (messageInput.value.trim() || currentImageData)) {
                sendQuestion(messageInput.value);
            }
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                processImageFile(file);
                switchToAssistantMode();
                
                // Use file name for the puppy name if available
                const fileName = file.name.split('.')[0];
                const puppyName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
                
                sendQuestion(`What do you think of ${puppyName}?`);
            }
        });

        imageUploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle window events
        window.addEventListener('beforeunload', () => {
            if (state.controller) {
                state.controller.abort();
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && state.controller) {
                state.controller.abort();
            }
        });
    </script>
</body>
</html>