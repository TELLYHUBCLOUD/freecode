<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Preference Finder</title>
    <style>
        :root {
            --primary: #8a2be2;
            --primary-light: #9d44e6;
            --background: #121212;
            --surface: #1e1e1e;
            --text: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #ff6b6b;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 90%;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 2rem;
        }
        
        .intro {
            text-align: center;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .question-container {
            display: none;
            animation: fadeIn 0.5s ease-in;
            margin-bottom: 2rem;
        }
        
        .question-container.active {
            display: block;
        }
        
        .question {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .option {
            background-color: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text);
            font-size: 1rem;
        }
        
        .option:hover {
            background-color: var(--primary-light);
            transform: translateY(-3px);
        }
        
        .option.selected {
            background-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(138, 43, 226, 0.3);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 0.8rem 1.8rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }
        
        #prevBtn {
            visibility: hidden;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #333;
            border-radius: 3px;
            margin: 2rem 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }
        
        #results {
            display: none;
            animation: fadeIn 0.8s ease-in;
        }
        
        .result-card {
            background-color: rgba(138, 43, 226, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
        }
        
        .result-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .restart-btn {
            display: block;
            margin: 2rem auto;
            background-color: var(--accent);
        }
        
        .restart-btn:hover {
            background-color: #ff8787;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-insight {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.15) 0%, rgba(138, 43, 226, 0.05) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            border-left: 4px solid var(--primary);
            position: relative;
        }
        
        .ai-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        
        .share-options {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .share-link {
            background-color: var(--primary);
            color: white;
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .share-link:hover {
            background-color: var(--primary-light);
        }
        
        .share-image {
            width: 100%;
            margin-top: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 500px;
        }
        
        .copy-btn {
            background-color: var(--surface);
            border: 1px solid var(--primary);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #shareUrl {
            width: 100%;
            padding: 0.8rem;
            background-color: var(--background);
            color: var(--text);
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 1.5rem;
                width: 95%;
            }
            
            .options {
                flex-direction: column;
                gap: 0.7rem;
            }
            
            .option {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Relationship Preference Finder</h1>
        
        <div id="intro" class="intro">
            <p>Not sure what kind of relationship you're looking for? This quiz will help you clarify your preferences and understand what you really want.</p>
            <p>Answer honestly - this is just for your own clarity!</p>
            <button id="startBtn">Let's Get Started</button>
        </div>
        
        <div id="quiz" style="display: none;">
            <div class="progress-bar">
                <div id="progress" class="progress" style="width: 0%;"></div>
            </div>

			<div id="question0a" class="question-container active">
				<div class="question">What is your gender identity?</div>
				<div class="options">
					<div class="option" data-value="woman">Woman</div>
					<div class="option" data-value="man">Man</div>
					<div class="option" data-value="non-binary">Non-binary</div>
					<div class="option" data-value="other">Other/Prefer not to say</div>
				</div>
			</div>

			<div id="question0b" class="question-container">
				<div class="question">What gender(s) are you interested in connecting with?</div>
				<div class="options">
					<div class="option" data-value="women">Women</div>
					<div class="option" data-value="men">Men</div>
					<div class="option" data-value="all-genders">People of all genders</div>
					<div class="option" data-value="prefer-not-say">Prefer not to specify</div>
				</div>
			</div>
            
            <div id="question1" class="question-container">
                <div class="question">When you think about connecting with someone, what's most important to you?</div>
                <div class="options">
                    <div class="option" data-value="friendship">Genuine friendship and connection</div>
                    <div class="option" data-value="casual">Fun, light-hearted interactions</div>
                    <div class="option" data-value="romantic">Deep emotional intimacy</div>
                    <div class="option" data-value="physical">Physical chemistry and attraction</div>
                </div>
            </div>
            
            <div id="question2" class="question-container">
                <div class="question">How do you prefer to spend time with someone you're interested in?</div>
                <div class="options">
                    <div class="option" data-value="virtual">Mostly virtual (texts, calls, video chats)</div>
                    <div class="option" data-value="casual-meetups">Casual in-person hangouts</div>
                    <div class="option" data-value="planned-dates">Planned, intentional dates</div>
                    <div class="option" data-value="travel">Traveling and experiencing new places together</div>
                </div>
            </div>
            
            <div id="question3" class="question-container">
                <div class="question">When it comes to flirting and romantic interaction, you prefer:</div>
                <div class="options">
                    <div class="option" data-value="none">Minimal to none - I value platonic connections</div>
                    <div class="option" data-value="light">Light, playful flirting but nothing serious</div>
                    <div class="option" data-value="moderate">Moderate flirting with some romantic gestures</div>
                    <div class="option" data-value="intense">Intense romantic and passionate interactions</div>
                </div>
            </div>
            
            <div id="question4" class="question-container">
                <div class="question">How important is geographic proximity in your relationships?</div>
                <div class="options">
                    <div class="option" data-value="local">Must be local - I want regular in-person interaction</div>
                    <div class="option" data-value="driving">Within driving distance is fine</div>
                    <div class="option" data-value="long-distance">Open to long-distance with occasional visits</div>
                    <div class="option" data-value="anywhere">Location doesn't matter to me</div>
                </div>
            </div>
            
            <div id="question5" class="question-container">
                <div class="question">When it comes to commitment and exclusivity, you're looking for:</div>
                <div class="options">
                    <div class="option" data-value="open">Complete openness to see others</div>
                    <div class="option" data-value="casual">Casual but respectful - no labels needed</div>
                    <div class="option" data-value="exclusive-casual">Exclusive but still keeping it light</div>
                    <div class="option" data-value="committed">Dedicated, committed relationship</div>
                </div>
            </div>
            
            <div id="question6" class="question-container">
                <div class="question">How fast do you typically want a relationship to progress?</div>
                <div class="options">
                    <div class="option" data-value="slow">Slowly - I need time to build trust</div>
                    <div class="option" data-value="moderate">At a moderate, natural pace</div>
                    <div class="option" data-value="fast">Relatively quickly if there's chemistry</div>
                    <div class="option" data-value="varies">It varies depending on the connection</div>
                </div>
            </div>
            
            <div id="question7" class="question-container">
                <div class="question">How important is physical intimacy in your ideal relationship?</div>
                <div class="options">
                    <div class="option" data-value="not-important">Not important or not a priority</div>
                    <div class="option" data-value="somewhat">Somewhat important, but not central</div>
                    <div class="option" data-value="important">Very important for compatibility</div>
                    <div class="option" data-value="essential">Essential and a primary focus</div>
                </div>
            </div>
            
            <div id="question8" class="question-container">
                <div class="question">How do you feel about integrating a new relationship into your life?</div>
                <div class="options">
                    <div class="option" data-value="separate">I prefer to keep it separate from my everyday life</div>
                    <div class="option" data-value="casual-integration">Some casual integration is fine</div>
                    <div class="option" data-value="significant">Significant integration into my social circle</div>
                    <div class="option" data-value="complete">Complete integration into all aspects of life</div>
                </div>
            </div>
            
            <div class="controls">
                <button id="prevBtn">Previous</button>
                <button id="nextBtn">Next</button>
            </div>
        </div>
        
        <div id="results" style="display: none;">
            <h2>Your Relationship Preference Profile</h2>
            
            <div class="result-card">
                <div class="result-title">What You're Looking For</div>
                <div id="connectionType"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Your Interaction Style</div>
                <div id="interactionStyle"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Location & Logistics</div>
                <div id="locationPreference"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Commitment Level</div>
                <div id="commitmentLevel"></div>
            </div>
            
            <div class="result-card">
                <div class="result-title">Relationship Summary</div>
                <div id="summary"></div>
            </div>
            
            <div id="aiInsightContainer" style="display: none;">
                <div class="loading" id="aiLoading">
                    <div class="spinner"></div>
                    <p>Generating personalized insights...</p>
                </div>
                
                <div class="ai-insight" id="aiInsight" style="display: none;">
                    <div class="ai-badge">AI Insight</div>
                    <div id="aiInsightContent"></div>
                </div>
            </div>
            
            <div id="shareContainer" style="display: none;">
                <div class="share-options">
                    <h3>Share Your Results</h3>
                    
                    <div style="width: 100%;">
                        <input type="text" id="shareUrl" readonly />
                        <button class="copy-btn" id="copyBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy Link
                        </button>
                    </div>

					<!-- Add this button in the results section -->
					<button id="takeOwnQuizBtn" class="share-link" style="margin-top: 1rem;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
						</svg>
						Take Your Own Quiz
					</button>

					<!-- Add a "Compare Results" button to the share section -->
					<button id="compareBtn" class="share-link" style="background-color: #4a148c; margin-top: 1rem;">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l6 6"/>
						</svg>
						Compare With Another
					</button>

			<!-- Comparison modal -->
			<div id="comparisonModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
				<div style="max-width: 800px; margin: 2rem auto; background: var(--surface); padding: 2rem; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.4);">
					<div style="display: flex; justify-content: space-between; align-items: center;">
						<h2>Compare Preferences</h2>
						<button id="closeCompareBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);">×</button>
					</div>
					
					<div id="comparisonSteps">
						<div id="step1" class="comparison-step">
							<p>Paste the URL of the results you want to compare with:</p>
							<input type="text" id="compareUrl" style="width: 100%; padding: 0.8rem; background-color: var(--background); color: var(--text); border: 1px solid #333; border-radius: 4px; font-size: 0.9rem; margin-bottom: 1rem;">
							<p>Or paste the raw results data:</p>
							<textarea id="compareData" style="width: 100%; height: 100px; padding: 0.8rem; background-color: var(--background); color: var(--text); border: 1px solid #333; border-radius: 4px; font-size: 0.9rem; margin-bottom: 1rem;"></textarea>
							<button id="loadCompareBtn" class="share-link" style="margin: 0 auto; display: block;">Load Comparison Data</button>
						</div>
						
						<div id="step2" class="comparison-step" style="display: none;">
							<div class="loading" id="comparisonLoading">
								<div class="spinner"></div>
								<p>Analyzing compatibility...</p>
							</div>
							
							<div id="compatibilityResults" style="display: none;">
								<h3>Compatibility Analysis</h3>
								<div id="compatibilityContent"></div>
								
								<div class="ai-insight" style="margin-top: 2rem;">
									<div class="ai-badge">AI Compatibility Insight</div>
									<div id="compatibilityAiContent"></div>
								</div>
								
								<div id="compatibilityImageContainer" class="loading" style="margin-top: 2rem;">
									<div class="spinner"></div>
									<p>Generating compatibility visualization...</p>
								</div>
								
								<img id="compatibilityImage" class="share-image" style="display: none;">
							</div>
						</div>
					</div>
				</div>
			</div>

                    
                    <div class="loading" id="imageLoading">
                        <div class="spinner"></div>
                        <p>Generating shareable image...</p>
                    </div>
                    
                    <img id="shareImage" class="share-image" style="display: none;" />
                    
                    <a id="downloadBtn" download="my-relationship-preferences.jpg" style="display: none;" class="share-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download Image
                    </a>
                </div>
            </div>
            
            <button class="restart-btn" id="restartBtn">Start Over</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const restartBtn = document.getElementById('restartBtn');
            const intro = document.getElementById('intro');
            const quiz = document.getElementById('quiz');
            const results = document.getElementById('results');
            const progress = document.getElementById('progress');
            const aiInsightContainer = document.getElementById('aiInsightContainer');
            const aiInsight = document.getElementById('aiInsight');
            const aiInsightContent = document.getElementById('aiInsightContent');
            const aiLoading = document.getElementById('aiLoading');
            const shareContainer = document.getElementById('shareContainer');
            const shareUrl = document.getElementById('shareUrl');
            const copyBtn = document.getElementById('copyBtn');
            const shareImage = document.getElementById('shareImage');
            const downloadBtn = document.getElementById('downloadBtn');
            const imageLoading = document.getElementById('imageLoading');
            
            let currentQuestion = 1;
            const totalQuestions = 8;
            const answers = {};

			// Define the question order
			const questionOrder = ['0a', '0b', '1', '2', '3', '4', '5', '6', '7', '8'];

			// Check if URL has parameters but they don't contain valid answers
			const params = new URLSearchParams(window.location.search);
			if (params.toString() && !params.has('q1') && !params.has('q0a')) {
				// If we have parameters but no actual quiz answers, clear the URL
				const baseUrl = window.location.href.split('?')[0];
				window.location.href = baseUrl;
			}
            
			// Check URL parameters for shared results
			function loadFromParams() {
				const params = new URLSearchParams(window.location.search);
				let hasParams = false;
				
				for (const [key, value] of params.entries()) {
					if (key.startsWith('q')) {
						// Extract the question ID (remove the 'q' prefix)
						const questionId = key.substring(1);
						answers[questionId] = value;
						hasParams = true;
						console.log(`Loaded answer for question ${questionId}: ${value}`);
					}
				}
				
				if (hasParams) {
					// Print debug info
					console.log("Loaded answers from URL:", answers);
					
					// Verify the answers object is properly populated
					if (Object.keys(answers).length === 0) {
						console.error("Error: answers object is empty despite having URL parameters");
					}
					
					// Skip the quiz and show results directly
					intro.style.display = 'none';
					quiz.style.display = 'none';
					results.style.display = 'block';
					
					// Make sure answers are processed before generating AI insights
					setTimeout(() => {
						analyzeResults();
						
						// Make sure there's a small delay before calling AI functions
						// This gives time for the answers object to be fully processed
						setTimeout(() => {
							generateAIInsight();
							generateShareableContent();
						}, 100);
					}, 100);
				}
			}
            
            // Call on load
            loadFromParams();
            
			// Start the quiz
			startBtn.addEventListener('click', function() {
				intro.style.display = 'none';
				quiz.style.display = 'block';
				
				// Ensure only question0a is active when starting
				document.querySelectorAll('.question-container').forEach(container => {
					container.classList.remove('active');
				});
				document.getElementById('question0a').classList.add('active');
				
				// Reset currentQuestion
				currentQuestion = '0a';
				
				updateProgressBar();
			});

			document.getElementById('takeOwnQuizBtn').addEventListener('click', function() {
				window.location.href = 'finder.html';
			});
            
            // Handle option selection
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from siblings
                    const siblings = this.parentElement.querySelectorAll('.option');
                    siblings.forEach(sib => sib.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Store the answer
                    answers[currentQuestion] = this.getAttribute('data-value');
                    
                    // Enable next button
                    nextBtn.disabled = false;
                });
            });

			// Comparison functionality
			document.getElementById('compareBtn').addEventListener('click', function() {
				document.getElementById('comparisonModal').style.display = 'block';
				document.getElementById('step1').style.display = 'block';
				document.getElementById('step2').style.display = 'none';
				document.getElementById('compareUrl').value = '';
				document.getElementById('compareData').value = '';
			});

			document.getElementById('closeCompareBtn').addEventListener('click', function() {
				document.getElementById('comparisonModal').style.display = 'none';
			});

			document.getElementById('loadCompareBtn').addEventListener('click', function() {
				const compareUrl = document.getElementById('compareUrl').value.trim();
				const compareData = document.getElementById('compareData').value.trim();
				
				if (!compareUrl && !compareData) {
					alert('Please provide either a URL or result data to compare with.');
					return;
				}
				
				// Show loading
				document.getElementById('step1').style.display = 'none';
				document.getElementById('step2').style.display = 'block';
				document.getElementById('comparisonLoading').style.display = 'flex';
				document.getElementById('compatibilityResults').style.display = 'none';
				
				if (compareUrl) {
					// Extract parameters from URL
					try {
						const url = new URL(compareUrl);
						const params = new URLSearchParams(url.search);
						const otherAnswers = {};
						
						for (const [key, value] of params.entries()) {
							if (key.startsWith('q')) {
								otherAnswers[key.substring(1)] = value;
							}
						}
						
						if (Object.keys(otherAnswers).length === 0) {
							alert('No valid result data found in the URL.');
							document.getElementById('step1').style.display = 'block';
							document.getElementById('step2').style.display = 'none';
							return;
						}
						
						generateCompatibilityAnalysis(otherAnswers);
					} catch (error) {
						alert('Invalid URL. Please provide a valid results URL.');
						document.getElementById('step1').style.display = 'block';
						document.getElementById('step2').style.display = 'none';
					}
				} else if (compareData) {
					// Try to parse the data
					try {
						const otherAnswers = JSON.parse(compareData);
						generateCompatibilityAnalysis(otherAnswers);
					} catch (error) {
						alert('Invalid data format. Please provide valid JSON data.');
						document.getElementById('step1').style.display = 'block';
						document.getElementById('step2').style.display = 'none';
					}
				}
			});

			async function generateCompatibilityAnalysis(otherAnswers) {
				// Generate basic compatibility comparison
				const compatibilityContent = document.getElementById('compatibilityContent');
				const compatibilityHtml = generateCompatibilityHtml(answers, otherAnswers);
				compatibilityContent.innerHTML = compatibilityHtml;
				
				// Generate AI compatibility insight
				await generateAICompatibilityInsight(answers, otherAnswers);
				
				// Show results
				document.getElementById('comparisonLoading').style.display = 'none';
				document.getElementById('compatibilityResults').style.display = 'block';
			}

			function generateCompatibilityHtml(answers1, answers2) {
				let html = '<div class="compatibility-table">';
				html += '<h4>Preference Comparison</h4>';
				html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;">';
				html += '<tr><th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #444;">Preference</th><th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #444;">Person 1</th><th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #444;">Person 2</th><th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #444;">Match</th></tr>';
				
				// Map preference names to human-readable labels
				const prefLabels = {
					'0a': 'Gender Identity',
					'0b': 'Gender Preference',
					'1': 'Connection Priority',
					'2': 'Interaction Style',
					'3': 'Flirting Level',
					'4': 'Location Preference',
					'5': 'Exclusivity',
					'5a': 'Relationship Structure',
					'6': 'Relationship Pace',
					'7': 'Physical Intimacy',
					'8': 'Life Integration'
				};
				
				// Get all unique keys
				const allKeys = new Set([...Object.keys(answers1), ...Object.keys(answers2)]);
				
				// Calculate match percentage
				let matchCount = 0;
				let totalCount = 0;
				
				for (const key of allKeys) {
					if (prefLabels[key]) {
						const val1 = answers1[key] || 'Not specified';
						const val2 = answers2[key] || 'Not specified';
						
						// Determine if there's a match using smart compatibility logic
						const isMatch = isCompatiblePreference(key, val1, val2, answers1, answers2);
						
						if (val1 !== 'Not specified' && val2 !== 'Not specified') {
							totalCount++;
							if (isMatch) matchCount++;
						}
						
						html += `<tr>
							<td style="padding: 0.5rem; border-bottom: 1px solid #333;">${prefLabels[key]}</td>
							<td style="padding: 0.5rem; border-bottom: 1px solid #333;">${humanReadableValue(key, val1)}</td>
							<td style="padding: 0.5rem; border-bottom: 1px solid #333;">${humanReadableValue(key, val2)}</td>
							<td style="padding: 0.5rem; border-bottom: 1px solid #333; color: ${isMatch ? '#4CAF50' : '#FF5252'};">
								${isMatch ? '✓' : '✗'}
							</td>
						</tr>`;
					}
				}
				
				html += '</table>';
				
				// Calculate overall match percentage
				const matchPercentage = totalCount > 0 ? Math.round((matchCount / totalCount) * 100) : 0;
				
				// Add match meter
				html += `<div class="match-meter" style="margin-bottom: 2rem;">
					<h4>Overall Match: ${matchPercentage}%</h4>
					<div style="height: 8px; background-color: #333; border-radius: 4px; overflow: hidden;">
						<div style="height: 100%; width: ${matchPercentage}%; background-color: ${getMatchColor(matchPercentage)};"></div>
					</div>
				</div>`;
				
				html += '</div>';
				return html;
			}

			// Update the isCompatiblePreference function to properly handle gender preference matching
			function isCompatiblePreference(key, val1, val2, answers1, answers2) {
				// If values are exactly the same, they're compatible
				if (val1 === val2) return true;
				
				// Special compatibility rules based on preference key
				switch(key) {
					// Gender preference (0b)
					case '0b':
						// "all-genders" is compatible with any gender preference
						if (val1 === 'all-genders' || val2 === 'all-genders') return true;
						
						// If one prefers men and the other prefers women, not compatible
						if ((val1 === 'men' && val2 === 'women') || 
							(val1 === 'women' && val2 === 'men')) {
							return false;
						}
						
						// For prefer-not-say, consider compatible with all
						if (val1 === 'prefer-not-say' || val2 === 'prefer-not-say') return true;
						break;
						
					// Gender identity (0a) compatibility with other's preference
					case '0a':
						const person1Gender = answers1['0a'] || '';
						const person2Gender = answers2['0a'] || '';
						const person1Preference = answers1['0b'] || '';
						const person2Preference = answers2['0b'] || '';
						
						// Check if person 1's gender matches person 2's preference
						const person1MatchesPerson2Pref = 
							(person1Gender === 'man' && (person2Preference === 'men' || person2Preference === 'all-genders')) ||
							(person1Gender === 'woman' && (person2Preference === 'women' || person2Preference === 'all-genders')) ||
							(person2Preference === 'all-genders' || person2Preference === 'prefer-not-say');
						
						// Check if person 2's gender matches person 1's preference
						const person2MatchesPerson1Pref = 
							(person2Gender === 'man' && (person1Preference === 'men' || person1Preference === 'all-genders')) ||
							(person2Gender === 'woman' && (person1Preference === 'women' || person1Preference === 'all-genders')) ||
							(person1Preference === 'all-genders' || person1Preference === 'prefer-not-say');
						
						// Both need to match each other's preferences for compatibility
						return person1MatchesPerson2Pref && person2MatchesPerson1Pref;
						
					// Location preferences
					case '4':
						// "anywhere" is compatible with any location preference
						if (val1 === 'anywhere' || val2 === 'anywhere') return true;
						
						// "long-distance" is compatible with "anywhere" and "driving"
						if ((val1 === 'long-distance' && (val2 === 'driving' || val2 === 'anywhere')) ||
							(val2 === 'long-distance' && (val1 === 'driving' || val1 === 'anywhere'))) {
							return true;
						}
						break;
						
					// Exclusivity preferences
					case '5':
						// "open" is compatible with "casual"
						if ((val1 === 'open' && val2 === 'casual') || 
							(val2 === 'open' && val1 === 'casual')) {
							return true;
						}
						
						// "exclusive-casual" is compatible with "committed"
						if ((val1 === 'exclusive-casual' && val2 === 'committed') || 
							(val2 === 'exclusive-casual' && val1 === 'committed')) {
							return true;
						}
						break;
						
					// Relationship pace
					case '6':
						// "varies" is compatible with any pace preference
						if (val1 === 'varies' || val2 === 'varies') return true;
						
						// Moderate is compatible with both slow and fast
						if ((val1 === 'moderate' && (val2 === 'slow' || val2 === 'fast')) || 
							(val2 === 'moderate' && (val1 === 'slow' || val1 === 'fast'))) {
							return true;
						}
						break;
						
					// Physical intimacy
					case '7':
						// "somewhat" is compatible with both "not-important" and "important"
						if ((val1 === 'somewhat' && (val2 === 'not-important' || val2 === 'important')) || 
							(val2 === 'somewhat' && (val1 === 'not-important' || val1 === 'important'))) {
							return true;
						}
						break;
						
					// Life integration
					case '8':
						// "casual-integration" is compatible with both "separate" and "significant"
						if ((val1 === 'casual-integration' && (val2 === 'separate' || val2 === 'significant')) || 
							(val2 === 'casual-integration' && (val1 === 'separate' || val1 === 'significant'))) {
							return true;
						}
						break;
				}
				
				// If no special rule matched and not exactly equal, they're not compatible
				return false;
			}

			function humanReadableValue(key, value) {
				// Map values to more readable formats
				const valueMap = {
					'woman': 'Woman',
					'man': 'Man',
					'non-binary': 'Non-binary',
					'other': 'Other/Not specified',
					'women': 'Women',
					'men': 'Men',
					'all-genders': 'All genders',
					'prefer-not-say': 'Not specified',
					'friendship': 'Friendship',
					'casual': 'Casual connection',
					'romantic': 'Emotional intimacy',
					'physical': 'Physical chemistry',
					'virtual': 'Virtual interaction',
					'casual-meetups': 'Casual hangouts',
					'planned-dates': 'Planned dates',
					'travel': 'Travel together',
					'none': 'Minimal/None',
					'light': 'Light flirting',
					'moderate': 'Moderate flirting',
					'intense': 'Intense/Passionate',
					'local': 'Local only',
					'driving': 'Driving distance',
					'long-distance': 'Long-distance OK',
					'anywhere': 'Anywhere',
					'open': 'Open/Non-exclusive',
					'exclusive-casual': 'Exclusive but casual',
					'committed': 'Committed',
					'monogamous': 'Monogamous',
					'polyamorous': 'Polyamorous',
					'relationship-anarchy': 'Relationship anarchy',
					'slow': 'Slow pace',
					'moderate': 'Moderate pace',
					'fast': 'Fast pace',
					'varies': 'Varies by connection',
					'not-important': 'Not important',
					'somewhat': 'Somewhat important',
					'important': 'Very important',
					'essential': 'Essential',
					'separate': 'Separate from life',
					'casual-integration': 'Casual integration',
					'significant': 'Significant integration',
					'complete': 'Complete integration'
				};
				
				return valueMap[value] || value;
			}

			function getMatchColor(percentage) {
				// Return color based on match percentage
				if (percentage >= 80) return 'var(--primary)'; // High match
				if (percentage >= 60) return '#6b5b95'; // Good match
				if (percentage >= 40) return '#878f99'; // Moderate match
				return '#FF5252'; // Low match
			}

			async function generateAICompatibilityInsight(answers1, answers2) {
				const compatibilityAiContent = document.getElementById('compatibilityAiContent');
				
				try {
					// Create a simplified prompt that asks for brevity and focus on differences
					const url = 'https://text.pollinations.ai/openai';
					const requestBody = {
						model: "openai",
						messages: [
							{
								role: "system",
								content: "You are a compatibility analyst for relationship preferences. Be extremely concise and direct. Focus ONLY on meaningful differences or particularly strong matches. Keep your entire analysis under 150 words. Use casual, conversational language and avoid repetitive structure. Do not list every preference match - only highlight what's most important."
							},
							{
								role: "user",
								content: `Give a brief, focused compatibility analysis between these two people.
								
								Person 1:
								- Gender: ${answers1['0a'] || 'not specified'}
								- Seeks: ${answers1['0b'] || 'not specified'}
								- Connection priority: ${answers1['1'] || 'not specified'}
								- Preferred interaction: ${answers1['2'] || 'not specified'}
								- Flirting level: ${answers1['3'] || 'not specified'}
								- Location preference: ${answers1['4'] || 'not specified'}
								- Commitment level: ${answers1['5'] || 'not specified'}
								- Relationship pace: ${answers1['6'] || 'not specified'}
								- Physical intimacy: ${answers1['7'] || 'not specified'}
								- Life integration: ${answers1['8'] || 'not specified'}
								
								Person 2:
								- Gender: ${answers2['0a'] || 'not specified'}
								- Seeks: ${answers2['0b'] || 'not specified'}
								- Connection priority: ${answers2['1'] || 'not specified'}
								- Preferred interaction: ${answers2['2'] || 'not specified'}
								- Flirting level: ${answers2['3'] || 'not specified'}
								- Location preference: ${answers2['4'] || 'not specified'}
								- Commitment level: ${answers2['5'] || 'not specified'}
								- Relationship pace: ${answers2['6'] || 'not specified'}
								- Physical intimacy: ${answers2['7'] || 'not specified'}
								- Life integration: ${answers2['8'] || 'not specified'}
								
								KEEP IT SHORT. Don't list every match - that's obvious from the compatibility table already shown. Just give a quick take on: 1) Overall match quality, 2) The 1-2 most important compatibilities, 3) The 1-2 most significant potential issues (if any), and 4) Brief conclusion on whether they'd work well together. MAXIMUM 150 WORDS TOTAL. Use casual language.`
							}
						],
						max_tokens: 250  // Enforce brevity
					};
					
					console.log("Sending compatibility analysis request");
					
					const response = await fetch(url, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestBody)
					});
					
					if (!response.ok) {
						throw new Error(`API request failed with status ${response.status}`);
					}
					
					const responseData = await response.json();
					
					if (!responseData.choices || !responseData.choices[0] || !responseData.choices[0].message) {
						throw new Error("Unexpected API response format");
					}
					
					const insight = responseData.choices[0].message.content;
					
					// Display the insight
					compatibilityAiContent.innerHTML = insight.trim();
					
					// Generate a compatibility image
					const person1 = { gender: answers1['0a'] || 'person' };
					const person2 = { gender: answers2['0a'] || 'person' };
					generateCompatibilityImage(person1, person2);
					
				} catch (error) {
					console.error('Error generating AI compatibility insight:', error);
					compatibilityAiContent.innerHTML = "We couldn't generate a compatibility analysis at this time. Please try again later.";
				}
			}

			async function generateCompatibilityImage(person1, person2) {
				const compatibilityImageContainer = document.getElementById('compatibilityImageContainer');
				const compatibilityImage = document.getElementById('compatibilityImage');
				
				try {
					// Determine genders explicitly with fallbacks
					const gender1 = person1.gender === 'man' ? 'man' : person1.gender === 'woman' ? 'woman' : 'person';
					const gender2 = person2.gender === 'man' ? 'man' : person2.gender === 'woman' ? 'woman' : 'person';
					
					// Create a direct prompt without using AI
					const imagePrompt = `photo of a ${gender1} and a ${gender2} together, romantic setting, purple lighting, high quality professional photograph`;
					
					// Properly encode the prompt
					const encodedPrompt = encodeURIComponent(imagePrompt);
					const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=800&height=400&nologo=true&model=flux`;
					
					console.log("Compatibility image URL:", imageUrl);
					
					// Set image source
					compatibilityImage.src = imageUrl;
					compatibilityImage.onload = function() {
						compatibilityImageContainer.style.display = 'none';
						compatibilityImage.style.display = 'block';
					};
					compatibilityImage.onerror = function() {
						console.error("Compatibility image failed to load");
						compatibilityImageContainer.style.display = 'none';
						const errorMsg = document.createElement('p');
						errorMsg.textContent = "Couldn't generate compatibility image.";
						errorMsg.style.color = "#ff6b6b";
						compatibilityImageContainer.parentNode.insertBefore(errorMsg, compatibilityImageContainer.nextSibling);
					};
				} catch (error) {
					console.error('Error generating compatibility image:', error);
					compatibilityImageContainer.style.display = 'none';
				}
			}
            
			// Next button handler
			nextBtn.addEventListener('click', function() {
				// If option not selected, prevent going next
				if (!answers[currentQuestion]) {
					return;
				}
				
				// Hide current question
				document.getElementById('question' + currentQuestion).classList.remove('active');
				
				// Find current index in question order
				const currentIndex = questionOrder.indexOf(currentQuestion);
				
				// If last question, show results
				if (currentIndex === questionOrder.length - 1) {
					showResults();
					return;
				}
				
				// Show next question
				currentQuestion = questionOrder[currentIndex + 1];
				document.getElementById('question' + currentQuestion).classList.add('active');
				
				// Update buttons and progress
				updateButtonsState();
				updateProgressBar();
				
				// Disable next button until selection
				if (!answers[currentQuestion]) {
					nextBtn.disabled = true;
				}
			});

			// Previous button handler
			prevBtn.addEventListener('click', function() {
				// Hide current question
				document.getElementById('question' + currentQuestion).classList.remove('active');
				
				// Find current index in question order
				const currentIndex = questionOrder.indexOf(currentQuestion);
				
				// Show previous question
				currentQuestion = questionOrder[currentIndex - 1];
				document.getElementById('question' + currentQuestion).classList.add('active');
				
				// Update buttons and progress
				updateButtonsState();
				updateProgressBar();
				
				// Enable next button
				nextBtn.disabled = false;
			});

			function updateButtonsState() {
				const currentIndex = questionOrder.indexOf(currentQuestion);
				prevBtn.style.visibility = currentIndex === 0 ? 'hidden' : 'visible';
				nextBtn.textContent = currentIndex === questionOrder.length - 1 ? 'See Results' : 'Next';
			}

			function updateProgressBar() {
				const currentIndex = questionOrder.indexOf(currentQuestion);
				const percentage = (currentIndex / (questionOrder.length - 1)) * 100;
				progress.style.width = percentage + '%';
			}
            
			// Restart button handler
			restartBtn.addEventListener('click', function() {
				// Ask if user wants to clear URL and start completely fresh
				const clearUrl = confirm("Would you like to clear the URL? Click OK to completely reset (recommended), or Cancel to keep the current URL in the address bar for reference.");
				
				if (clearUrl) {
					// Option 1: Clear URL completely and reload page
					window.location.href = 'finder.html';
				} else {
					// Option 2: Keep URL in address bar but reset the quiz interface
					// Reset quiz state
					currentQuestion = 0; // Change from currentQuestionIndex to currentQuestion
					Object.keys(answers).forEach(key => delete answers[key]);
					
					// Clear selected options
					document.querySelectorAll('.option').forEach(option => {
						option.classList.remove('selected');
					});
					
					// Show first question
					results.style.display = 'none';
					intro.style.display = 'block';
					quiz.style.display = 'none';
					
					document.querySelectorAll('.question-container').forEach(container => {
						container.classList.remove('active');
					});
					document.getElementById('question0a').classList.add('active'); // Use question0a not questionOrder[0]
					
					// Reset buttons and progress
					updateButtonsState();
					updateProgressBar();
					
					// Hide AI insights and share container
					aiInsightContainer.style.display = 'none';
					shareContainer.style.display = 'none';
				}
			});
			
            // Copy share URL button handler
            copyBtn.addEventListener('click', function() {
                shareUrl.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy Link';
                }, 2000);
            });
            
            function showResults() {
                quiz.style.display = 'none';
                results.style.display = 'block';
                
                // Analyze the answers and display results
                analyzeResults();
                
                // Generate AI insights
                generateAIInsight();
                
                // Generate shareable content
                generateShareableContent();
            }
            
			function analyzeResults() {
				// Gender and Orientation
				const genderIdentity = answers['0a'] || '';
				const genderPreference = answers['0b'] || '';
			
                // Connection Type
                const connectionEl = document.getElementById('connectionType');
                switch(answers[1]) {
                    case 'friendship':
                        connectionEl.innerHTML = 'You value <strong>genuine friendship and connection</strong> above all. You are looking for someone you can trust and share meaningful experiences with, where the foundation is a strong friendship.';
                        break;
                    case 'casual':
                        connectionEl.innerHTML = 'You are seeking <strong>fun, light-hearted interactions</strong> without too much pressure or intensity. You enjoy connecting with people who bring positive energy and enjoyment to your life.';
                        break;
                    case 'romantic':
                        connectionEl.innerHTML = 'You prioritize <strong>deep emotional intimacy</strong> in your connections. You are looking for someone you can truly open up to and share your inner world with.';
                        break;
                    case 'physical':
                        connectionEl.innerHTML = 'You place high importance on <strong>physical chemistry and attraction</strong>. While other aspects matter, you recognize that this spark is essential for your satisfaction in a relationship.';
                        break;
                }
                
                // Interaction Style
                const interactionEl = document.getElementById('interactionStyle');
                let interactionText = '';
                
                // Combine questions 2 (how to spend time) and 3 (flirting level)
                if (answers[2] === 'virtual') {
                    interactionText += 'You prefer primarily <strong>virtual interactions</strong> through texts, calls, and video chats. ';
                } else if (answers[2] === 'casual-meetups') {
                    interactionText += 'You enjoy <strong>casual hangouts</strong> without too much pressure or planning. ';
                } else if (answers[2] === 'planned-dates') {
                    interactionText += 'You value <strong>intentional, planned dates</strong> that show thought and care. ';
                } else if (answers[2] === 'travel') {
                    interactionText += 'You are drawn to <strong>traveling and experiencing new places</strong> with someone special. ';
                }
                
                if (answers[3] === 'none') {
                    interactionText += 'When it comes to romantic gestures, you <strong>prefer to keep things platonic</strong> with minimal to no flirting.';
                } else if (answers[3] === 'light') {
                    interactionText += 'Your flirting style tends to be <strong>light and playful</strong> without serious intentions.';
                } else if (answers[3] === 'moderate') {
                    interactionText += 'You enjoy <strong>moderate flirting</strong> with some romantic gestures that show interest and affection.';
                } else if (answers[3] === 'intense') {
                    interactionText += 'You thrive on <strong>intense romantic and passionate interactions</strong> with someone you are interested in.';
                }
                
                interactionEl.innerHTML = interactionText;
                
                // Location Preference
                const locationEl = document.getElementById('locationPreference');
                let locationText = '';
                
                // Combine questions 4 (proximity) and 6 (pace)
                if (answers[4] === 'local') {
                    locationText += 'You strongly prefer <strong>local connections</strong> with regular in-person interaction. ';
                } else if (answers[4] === 'driving') {
                    locationText += 'You are comfortable with someone <strong>within driving distance</strong>, allowing for regular but not daily meetings. ';
                } else if (answers[4] === 'long-distance') {
                    locationText += 'You are <strong>open to long-distance relationships</strong> with occasional visits. ';
                } else if (answers[4] === 'anywhere') {
                    locationText += '<strong>Location is not a significant factor</strong> for you when connecting with someone. ';
                }
                
                if (answers[6] === 'slow') {
                    locationText += 'You prefer relationships to develop <strong>slowly and gradually</strong>, giving you time to build trust.';
                } else if (answers[6] === 'moderate') {
                    locationText += 'You like relationships to progress at a <strong>moderate, natural pace</strong> without feeling rushed or stalled.';
                } else if (answers[6] === 'fast') {
                    locationText += 'When there is chemistry, you are comfortable with things moving <strong>relatively quickly</strong>.';
                } else if (answers[6] === 'varies') {
                    locationText += 'Your preferred pace <strong>varies depending on the connection</strong> and specific circumstances.';
                }
                
                locationEl.innerHTML = locationText;
                
                // Commitment Level
                const commitmentEl = document.getElementById('commitmentLevel');
                let commitmentText = '';
                
                // Combine questions 5 (exclusivity) and 8 (integration)
                if (answers[5] === 'open') {
                    commitmentText += 'You prefer <strong>complete openness</strong> and the freedom to see other people. ';
                } else if (answers[5] === 'casual') {
                    commitmentText += 'You are looking for something <strong>casual but respectful</strong>, without the need for labels. ';
                } else if (answers[5] === 'exclusive-casual') {
                    commitmentText += 'You value <strong>exclusivity</strong> while still keeping the relationship relatively light. ';
                } else if (answers[5] === 'committed') {
                    commitmentText += 'You are seeking a <strong>dedicated, committed relationship</strong> with clear boundaries. ';
                }
                
                if (answers[8] === 'separate') {
                    commitmentText += 'You prefer to <strong>keep your relationship separate</strong> from other aspects of your life.';
                } else if (answers[8] === 'casual-integration') {
                    commitmentText += 'You are comfortable with <strong>some casual integration</strong> of your relationship into your regular life.';
                } else if (answers[8] === 'significant') {
                    commitmentText += 'You want <strong>significant integration</strong> of your partner into your social circle and daily life.';
                } else if (answers[8] === 'complete') {
                    commitmentText += 'You desire <strong>complete integration</strong> of your relationship into all aspects of your life.';
                }
                
                commitmentEl.innerHTML = commitmentText;
                
                // Generate Overall Summary
                const summaryEl = document.getElementById('summary');
                let relationshipType = determineRelationshipType();
                let physicalityLevel = determinePhysicalityLevel();
                
                summaryEl.innerHTML = "Based on your responses, you seem most aligned with a <strong>" + relationshipType + "</strong> where " + physicalityLevel + ". When meeting someone new, being clear about these preferences can help you find a more compatible connection and avoid mismatched expectations.";
            }
            
			function determineRelationshipType() {
				// This is a simplified analysis based on key questions
				const connection = answers[1];
				const exclusivity = answers[5];
				const physicality = answers[7];
				const relationshipStructure = answers['5a'];
				
				// Include relationship structure in the analysis if provided
				if (relationshipStructure === 'polyamorous') {
					return "polyamorous relationship dynamic";
				} else if (relationshipStructure === 'open') {
					return "open relationship with a primary connection";
				} else if (relationshipStructure === 'relationship-anarchy') {
					return "relationship anarchy approach";
				}
				
				// Original logic
				if (connection === 'friendship' && physicality === 'not-important') {
					return "platonic friendship";
				} else if (connection === 'friendship' && physicality === 'essential') {
					return "friends-with-benefits arrangement";
				} else if (connection === 'casual' && exclusivity === 'open') {
					return "casual, no-strings-attached connection";
				} else if (connection === 'physical' && (exclusivity === 'open' || exclusivity === 'casual')) {
					return "physical-focused casual relationship";
				} else if (connection === 'romantic' && exclusivity === 'committed') {
					return "committed, emotionally intimate relationship";
				} else if (exclusivity === 'committed' || exclusivity === 'exclusive-casual') {
					return "exclusive relationship";
				} else {
					return "balanced relationship with elements of friendship and romance";
				}
			}
            
            function determinePhysicalityLevel() {
                const physicality = answers[7];
                
                if (physicality === 'not-important') {
                    return "physical intimacy is not a priority";
                } else if (physicality === 'somewhat') {
                    return "physical aspects are present but not central to the connection";
                } else if (physicality === 'important') {
                    return "physical and emotional compatibility are equally important";
                } else if (physicality === 'essential') {
                    return "physical chemistry plays a central role";
                } else {
                    return "the balance of emotional and physical connection is flexible";
                }
            }
            
			// Generate shareable URL with parameters
			function generateShareableLink() {
				const params = new URLSearchParams();
				Object.entries(answers).forEach(([question, answer]) => {
					// Ensure question has proper format
					params.set(`q${question}`, answer);
					console.log(`Adding to shareable link: q${question}=${answer}`);
				});
				
				const shareableUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
				console.log("Generated shareable URL:", shareableUrl);
				return shareableUrl;
			}

			// Modify the generateAIInsight function to better handle the answers object
			async function generateAIInsight() {
				aiInsightContainer.style.display = 'block';
				aiLoading.style.display = 'flex';
				aiInsight.style.display = 'none';
				
				// Debug output to see what's in the answers object
				console.log("Answers at start of generateAIInsight:", JSON.stringify(answers));
				
				// Make a copy of the answers to prevent any reference issues
				const currentAnswers = {...answers};
				
				// Check that answers exists and has at least some essential properties
				if (Object.keys(currentAnswers).length === 0) {
					console.error("Error: answers object is empty in generateAIInsight");
					aiInsightContent.innerHTML = "To provide an accurate relationship preferences analysis, please share the quiz answers or complete the quiz. If you refreshed the page, you may need to retake the quiz.";
					aiLoading.style.display = 'none';
					aiInsight.style.display = 'block';
					return;
				}
				
				// Use try-catch to handle potential errors
				try {
					// Extract user preferences with fallbacks for missing data
					const genderIdentity = currentAnswers['0a'] || 'not specified';
					const genderPreference = currentAnswers['0b'] || 'not specified';
					const connectionPref = currentAnswers[1] || 'not specified';
					const interactionPref = currentAnswers[2] || 'not specified';
					const flirtingPref = currentAnswers[3] || 'not specified';
					const locationPref = currentAnswers[4] || 'not specified';
					const exclusivityPref = currentAnswers[5] || 'not specified';
					const pacePref = currentAnswers[6] || 'not specified';
					const physicalPref = currentAnswers[7] || 'not specified';
					const integrationPref = currentAnswers[8] || 'not specified';
					
					// Determine relationship type and physicality level
					const relationshipType = determineRelationshipType();
					const physicality = determinePhysicalityLevel();
					
					// Create prompt for the AI
					const prompt = `Based on these relationship preferences:
					- Gender identity: ${genderIdentity}
					- Gender preference: ${genderPreference}
					- Connection priority: ${connectionPref}
					- Interaction preference: ${interactionPref}
					- Flirting style: ${flirtingPref}
					- Location preference: ${locationPref}
					- Exclusivity preference: ${exclusivityPref}
					- Relationship pace: ${pacePref}
					- Physical intimacy importance: ${physicalPref}
					- Life integration: ${integrationPref}
					- Overall relationship type: ${relationshipType}
					- Physical intimacy level: ${physicality}

					Provide a direct analysis of these relationship preferences. Include: 1) A brief summary of the overall preference pattern, 2) Two strengths of this approach to relationships, 3) Two potential challenges this person might face, and 4) One specific tip for finding compatible partners. Do not ask questions or use conversational phrases.`;
					
					const system = "You are a relationship preferences analyst. Provide a clear, direct analysis of the relationship preferences based on the quiz answers. Focus on analyzing the preference pattern itself rather than referring to 'this person' or using 'you'. Simply describe: 1) The relationship pattern shown by these preferences, 2) Strengths of this approach, 3) Potential challenges that could arise, and 4) Compatibility factors worth considering. Keep your analysis objective, informative, and focused solely on the pattern of preferences shown in the data.";
					
					// Using the POST endpoint with proper JSON structure
					const url = 'https://text.pollinations.ai/openai';
					const requestBody = {
						model: "openai",
						messages: [
							{
								role: "system",
								content: system
							},
							{
								role: "user",
								content: prompt
							}
						]
					};
					
					console.log("Sending request to Pollinations API");
					
					const response = await fetch(url, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestBody)
					});
					
					if (!response.ok) {
						throw new Error(`API request failed with status ${response.status}`);
					}
					
					const responseData = await response.json();
					
					// Check if we have the expected response format
					if (!responseData.choices || !responseData.choices[0] || !responseData.choices[0].message || !responseData.choices[0].message.content) {
						throw new Error("Unexpected API response format");
					}
					
					const insight = responseData.choices[0].message.content;
					
					console.log("Received insight from API:", insight.substring(0, 100) + "...");
					
					// Display the insight
					aiInsightContent.innerHTML = insight.trim();
					aiLoading.style.display = 'none';
					aiInsight.style.display = 'block';
				} catch (error) {
					console.error('Error generating AI insight:', error);
					aiInsightContent.innerHTML = "Sorry, we couldn't generate personalized insights at this time. Your relationship preferences are still valid and valuable for your self-understanding.";
					aiLoading.style.display = 'none';
					aiInsight.style.display = 'block';
				}
			}
            
			// Generate dynamic image prompt using the text.pollinations.ai API first
			async function generateImagePrompt() {
				// Make a copy of the answers to prevent any reference issues
				const currentAnswers = {...answers};
				
				// Check if answers is empty
				if (Object.keys(currentAnswers).length === 0) {
					console.error("Error: answers object is empty in generateImagePrompt");
					return `A couple representing relationship dynamics, atmospheric lighting, purple tones, professional photography`;
				}
				
				// Get gender information directly
				const genderIdentity = currentAnswers['0a'] || 'not specified';
				const genderPreference = currentAnswers['0b'] || 'not specified';
				
				// Create explicit gender descriptors for the image
				let personDesc = "person";
				if (genderIdentity === 'man') personDesc = "man";
				else if (genderIdentity === 'woman') personDesc = "woman";
				
				let partnerDesc = "person";
				if (genderPreference === 'men') partnerDesc = "man";
				else if (genderPreference === 'women') partnerDesc = "woman";
				
				// Create a basic prompt without using the AI to generate it
				const imagePrompt = `Photo of a ${personDesc} and a ${partnerDesc} together, romantic setting, purple lighting, high quality professional photograph`;
				
				console.log("Generated direct image prompt:", imagePrompt);
				return imagePrompt;
			}


			// Update generateShareableContent to handle potential error cases better
			async function generateShareableContent() {
				shareContainer.style.display = 'block';
				
				// Generate and display shareable URL
				const shareLink = generateShareableLink();
				shareUrl.value = shareLink;
				
				// Show loading for image generation
				imageLoading.style.display = 'flex';
				shareImage.style.display = 'none';
				downloadBtn.style.display = 'none';
				
				try {
					// Check if answers is empty
					if (Object.keys(answers).length === 0) {
						console.error("Error: answers object is empty in generateShareableContent");
						throw new Error("Missing answer data");
					}
					
					// Get image prompt directly without AI intermediary
					const imagePrompt = await generateImagePrompt();
					console.log("Using image prompt:", imagePrompt);
					
					// Use that prompt with the image API with proper URL encoding
					const encodedPrompt = encodeURIComponent(imagePrompt);
					const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=800&height=600&nologo=true&model=flux`;
					
					console.log("Final image URL:", imageUrl);
					
					// Set image source
					shareImage.src = imageUrl;
					shareImage.onload = function() {
						imageLoading.style.display = 'none';
						shareImage.style.display = 'block';
						downloadBtn.href = imageUrl;
						downloadBtn.style.display = 'block';
					};
					shareImage.onerror = function() {
						console.error("Image failed to load:", imageUrl);
						handleImageError();
					};
				} catch (error) {
					console.error('Error in image generation process:', error);
					handleImageError();
				}
			}

			function handleImageError() {
				imageLoading.style.display = 'none';
				const errorMsg = document.createElement('p');
				errorMsg.textContent = "Couldn't generate image. You can still share your results using the link above.";
				errorMsg.style.color = "#ff6b6b";
				imageLoading.parentNode.insertBefore(errorMsg, imageLoading.nextSibling);
			}
        });
    </script>
</body>
</html>