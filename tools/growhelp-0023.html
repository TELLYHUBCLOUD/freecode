<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Wrld - Grow Assistant</title>
    <style>
        :root {
            --primary-color: #0a1f0a;
            --secondary-color: #1a331a;
            --accent-color: #4CAF50;
            --text-color: #ffffff;
            --text-secondary: #b0ffb0;
            --border-radius: 12px;
        }

		a:visited {
			color: var(--text-secondary); /* Light green from your variables */
		}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary-color);
            color: var(--text-color);
			min-height: 100vh;
			height: auto;
			overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        header {
			display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: var(--secondary-color);
            border-bottom: 2px solid var(--accent-color);
        }

		.logo-container {
            color: var(--text-secondary);
			text-decoration: none; 
			display: inline-flex;
			align-items: center; /* Aligns logo and text in one row */
			gap: 0.5rem; /* Adjust spacing between logo and text */
		}

		.logo-container a {
			display: flex; /* Ensures logo stays aligned properly */
		}

		.logo {
			height: 200px;
			width: 200px;
			border-radius: var(--border-radius);
			display: block;
		}

		.logo:hover {
			transform: scale(1.05);
		}

        .site-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .site-link:hover {
            color: var(--accent-color);
        }

        .home-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .home-link:hover {
            color: var(--accent-color);
        }

		.conversation-container {
			flex: 1;
			overflow-y: auto;
			padding: 1rem;
			display: flex;
			flex-direction: column;
			gap: 1rem;
			min-height: 0;
			max-width: 800px; /* Set a maximum width */
			margin: 0 auto; /* Center the container */
			width: 100%; /* Use full width up to max-width */
		}

		.input-container {
			padding: 1rem;
			background: var(--secondary-color);
			display: flex;
			gap: 0.5rem;
			border-top: 1px solid var(--accent-color);
			max-width: 800px; /* Match the conversation container */
			margin: 0 auto; /* Center the input container */
			width: 100%; /* Use full width up to max-width */
		}

        /* Main Conversation Area */
		.conversation-container {
			flex: 1;
			overflow-y: auto; /* Ensure the main area can scroll */
			padding: 1rem;
			display: flex;
			flex-direction: column;
			gap: 1rem;
			min-height: 0; /* Important for flexbox scrolling */
		}

        /* Initial State Styles */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2rem;
            padding: 1rem;
            text-align: center;
        }

        .grow-icon {
            width: 150px;
            height: 150px;
        }

        .greeting {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .assistant-intro {
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

		.quick-start-buttons {
			display: flex;
			justify-content: center;
			gap: 1rem;
			flex-wrap: nowrap; /* Prevent wrapping */
			max-width: 800px; /* Ensure they don‚Äôt stretch too far */
		}

        .quick-start-button {
            background: var(--secondary-color);
            color: var(--text-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            border: 1px solid var(--accent-color);
            transition: all 0.2s;
        }

        .quick-start-button:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        /* Message Styles */
        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .message.user {
            background: var(--accent-color);
            align-self: flex-end;
            border-bottom-right-radius: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .message.assistant {
            background: var(--secondary-color);
            align-self: flex-start;
            border-bottom-left-radius: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

		.image-upload-button {
			background: var(--secondary-color);
			border: 1px solid var(--accent-color);
			border-radius: var(--border-radius);
			padding: 0.75rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background-color 0.2s;
		}

		.image-upload-button:hover {
			background: #1f3e1f;
		}

		.image-upload-button svg {
			width: 24px;
			height: 24px;
			color: var(--text-color);
		}

		.message img {
			max-width: 100%;
			border-radius: 8px;
			margin-top: 8px;
		}

		.uploaded-image-preview {
			max-width: 150px;
			max-height: 150px;
			border-radius: 8px;
			margin-top: 8px;
			cursor: pointer;
		}

        /* Question Input Styles */
        .input-container {
            padding: 1rem;
            background: var(--secondary-color);
            display: flex;
            gap: 0.5rem;
            border-top: 1px solid var(--accent-color);
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--accent-color);
            background: var(--primary-color);
            color: var(--text-color);
            font-size: 1rem;
        }

        .send-button {
            padding: 0.75rem;
            background: var(--accent-color);
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            background: #3e8e41;
        }

        .send-button svg {
            width: 24px;
            height: 24px;
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* AI badge */
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(76, 175, 80, 0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .ai-badge svg {
            width: 16px;
            height: 16px;
        }

		.user-input-container {
			display: flex;
			gap: 0.5rem;
			width: 100%;
			max-width: 600px;
			margin-bottom: 1rem;
		}

        @keyframes pulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }
            
            .quick-start-buttons {
                grid-template-columns: 1fr;
            }
        }

		/* Adjust responsive behavior */
		@media (min-width: 1200px) {
			.conversation-container, 
			.input-container {
				max-width: 900px; /* Slightly wider on very large screens */
			}
		}

		@media (max-width: 600px) {
			.conversation-container, 
			.input-container {
				max-width: 100%; /* Full width on mobile */
				padding: 0.75rem;
			}
		}		
		
		
    </style>
</head>
<body>
	<header>
			<a href="https://greenwrldexclusive.com/" class="home-link" target="_blank" rel="noopener noreferrer">
				üè† HOME
			</a>
			<a href="https://greenwrldexclusive.com/shop/" class="site-link" target="_blank" rel="noopener noreferrer">
				üõí SHOP
			</a>
	</header>
	
    <div class="conversation-container" id="conversation-container">
        <div class="initial-state" id="initial-state">
			
			<a href="https://greenwrldexclusive.com" target="_blank" rel="noopener noreferrer">
				<img src="/tools/strains/logos/greenwrld-logo.png" alt="Green Wrld Logo" class="logo">
			</a>       
			
            <div>
                <div class="ai-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
                        <path d="M12 2a10 10 0 0 1 10 10h-10V2z"></path>
                        <path d="M12 22v-2"></path>
                        <path d="M12 18v-2"></path>
                        <path d="M16 12h-2"></path>
                        <path d="M8 12H6"></path>
                    </svg>
                    AI-Powered Growing Assistant
                </div>
                <h2 class="greeting">Welcome to the Green Wrld Grow Assistant</h2>
                <p class="assistant-intro">I'm your AI growing expert, ready to help with cultivation advice, troubleshooting plant issues, and optimizing your harvests. Ask me anything about growing techniques, nutrients, lighting, pest management, or processing methods.</p>
            </div>

			<div class="user-input-container">
				<input type="text" class="message-input" placeholder="Ask a question..." onkeydown="if(event.key === 'Enter') sendMessageFromInitialState()">
				<button class="send-button" onclick="sendMessage()">Send</button>
			</div>
            
            <div class="quick-start-buttons">
                <button class="quick-start-button" data-prompt="What are some tips for beginners growing indoors?">
                    Indoor Growing Tips
                </button>
                <button class="quick-start-button" data-prompt="How do I identify and fix nutrient deficiencies?">
                    Nutrient Issues
                </button>
                <button class="quick-start-button" data-prompt="What's the best way to manage pH and watering schedule?">
                    pH & Watering
                </button>
                <button class="quick-start-button" data-prompt="How do I know when to harvest for best potency?">
                    Harvesting Tips
                </button>
            </div>
        </div>
    </div>

    <div class="input-container" id="question-input" style="display: none;">
        <input type="text" class="message-input" placeholder="Ask your growing question..." id="message-input">

		<button class="image-upload-button" id="image-upload-button" title="Upload an image">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
				<circle cx="8.5" cy="8.5" r="1.5"></circle>
				<polyline points="21 15 16 10 5 21"></polyline>
			</svg>
		</button>
		<input type="file" id="file-input" accept="image/*" style="display: none;">
		
        <button class="send-button" id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>

    <script>
		let conversationHistory = [];
		let currentImageData = null;
		let imagePreviewElement = null;
		
		// State management
		let state = {
			messages: [],
			controller: null,
			isLoading: false,
			systemPrompt: "You are Green Wrld's expert growing assistant, an AI specifically designed for mobile platforms to help cannabis cultivators with comprehensive advice on growing techniques, troubleshooting plant issues, optimizing harvests, and creating plant-based products. You have deep knowledge about all aspects of cannabis cultivation including nutrients, lighting, soil composition, hydroponics, pest management, strain characteristics, and processing methods. Keeping answers concise but precise balancing to suit mobile users, Always provide practical, actionable advice that's suitable for the grower's experience level. When appropriate, mention that Green Wrld offers quality seeds for growers, but keep this subtle and relevant to the conversation. Sign your responses with 'Green Wrld Grow Guide üå±'."
		};

		// DOM Elements
		const imageUploadButton = document.getElementById('image-upload-button');
		const fileInput = document.getElementById('file-input');
		const conversationContainer = document.getElementById('conversation-container');
		const initialState = document.getElementById('initial-state');
		const questionInput = document.getElementById('question-input');
		const messageInput = document.getElementById('message-input');
		const sendButton = document.getElementById('send-button');

		// Event Listeners
		document.addEventListener('click', (e) => {
			if (e.target.classList.contains('quick-start-button')) {
				const prompt = e.target.dataset.prompt;
				switchToAssistantMode();
				sendQuestion(prompt);
			}
		});

		sendButton.addEventListener('click', () => {
			if (messageInput.value.trim()) {
				sendQuestion(messageInput.value);
			}
		});

		messageInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter' && messageInput.value.trim()) {
				sendQuestion(messageInput.value);
			}
		});

		// Event listener for the input field in the initial state
		document.querySelector('.initial-state .message-input').addEventListener('keydown', function(event) {
			if (event.key === 'Enter') {
				event.preventDefault();
				sendMessageFromInitialState();
			}
		});

		// Event listener for the send button in the initial state
		document.querySelector('.initial-state .send-button').addEventListener('click', sendMessageFromInitialState);

		imageUploadButton.addEventListener('click', () => {
			fileInput.click();
		});

		fileInput.addEventListener('change', handleFileSelect);
		messageInput.addEventListener('paste', handlePaste);

		function handleFileSelect(event) {
			const file = event.target.files[0];
			if (file && file.type.match('image.*')) {
				processImageFile(file);
			}
		}

		// Function to handle pasted content
		function handlePaste(event) {
			const items = (event.clipboardData || event.originalEvent.clipboardData).items;
			
			for (const item of items) {
				if (item.type.indexOf('image') === 0) {
					const blob = item.getAsFile();
					processImageFile(blob);
					event.preventDefault();
					return;
				}
			}
		}

		// Process the image file
		function processImageFile(file) {
			const reader = new FileReader();
			
			reader.onload = function(e) {
				const base64Image = e.target.result.split(',')[1]; // Remove the data URL part
				currentImageData = base64Image;
				
				// Show image preview
				showImagePreview(e.target.result);
			};
			
			reader.readAsDataURL(file);
		}

		// Show image preview next to input
		function showImagePreview(dataUrl) {
			// Remove existing preview if any
			if (imagePreviewElement) {
				imagePreviewElement.remove();
			}
			
			// Create preview element
			imagePreviewElement = document.createElement('img');
			imagePreviewElement.src = dataUrl;
			imagePreviewElement.className = 'uploaded-image-preview';
			imagePreviewElement.onclick = () => {
				currentImageData = null;
				imagePreviewElement.remove();
				imagePreviewElement = null;
			};
			
			// Add tip that clicking removes the image
			imagePreviewElement.title = "Click to remove image";
			
			// Insert before input container
			questionInput.insertBefore(imagePreviewElement, messageInput);
		}

		function sendMessageFromInitialState() {
			let inputField = document.querySelector('.initial-state .message-input');
			let userMessage = inputField.value.trim();
			
			if (userMessage === "") return; // Prevent empty messages

			// Hide initial state & show chat UI
			switchToAssistantMode();
			
			// Clear input field
			inputField.value = "";
			
			// Use the existing sendQuestion function for API communication
			sendQuestion(userMessage);
		}

		// Switch to Assistant Mode
		function switchToAssistantMode() {
			if (initialState) {
				initialState.style.display = 'none';
			}
			questionInput.style.display = 'flex';
			messageInput.focus();
		}

		async function analyzeImage(base64Image) {
			// We need a format that works with the pollinations API for image analysis
			const requestBody = {
				"model": "openai",
				"messages": [
					{
						"role": "user",
						"content": [
							{
								"type": "text",
								"text": "Analyze this cannabis plant image in detail. Describe the overall plant condition, leaf color, size, any visible signs of stress, deficiency, or disease. Note any discoloration, spots, curling, or unusual growth patterns. This will be used for troubleshooting plant health."
							},
							{
								"type": "image_url",
								"image_url": {
									"url": `data:image/jpeg;base64,${base64Image}`
								}
							}
						]
					}
				]
			};

			try {
				const response = await fetch('https://text.pollinations.ai/v1/chat/completions', {
					method: 'POST',
					headers: { 
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(requestBody)
				});

				if (!response.ok) {
					throw new Error('Failed to analyze image');
				}

				const responseData = await response.json();
				const analysisText = responseData.choices?.[0]?.message?.content || '';
				
				console.log("Image analysis result:", analysisText);
				return analysisText;
			} catch (error) {
				console.error('Image analysis error:', error);
				throw error;
			}
		}

		// Add Message to Conversation
		function addMessage(content, role) {
			const message = document.createElement('div');
			message.classList.add('message', role);
			message.textContent = content;
			conversationContainer.appendChild(message);
			conversationContainer.scrollTop = conversationContainer.scrollHeight;
			state.messages.push({ role, content });
		}

		// Add loading indicator
		function addLoadingIndicator() {
			const loadingDiv = document.createElement('div');
			loadingDiv.classList.add('message', 'assistant', 'loading');
			loadingDiv.innerHTML = `
				<div class="typing-indicator">
					<div class="dot"></div>
					<div class="dot"></div>
					<div class="dot"></div>
				</div>
			`;
			conversationContainer.appendChild(loadingDiv);
			conversationContainer.scrollTop = conversationContainer.scrollHeight;
			return loadingDiv;
		}

		// Send Question to API
		async function sendQuestion(content) {
			if ((!content.trim() && !currentImageData) || state.isLoading) return;

			// Cancel any existing request
			if (state.controller) {
				state.controller.abort();
			}
			
			state.isLoading = true;

			// Check if we have an image
			if (currentImageData) {
				// Add user message with image indicator
				const displayContent = content.trim() ? content : "Analyze this plant image";
				addMessage(displayContent + " [Image attached]", 'user');
				messageInput.value = '';
				
				// Show loading indicator for image analysis
				const loadingIndicator = addLoadingIndicator();
				
				try {
					// First analyze the image
					const imageDescription = await analyzeImage(currentImageData);
					
					// Create a proper message that makes the AI believe it has seen the image
					const enhancedPrompt = `
		You examined the image from the user and saw the following:

		${imageDescription}

		Based on this examination of the cannabis plant in the image, please provide an assessment of the plant's health, identify any issues, and suggest appropriate solutions. Include specific advice for addressing any problems observed.
		`;

					// Add this special message to state but don't show it to user
					state.messages.push({ 
						role: 'system', 
						content: enhancedPrompt 
					});
					
					// Remove loading indicator
					loadingIndicator.remove();
					
					// Now process with the regular message flow
					const secondLoadingIndicator = addLoadingIndicator();
					
					try {
						// Create new AbortController for this request
						state.controller = new AbortController();
						
						const response = await fetch('https://text.pollinations.ai/', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								messages: [
									{
										role: 'system',
										content: state.systemPrompt
									},
									...state.messages
								],
								seed: Math.floor(Math.random() * 1000000),
								model: 'openai-large',
								jsonMode: false
							}),
							signal: state.controller.signal
						});
						
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						
						// Remove loading indicator
						secondLoadingIndicator.remove();
						
						const data = await response.text();
						addMessage(data, 'assistant');
					} catch (chatError) {
						secondLoadingIndicator.remove();
						console.error('Error in chat processing:', chatError);
						addMessage('Sorry, I had trouble processing your request. Please try again. Green Wrld Grow Guide üå±', 'assistant');
					}
					
					// Clear the image data and preview
					currentImageData = null;
					if (imagePreviewElement) {
						imagePreviewElement.remove();
						imagePreviewElement = null;
					}
				} catch (error) {
					// Remove loading indicator
					loadingIndicator.remove();
					console.error('Error analyzing image:', error);
					addMessage('Sorry, I had trouble analyzing your image. Please try again or describe the issue in text. Green Wrld Grow Guide üå±', 'assistant');
				} finally {
					state.controller = null;
					state.isLoading = false;
					messageInput.focus();
				}
			} else {
				// Regular text message - your existing code
				addMessage(content, 'user');
				messageInput.value = '';
				
				// Show loading indicator
				const loadingIndicator = addLoadingIndicator();
				
				// Create new AbortController for this request
				state.controller = new AbortController();

				try {
					const response = await fetch('https://text.pollinations.ai/', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							messages: [
								{
									role: 'system',
									content: state.systemPrompt
								},
								...state.messages
							],
							seed: Math.floor(Math.random() * 1000000),
							model: 'openai-large',
							jsonMode: false
						}),
						signal: state.controller.signal
					});

					if (!response.ok) {
						throw new Error('Network response was not ok');
					}

					// Remove loading indicator
					loadingIndicator.remove();

					const data = await response.text();
					addMessage(data, 'assistant');
				} catch (error) {
					// Remove loading indicator
					loadingIndicator.remove();
					
					if (error.name === 'AbortError') {
						console.log('Request was cancelled');
					} else {
						console.error('Error:', error);
						// Your existing fallback code
						try {
							// Fallback to openai model if large fails
							const fallbackResponse = await fetch('https://text.pollinations.ai/', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({
									messages: [
										{
											role: 'system',
											content: state.systemPrompt
										},
										...state.messages
									],
									seed: Math.floor(Math.random() * 1000000),
									model: 'openai',
									jsonMode: false
								})
							});
							
							const fallbackData = await fallbackResponse.text();
							addMessage(fallbackData, 'assistant');
						} catch (fallbackError) {
							addMessage('Sorry, I experienced a connection issue. Please try again in a moment. Green Wrld Grow Guide üå±', 'assistant');
						}
					}
				} finally {
					state.controller = null;
					state.isLoading = false;
					messageInput.focus();
				}
			}
		}

		// Handle window events
		window.addEventListener('beforeunload', () => {
			if (state.controller) {
				state.controller.abort();
			}
		});

		document.addEventListener('visibilitychange', () => {
			if (document.visibilityState === 'hidden' && state.controller) {
				state.controller.abort();
			}
		});
    </script>
</body>
</html>